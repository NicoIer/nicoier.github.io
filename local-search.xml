<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>zstd-for-unity</title>
    <link href="/2025/12/09/zstd-for-unity/"/>
    <url>/2025/12/09/zstd-for-unity/</url>
    
    <content type="html"><![CDATA[<h1 id="zstd-for-unity"><a href="#zstd-for-unity" class="headerlink" title="zstd-for-unity"></a>zstd-for-unity</h1><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">本文主要记录了在Unity中集成zstd的过程。<br></code></pre></td></tr></table></figure><p>集成并制作完毕后的结果提供在此 <a href="https://github.com/NicoIer/zstd-unity.git">https://github.com/NicoIer/zstd-unity.git</a></p><p>zstd是facebook开源的一款高效压缩算法，具有极高的压缩比和压缩速度，广泛应用于各种场景中。它被集成在linux内核中，并且被许多知名项目采用，比如Docker、Kubernetes等。 其在游戏开发中的应用也比较广泛，像熟知的英雄联盟就使用了它</p><h2 id="下载-静态编译zstd源码"><a href="#下载-静态编译zstd源码" class="headerlink" title="下载&amp;静态编译zstd源码"></a>下载&amp;静态编译zstd源码</h2><ul><li><p><a href="https://github.com/facebook/zstd">https://github.com/facebook/zstd</a></p></li><li><pre><code class="language-shell">  git clone https://github.com/facebook/zstd  <figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">- checkout到最新发布版本，目前是<span class="hljs-built_in">v1</span>.<span class="hljs-number">5</span>.<span class="hljs-number">7</span><br>- ```<span class="hljs-keyword">shell</span><br><span class="hljs-keyword"></span>    git checkout <span class="hljs-built_in">v1</span>.<span class="hljs-number">5</span>.<span class="hljs-number">7</span><br></code></pre></td></tr></table></figure></code></pre></li><li><p>切换到build目录</p></li><li><pre><code class="language-shell">  cd zstd/build/cmake  <figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">- 为了在常见的游戏平台上编译出静态库，这里需要安装交叉编译工具链(gcc,ndk,xcode,mingw,cmake等)，使用的电脑操作系统最好是MacOS，NDK的话我这里直接用Unity下载好的<br>  ```<span class="hljs-keyword">shell</span><br><span class="hljs-keyword"></span>    <span class="hljs-keyword">brew </span><span class="hljs-keyword">install </span>cmake<br>    <span class="hljs-keyword">brew </span><span class="hljs-keyword">install </span>mingw-w64<br>    <span class="hljs-keyword">brew </span><span class="hljs-keyword">install </span>gcc<br></code></pre></td></tr></table></figure></code></pre></li><li><p>然后就是为不同的平台调用cmake进行编译了</p></li><li><pre><code class="language-shell">  # armeabi-v7a  export NDK_PATH=/Applications/Unity/Hub/Editor/6000.3.0f1/PlaybackEngines/AndroidPlayer/NDK  cmake -S . -B build_android_armeabi-v7a \  -DCMAKE_TOOLCHAIN_FILE=$NDK_PATH/build/cmake/android.toolchain.cmake \  -DANDROID_ABI=armeabi-v7a \  -DANDROID_PLATFORM=android-21 \  -DBUILD_SHARED_LIBS=ON  cmake --build build_android_armeabi-v7a --config Release  <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs routeros">  <br>```shell<br><span class="hljs-comment"># arm64-v8a</span><br><span class="hljs-built_in">export</span> <span class="hljs-attribute">NDK_PATH</span>=/Applications/Unity/Hub/Editor/6000.3.0f1/PlaybackEngines/AndroidPlayer/NDK<br><br>cmake -S . -B build_android_arm64-v8a \<br><span class="hljs-attribute">-DCMAKE_TOOLCHAIN_FILE</span>=<span class="hljs-variable">$NDK_PATH</span>/build/cmake/android.toolchain.cmake \<br><span class="hljs-attribute">-DANDROID_ABI</span>=arm64-v8a \<br><span class="hljs-attribute">-DANDROID_PLATFORM</span>=android-21 \<br><span class="hljs-attribute">-DBUILD_SHARED_LIBS</span>=ON<br>  <br>cmake --build build_android_arm64-v8a --config Release<br></code></pre></td></tr></table></figure>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">export NDK_PATH=/Applications/Unity/Hub/Editor/6000.3.0f1/PlaybackEngines/AndroidPlayer/NDK<br>cmake -S . -B build_android_x86 \<br>  <br>-DCMAKE_TOOLCHAIN_FILE=$NDK_PATH/build/cmake/android.toolchain.cmake \<br>-DANDROID_ABI=x86 \<br>-DANDROID_PLATFORM=android-21 \<br>-DBUILD_SHARED_LIBS=ON<br>  <br>cmake --build build_android_x86 --config Release<br></code></pre></td></tr></table></figure>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">x86_64</span><br>export NDK_PATH=/Applications/Unity/Hub/Editor/6000.3.0f1/PlaybackEngines/AndroidPlayer/NDK<br>  <br>cmake -S . -B build_android_x86_64 \<br>-DCMAKE_TOOLCHAIN_FILE=$NDK_PATH/build/cmake/android.toolchain.cmake \<br>-DANDROID_ABI=x86_64 \<br>-DANDROID_PLATFORM=android-21 \<br>-DBUILD_SHARED_LIBS=ON<br>  <br>cmake --build build_android_x86_64 --config Release<br></code></pre></td></tr></table></figure>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">配置</span><br>cmake -S . -B build_win64 \<br>-DCMAKE_SYSTEM_NAME=Windows \<br>-DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc \<br>-DCMAKE_RC_COMPILER=x86_64-w64-mingw32-windres \<br>-DBUILD_SHARED_LIBS=ON<br><span class="hljs-meta prompt_"># </span><span class="language-bash">编译</span><br>cmake --build build_win64 --config Release<br></code></pre></td></tr></table></figure>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">cmake -S . -B build_ios \<br>-DCMAKE_SYSTEM_NAME=iOS \<br>-DCMAKE_OSX_ARCHITECTURES=arm64 \<br>-DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \<br>-DBUILD_SHARED_LIBS=ON<br>cmake --build build_ios --config Release<br><br></code></pre></td></tr></table></figure>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">cmake -S . -B build_ios_universal \<br>-DCMAKE_SYSTEM_NAME=iOS \<br>-DCMAKE_OSX_ARCHITECTURES=&quot;arm64;x86_64&quot; \<br>-DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \<br>-DBUILD_SHARED_LIBS=ON<br>cmake --build build_ios_universal --config Release<br></code></pre></td></tr></table></figure>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">cmake -S . -B build_linux_x86_64 \<br>-DCMAKE_BUILD_TYPE=Release \<br>-DBUILD_SHARED_LIBS=ON<br>cmake --build build_linux_x86_64 --config Release<br></code></pre></td></tr></table></figure>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">cmake -S . -B build_macos_universal \<br>-DCMAKE_OSX_ARCHITECTURES=&quot;x86_64;arm64&quot; \<br>-DCMAKE_OSX_DEPLOYMENT_TARGET=10.13 \<br>-DBUILD_SHARED_LIBS=ON<br>cmake --build build_macos_universal --config Release<br></code></pre></td></tr></table></figure></code></pre></li><li><p>完成上面的步骤之后，就可以在对应的build目录下找到编译好的静态库文件了<img src="/../img/libzstd-result.png" alt="libzstd-result.png"></p></li></ul><h2 id="导出静态库到unity"><a href="#导出静态库到unity" class="headerlink" title="导出静态库到unity"></a>导出静态库到unity</h2><ul><li>把不同平台编译好的静态库文件放到Unity项目的Plugins目录，按照平台差异创建文件夹，配置导入选项</li></ul><h2 id="为zstd-h生成C-绑定代码"><a href="#为zstd-h生成C-绑定代码" class="headerlink" title="为zstd.h生成C#绑定代码"></a>为zstd.h生成C#绑定代码</h2><ul><li>zstd.h中定义了zstd提供的所有方法，我们可以直接在C#里面一一声明这些方法，然后通过DllImport调用对应平台的静态库文件中的方法</li><li>手动编译比较浪费时间，而且容易出错，这里使用ClangSharpPInvokeGenerator工具自动生成绑定代码</li><li>下载ClangSharp源码<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/dotnet/ClangSharp<br></code></pre></td></tr></table></figure></li><li>编译ClangSharpPInvokeGenerator工具<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd ClangSharpPInvokeGenerator<br>dotnet build -c Release<br></code></pre></td></tr></table></figure></li><li>然后就可以得到ClangSharpPInvokeGenerator.dll<img src="/../img/%E7%94%9F%E6%88%90%E7%9A%84ClangSharpPInvokeGenerator.png" alt="生成的ClangSharpPInvokeGenerator.png"></li><li>clang是llvm项目下的一个C&#x2F;C++前端编译器工具，我们需要先安装clang（且版本必须是20，否则会和ClangSharpPInvokeGenerator不兼容）)<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">brew install llvm@20<br></code></pre></td></tr></table></figure></li><li>阅读zstd.h，其依赖了zstd_errors.h；stddef.h;limits.h等头文件，我们需要把这些头文件路径都添加到ClangSharpPInvokeGenerator的参数中</li><li>其次不希望生成的代码能够被直接访问到，所以需要添加访问修饰符参数为internal</li><li>运行ClangSharpPInvokeGenerator生成绑定代码<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">export PATH=&quot;/usr/local/opt/llvm@20/bin:$PATH&quot;<br><br>./ClangSharpPInvokeGenerator --file ./zstd.h --namespace zstd --output ./csharp_gen/zstd.cs --include-directory /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include --libraryPath libzstd --with-access-specifier &#x27;*=Internal&#x27;<br><br>./ClangSharpPInvokeGenerator --file ./zstd_errors.h --namespace zstd --output ./csharp_gen/zstd_errors.cs --include-directory /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include --libraryPath libzstd --with-access-specifier &#x27;*=Internal&#x27;<br></code></pre></td></tr></table></figure></li></ul><h2 id="编写C-并提供zstdcli工具中的差分功能"><a href="#编写C-并提供zstdcli工具中的差分功能" class="headerlink" title="编写C#并提供zstdcli工具中的差分功能"></a>编写C#并提供zstdcli工具中的差分功能</h2><p>zstdcli 是zstd源码中自带的一个命令行工具，提供了压缩、解压、差分等功能，我们可以参考zstdcli.c文件的实现，</p><h3 id="zstdcli差分功能原理解析"><a href="#zstdcli差分功能原理解析" class="headerlink" title="zstdcli差分功能原理解析"></a>zstdcli差分功能原理解析</h3><p>首先我们要明确一点：zstdcli的”差分”并不是真正意义上的二进制差分，它和bsdiff、xdelta等差分工具的原理完全不同，<br>zstdcli的差分是基于压缩算法实现的，它的原理是利用zstd的字典压缩功能，将原始文件作为字典，对修改后的文件进行压缩，从而生成一个差分文件。</p><p>现在我们有file_v1.bin和file_v2.bin两个文件</p><ul><li>生成差分的v1_v2.zst的本质是将file_v1.bin作为字典，对file_v2.bin进行字典压缩，生成的文件就是v1_v2.zst。</li><li>应用差分的本质是将file_v1.bin作为字典，对v1_v2.zst进行字典解压，生成的文件就是file_v2.bin。</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>unity</tag>
      
      <tag>compression</tag>
      
      <tag>zstd</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity6的MeshLOD使用教程</title>
    <link href="/2025/12/08/Unity6%E7%9A%84MeshLOD%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"/>
    <url>/2025/12/08/Unity6%E7%9A%84MeshLOD%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<p>Unity6中，当导入模型时，就出现了MeshLOD的选项，我们可以勾选这个选项来启用MeshLOD功能。</p><p>如果一个MeshRenderer 或者 SkinnedMeshRenderer 组件使用的Mesh是勾选了MeshLOD的，那么会出现一个调整LOD等级的滑动条，我们可以通过这个滑动条来调整当前使用的LOD等级。</p><p>还是比较方便，只是生成的算法有点垃圾，期待Unity持续优化这个功能。</p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>Unity6</tag>
      
      <tag>Mesh</tag>
      
      <tag>LOD</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NetworkAnimancer</title>
    <link href="/2025/12/02/NetworkAnimancer/"/>
    <url>/2025/12/02/NetworkAnimancer/</url>
    
    <content type="html"><![CDATA[<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">本文记录了在使用Animancer时开发动画网络同步的一些经验和解决方案。<br></code></pre></td></tr></table></figure><h1 id="Animancer简介"><a href="#Animancer简介" class="headerlink" title="Animancer简介"></a>Animancer简介</h1><p><a href="https://kybernetik.com.au/animancer/">https://kybernetik.com.au/animancer/</a></p><p>Animancer是Unity中的一个强大的动画管理插件，提供了比传统Animator更灵活和高效的动画控制方式。它允许开发者通过代码直接控制动画状态机，简化了动画的管理和切换。</p><h2 id="了解Transition和AnimancerState"><a href="#了解Transition和AnimancerState" class="headerlink" title="了解Transition和AnimancerState"></a>了解Transition和AnimancerState</h2><p>这是一个典型的运行时Animancer</p><p><img src="/../img/runtime_animancer.png" alt="runtime_animancer.png"></p><h3 id="Transition"><a href="#Transition" class="headerlink" title="Transition"></a>Transition</h3><p>Animacner中，动画不是按照AnimationClip为资源单位播放，而是按照Transition为资源单位播放的</p><p>Transition有很多类型，比如ClipTransition，LinearMixTransition，PlayableTransition等等。</p><ul><li>ClipTransition: 最简单的Transition，直接封装了一个AnimationClip，可以设置淡入淡出时间，速度等参数</li><li>LinearMixTransition: 用于混合多个AnimationClip，适合需要平滑过渡的动画场景</li><li>PlayableTransition: 更高级的Transition，可以自定义PlayableGraph，实现复杂的动画逻辑</li><li>….</li></ul><p><img src="/../img/animancer_transition_types.png" alt="animancer_transition_types.png"></p><h2 id="AnimancerState"><a href="#AnimancerState" class="headerlink" title="AnimancerState"></a>AnimancerState</h2><p>AnimancerState是Animancer中表示动画播放状态的类。每个Transition在播放时都会生成一个对应的AnimancerState。不同类型的Transition会生成不同类型的AnimancerState，比如ClipTransition会生成ClipState，<br><img src="/../img/animancer_state_types.png" alt="animancer_state_types.png"></p><h2 id="AnimancerLayer"><a href="#AnimancerLayer" class="headerlink" title="AnimancerLayer"></a>AnimancerLayer</h2><p>AnimancerLayer是Animancer中用于管理动画层的类。</p><p>类似于Unity Animator中的Layer概念</p><p>每个AnimancerLayer可以包含多个AnimancerState，允许在同一层上播放多个动画，并通过权重进行混合。</p><h1 id="Animancer网络同步"><a href="#Animancer网络同步" class="headerlink" title="Animancer网络同步"></a>Animancer网络同步</h1><p>首先明确三个问题</p><ol><li>我们需要序列化什么</li><li>如何序列化</li><li>如何反序列化</li></ol><h2 id="需要序列化什么？"><a href="#需要序列化什么？" class="headerlink" title="需要序列化什么？"></a>需要序列化什么？</h2><h3 id="AnimancerLayer-1"><a href="#AnimancerLayer-1" class="headerlink" title="AnimancerLayer"></a>AnimancerLayer</h3><ul><li>Layer的索引 （用于反序列化时定位Layer）</li><li>包括Layer的权重 （用于反序列化时还原Layer的权重）</li><li>当前播放的所有AnimancerState的信息</li></ul><h3 id="AnimancerState-1"><a href="#AnimancerState-1" class="headerlink" title="AnimancerState"></a>AnimancerState</h3><ul><li>Transition的信息 （用于反序列化时还原AnimancerState）</li><li>当前播放时间 （用于反序列化时还原播放进度）</li><li>权重 （用于反序列化时还原权重）</li><li>播放速度 （用于反序列化时还原播放速度）</li><li>过渡信息 （用于反序列化时还原过渡状态）</li></ul><h2 id="如何序列化？"><a href="#如何序列化？" class="headerlink" title="如何序列化？"></a>如何序列化？</h2><p>一个完整的Animacner网络同步数据结构应该包含多个AnimancerLayer，每个Layer包含多个AnimancerState。</p><h3 id="序列化AnimancerState"><a href="#序列化AnimancerState" class="headerlink" title="序列化AnimancerState"></a>序列化AnimancerState</h3><p>已知，不同的Transition会生成不同类型的AnimancerState，因此在序列化时需要区分不同类型的State。</p><ul><li>首先定义一个枚举类型StateType，用于区分不同类型的AnimancerState</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> StateType<br>&#123;<br>    Clip,<br>    DirectionalMixer,<br>    CartesianMixer,<br>    LinearMixer<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>上面定义了最常用四种类型</p><ul><li>Clip表示普通的ClipState</li><li>DirectionalMixer表示方向混合状态</li><li>CartesianMixer表示笛卡尔混合状态</li><li>LinearMixer表示线性混合状态</li></ul></li><li><p>使用一个ArraySegment<byte>来存储额外的payload数据，用于存储不同类型State特有的数据</p></li><li><p>定义NetworkAnimationStateData结构体来表示序列化后的AnimancerState数据</p></li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">MemoryPackable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> NetworkAnimationStateData<br>&#123;<br>    <span class="hljs-keyword">public</span> StateType stateType;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> stateHash;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> transitionIndex;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> speed;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> time;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> weight;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> remainimgFadeDuration;<br>    <span class="hljs-keyword">public</span> ArraySegment&lt;<span class="hljs-built_in">byte</span>&gt; payload;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>结构体字段说明：<ul><li>stateType: 状态类型</li><li>stateHash: 状态的哈希值，用于唯一标识状态</li><li>transitionIndex : Transition的索引，用于反序列化时还原Transition (仅对ClipState有效)</li><li>speed: 播放速度</li><li>time: 当前播放时间</li><li>weight: 权重</li><li>remainimgFadeDuration: 剩余淡出时间</li><li>payload: 额外的payload数据</li></ul></li></ul><h4 id="准备Transition索引映射"><a href="#准备Transition索引映射" class="headerlink" title="准备Transition索引映射"></a>准备Transition索引映射</h4><p>需要有一个地方存储Transition到索引的映射关系</p><p>这里之所以可以使用AnimationClip和ClipTransition作为索引单元，是因为我们提前将所有的AnimationClip都生成了ClipTransition，并且存放到了Animacner的TransitionLibrary中。</p><p><img src="/../img/animancer_transition_library.png" alt="animancer_transition_library.png"></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Dictionary&lt;AnimationClip, ClipTransition&gt; _clip2TransitionsDict = <span class="hljs-keyword">new</span> ();<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Dictionary&lt;ClipTransition, <span class="hljs-built_in">int</span>&gt; _transition2IndexDict = <span class="hljs-keyword">new</span> ();<br></code></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; animancer.Transitions.Definition.Transitions.Length; i++)<br>&#123;<br>    <span class="hljs-keyword">var</span> assetBase = animancer.Transitions.Definition.Transitions[i];<br>    <span class="hljs-keyword">if</span> (assetBase <span class="hljs-keyword">is</span> TransitionAsset &#123; Transition: ClipTransition clipTransition &#125;)<br>    &#123;<br>        _clip2TransitionsDict[clipTransition.Clip] = clipTransition;<br>        _transition2IndexDict[clipTransition] = animancer.Transitions.Library.IndexOf(clipTransition);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ClipState"><a href="#ClipState" class="headerlink" title="ClipState"></a>ClipState</h4><p>对于ClipState，payload可以为空，因为ClipState不需要额外的数据。</p><p>对应的序列化代码如下：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp">AnimancerState state = layer.ActiveStates[i];<br><span class="hljs-keyword">var</span> stateData = <span class="hljs-keyword">new</span> NetworkAnimationStateData<br>&#123;<br>    stateType = NetworkAnimationStateData.StateType.Clip,<br>    stateHash = state.Index,<br>    time = state.Time,<br>    weight = state.Weight,<br>    speed = state.Speed<br>&#125;;<br><br><span class="hljs-keyword">if</span> (state.FadeGroup != <span class="hljs-literal">null</span> &amp;&amp; Mathf.Approximately(state.TargetWeight, <span class="hljs-number">1</span>))<br>&#123;<br>    stateData.remainimgFadeDuration = state.FadeGroup.RemainingFadeDuration;<br>&#125;<br></code></pre></td></tr></table></figure><p>其中寻找Transition索引的代码如下：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">stateData.transitionIndex = _transition2IndexDict[_clip2TransitionsDict[state.Clip]];<br></code></pre></td></tr></table></figure><p>为了方便，如果存在正在过渡的状态，我们直接将过渡的目标状态放到Layer的State列表中的第一个</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">if</span>(thisStateIsInFade)<br>&#123; <br>    (networkAnimationDatas[<span class="hljs-number">0</span>], networkAnimationDatas[i]) =  (networkAnimationDatas[i], networkAnimationDatas[<span class="hljs-number">0</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DirectionalMixerState"><a href="#DirectionalMixerState" class="headerlink" title="DirectionalMixerState"></a>DirectionalMixerState</h4><p>对于DirectionalMixerState，需要序列化当前方向参数，所有的子状态的Transition索引，以及每个子状态对应的阈值。</p><p>对应的额外payload数据结构如下：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">MemoryPackable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> DirectionalMixerStateData<br>&#123;<br>    <span class="hljs-keyword">public</span> Vector2 parameter;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>[] transitionIndices;<br>    <span class="hljs-keyword">public</span> Vector2[] thresholds;<br>&#125;<br></code></pre></td></tr></table></figure><p>对应的序列化代码如下：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp">stateData.stateType = NetworkAnimationStateData.StateType.DirectionalMixer;<br><span class="hljs-keyword">var</span> payload = <span class="hljs-keyword">new</span> DirectionalMixerStateData();<br>payload.parameter = directionalMixerState.Parameter;<br>payload.transitionIndices = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[directionalMixerState.ChildCount];<br>payload.thresholds = <span class="hljs-keyword">new</span> Vector2[directionalMixerState.ChildCount];<br><br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>; index &lt; directionalMixerState.ChildCount; index++)<br>&#123;<br>    <span class="hljs-keyword">var</span> child = directionalMixerState.GetChild(index);<br>    <span class="hljs-keyword">var</span> transitionIndex = _transition2IndexDict[_clip2TransitionsDict[child.Clip]];<br>    payload.transitionIndices[index] = transitionIndex;<br>    payload.thresholds[index] = directionalMixerState.GetThreshold(index);<br>&#125;<br>stateData.payload = MemoryPackSerializer.Serialize(payload);<br></code></pre></td></tr></table></figure><h4 id="CartesianMixerState"><a href="#CartesianMixerState" class="headerlink" title="CartesianMixerState"></a>CartesianMixerState</h4><p>CartesianMixerState的序列化方式和DirectionalMixerState类似，并没有什么不同</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">MemoryPackable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> CartesianMixerStateData<br>&#123;<br>    <span class="hljs-keyword">public</span> Vector2 parameter;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>[] transitionIndices;<br>    <span class="hljs-keyword">public</span> Vector2[] thresholds;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp">stateData.stateType = NetworkAnimationStateData.StateType.DirectionalMixer;<br><span class="hljs-keyword">var</span> payload = <span class="hljs-keyword">new</span> DirectionalMixerStateData();<br>payload.parameter = directionalMixerState.Parameter;<br>payload.transitionIndices = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[directionalMixerState.ChildCount];<br>payload.thresholds = <span class="hljs-keyword">new</span> Vector2[directionalMixerState.ChildCount];<br><br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>; index &lt; directionalMixerState.ChildCount; index++)<br>&#123;<br>    <span class="hljs-keyword">var</span> child = directionalMixerState.GetChild(index); <br>    <span class="hljs-keyword">var</span> transitionIndex = _transition2IndexDict[_clip2TransitionsDict[child.Clip]];<br>    payload.transitionIndices[index] = transitionIndex;<br>    payload.thresholds[index] = directionalMixerState.GetThreshold(index);<br>&#125;<br><br>stateData.payload = MemoryPackSerializer.Serialize(payload);<br></code></pre></td></tr></table></figure><h4 id="LinearMixerState"><a href="#LinearMixerState" class="headerlink" title="LinearMixerState"></a>LinearMixerState</h4><p>Linear和Directional&#x2F;Cartesian的区别在于，LinearMixerState参数和阈值是float类型</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">MemoryPackable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> LinearMixerStateData<br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> parameter;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>[] transitionIndices;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span>[] thresholds;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp">stateData.stateType = NetworkAnimationStateData.StateType.LinearMixer;<br><span class="hljs-keyword">var</span> payload = <span class="hljs-keyword">new</span> LinearMixerStateData();<br>payload.parameter = linearMixerState.Parameter;<br>payload.transitionIndices = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[linearMixerState.ChildCount];<br>payload.thresholds = <span class="hljs-keyword">new</span> <span class="hljs-built_in">float</span>[linearMixerState.ChildCount]; <br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>; index &lt; linearMixerState.ChildCount; index++)<br>&#123;<br>    <span class="hljs-keyword">var</span> child = linearMixerState.GetChild(index); <br>    <span class="hljs-keyword">var</span> transitionIndex = _transition2IndexDict[_clip2TransitionsDict[child.Clip]]; <br>    payload.transitionIndices[index] = transitionIndex;<br>    payload.thresholds[index] = linearMixerState.GetThreshold(index);<br>&#125;<br><br>stateData.payload = MemoryPackSerializer.Serialize(payload);<br></code></pre></td></tr></table></figure><h3 id="序列化AnimancerLayer"><a href="#序列化AnimancerLayer" class="headerlink" title="序列化AnimancerLayer"></a>序列化AnimancerLayer</h3><p>定义NetworkAnimationLayerData结构体来表示序列化后的AnimancerLayer数据</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">MemoryPackable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> NetworkAnimationLayerData<br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> layerIndex;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> layerWeight;<br>    <span class="hljs-keyword">public</span> ArraySegment&lt;NetworkAnimationStateData&gt; states;<br>&#125;<br></code></pre></td></tr></table></figure><p>Layer的序列化相对简单，只需要记录Layer的索引，权重，以及包含的所有AnimancerState的序列化数据即可。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">var</span> layer = animancer.Layers[layerIndex];<br><span class="hljs-keyword">var</span> layerData = <span class="hljs-keyword">new</span> NetworkAnimationLayerData<br>&#123;<br>    layerIndex = layerIndex,<br>    layerWeight = layer.Weight <br>&#125;;<br><span class="hljs-keyword">var</span> networkAnimationDatas = <span class="hljs-keyword">new</span> NetworkAnimationStateData[layer.ActiveStates.Count];<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; layer.ActiveStates.Count; i++)<br>&#123;<br>    <span class="hljs-keyword">var</span> state = layer.ActiveStates[i];<br>    <span class="hljs-comment">// 序列化state的代码，参考上面的内容</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="如何反序列化？"><a href="#如何反序列化？" class="headerlink" title="如何反序列化？"></a>如何反序列化？</h2><p>反序列化要做的事情主要有两件，创建AnimancerState，以及还原AnimancerState的播放状态。</p><p>在初始化的时候，就已经创建好了所有的Layer，所以不需要同步的创建Layer</p><h3 id="反序列化AnimancerLayer"><a href="#反序列化AnimancerLayer" class="headerlink" title="反序列化AnimancerLayer"></a>反序列化AnimancerLayer</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">var</span> layerData = dataList[layerIndex];<br><span class="hljs-keyword">var</span> layer = animancer.Layers[layerData.layerIndex];<br>layer.Stop();<br><span class="hljs-keyword">if</span> (layerData.layerWeight == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">if</span> (layerData.states.Count == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;<br>layer.Weight = layerData.layerWeight;<br><br>AnimancerState first;<br><br><span class="hljs-comment">// 反序列化每个AnimancerState</span><br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; layerData.states.Count; i++)<br>&#123;<br>    <span class="hljs-comment">// 反序列化state的代码，参考下面的内容</span><br>&#125;<br><br>layer.Play(firstState, layerData.states[<span class="hljs-number">0</span>].remainimgFadeDuration);<br></code></pre></td></tr></table></figure><h3 id="反序列化AnimancerState"><a href="#反序列化AnimancerState" class="headerlink" title="反序列化AnimancerState"></a>反序列化AnimancerState</h3><p>首先需要一个Dict记录所有已经创建的AnimancerState，避免重复创建</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">private</span> Dictionary&lt;<span class="hljs-built_in">int</span>, AnimancerState&gt; id2State = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">int</span>, AnimancerState&gt;();<br></code></pre></td></tr></table></figure><p>同样的，需要对不同的AnimancerState类型进行区分处理</p><h4 id="ClipState-1"><a href="#ClipState-1" class="headerlink" title="ClipState"></a>ClipState</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">var</span> stateData = layerData.states[i];<br>AnimancerState state = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (stateData.stateType == NetworkAnimationStateData.StateType.Clip)<br>&#123;<br>    <span class="hljs-keyword">if</span> (!id2State.TryGetValue(stateData.stateHash, <span class="hljs-keyword">out</span> state))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (!animancer.Graph.Transitions.TryGetTransition(stateData.transitionIndex,<br>            <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> transitionModifierGroup))<br>        &#123;<br>            Debug.LogError(<br>                <span class="hljs-string">$&quot;Transition index <span class="hljs-subst">&#123;stateData.transitionIndex&#125;</span> not found in Animancer Graph.&quot;</span>);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        state = layer.GetOrCreateState(transitionModifierGroup.Transition);<br>        id2State[stateData.stateHash] = state;<br>    &#125;<br>&#125;<br><br>state.Speed = stateData.speed;<br>state.Time = stateData.time;<br>state.Weight = stateData.weight;<br></code></pre></td></tr></table></figure><h4 id="CartesianMixer"><a href="#CartesianMixer" class="headerlink" title="CartesianMixer"></a>CartesianMixer</h4><p>主要是创建的时候需要反序列化payload数据，然后根据payload数据创建CartesianMixerState</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs csharp">DirectionalMixerState mixerState;<br><span class="hljs-keyword">var</span> parmData = MemoryPackSerializer.Deserialize&lt;DirectionalMixerStateData&gt;(stateData.payload);<br><span class="hljs-keyword">if</span> (!id2State.TryGetValue(stateData.stateHash, <span class="hljs-keyword">out</span> state))<br>&#123;<br>    mixerState = <span class="hljs-keyword">new</span> DirectionalMixerState();<br>    state = mixerState;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>; index &lt; parmData.transitionIndices.Length; index++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (!animancer.Graph.Transitions.TryGetTransition(parmData.transitionIndices[index],<br>            <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> transitionModifierGroup))<br>        &#123;<br>            Debug.LogError(<br>                <span class="hljs-string">$&quot;Transition index <span class="hljs-subst">&#123;parmData.transitionIndices[index]&#125;</span> not found in Animancer Graph.&quot;</span>);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        mixerState.Add(<br>            transitionModifierGroup.Transition,<br>            parmData.thresholds[index]);<br>    &#125;<br><br>    id2State[stateData.stateHash] = state;<br>&#125;<br><br>mixerState = state <span class="hljs-keyword">as</span> DirectionalMixerState;<br><span class="hljs-keyword">if</span> (mixerState == <span class="hljs-literal">null</span>)<br>&#123;<br>    Debug.LogError(<span class="hljs-string">$&quot;State hash <span class="hljs-subst">&#123;stateData.stateHash&#125;</span> is not DirectionalMixerState.&quot;</span>);<br>    <span class="hljs-keyword">continue</span>;<br>&#125;<br><br>mixerState.Parameter = parmData.parameter;<br></code></pre></td></tr></table></figure><h4 id="DirectionalMixer"><a href="#DirectionalMixer" class="headerlink" title="DirectionalMixer"></a>DirectionalMixer</h4><p>….. 内容和CartesianMixer类似，不再赘述</p><h4 id="LinearMixer"><a href="#LinearMixer" class="headerlink" title="LinearMixer"></a>LinearMixer</h4><p>….. 内容和CartesianMixer类似，不再赘述</p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>Animation</tag>
      
      <tag>Animancer</tag>
      
      <tag>Networking</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何让Shader支持DOTS</title>
    <link href="/2025/11/19/%E5%A6%82%E4%BD%95%E8%AE%A9Shader%E6%94%AF%E6%8C%81DOTS/"/>
    <url>/2025/11/19/%E5%A6%82%E4%BD%95%E8%AE%A9Shader%E6%94%AF%E6%8C%81DOTS/</url>
    
    <content type="html"><![CDATA[<p>DOTS Shader 需要同时支持SRP Batch 和 GPU Instacing<br>参考Unity官方文档修改即可</p><ul><li><a href="https://zhuanlan.zhihu.com/p/82102092">https://zhuanlan.zhihu.com/p/82102092</a></li><li><a href="https://docs.unity3d.com/2022.3/Documentation/Manual/dots-instancing-shaders.html">https://docs.unity3d.com/2022.3/Documentation/Manual/dots-instancing-shaders.html</a></li></ul><h1 id="示例Shader"><a href="#示例Shader" class="headerlink" title="示例Shader"></a>示例Shader</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs shaderlab"><br>Shader &quot;DOTS/Example&quot;<br>&#123;<br>Properties<br>&#123;<br>_BaseMap (&quot;Texture&quot;, 2D) = &quot;white&quot; &#123;&#125;// 主贴图<br>_Color (&quot;Color&quot;, Color) = (1,1,1,1) //颜色<br>&#125;<br>SubShader<br>&#123;<br>Tags<br>&#123;<br>&quot;RenderType&quot;=&quot;Opaque&quot;<br>&quot;RenderPipeLine&quot;=&quot;UniversalRenderPipeline&quot; //用于指明使用URP来渲染<br>&#125;<br>Pass<br>&#123;<br>// Pass的标签<br>Tags &#123;&#125;<br>HLSLPROGRAM<br>// 编译指令<br>#pragma vertex vert // vertex shader 的函数 是 vert<br>#pragma fragment frag // fragment shader 的函数 是 frag<br><br>            #pragma multi_compile_instancing<br>            #include_with_pragmas &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/DOTS.hlsl&quot;<br><br><br>            #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&quot;<br>            <br><br>            // 支持SRP Batcher<br>            CBUFFER_START(UnityPerMaterial)<br>                //声明变量<br>                float4 _BaseMap_ST;<br>                float4 _Color;<br>            CBUFFER_END<br><br>            TEXTURE2D(_BaseMap); //贴图采样  <br>            SAMPLER(sampler_BaseMap);<br><br><br>            #ifdef UNITY_DOTS_INSTANCING_ENABLED<br>            UNITY_DOTS_INSTANCING_START(MaterialPropertyMetadata)<br>                UNITY_DOTS_INSTANCED_PROP(float4, _Color)<br>            UNITY_DOTS_INSTANCING_END(MaterialPropertyMetadata)<br>            #endif<br><br><br>            //        a2v -&gt; attribute to vertex<br>            struct a2v //顶点着色器<br>            &#123;<br>                float4 positionOS: POSITION;<br>                float2 uv : TEXCOORD0;<br>                UNITY_VERTEX_INPUT_INSTANCE_ID<br>            &#125;;<br><br>            // v2f -&gt; vertex to fragment<br>            struct v2f //片元着色器<br>            &#123;<br>                float4 positionCS: SV_POSITION;<br>                float2 uv: TEXCOORD0;<br>                UNITY_VERTEX_INPUT_INSTANCE_ID<br>            &#125;;<br><br><br>            v2f vert(a2v v)<br>            &#123;<br>                v2f o;<br>                UNITY_SETUP_INSTANCE_ID(v);<br>                UNITY_TRANSFER_INSTANCE_ID(v, o);<br>                UNITY_INITIALIZE_VERTEX_OUTPUT_STEREO(o);<br>                o.positionCS = TransformObjectToHClip(v.positionOS.xyz);<br>                o.uv = TRANSFORM_TEX(v.uv, _BaseMap);<br>                return o;<br>            &#125;<br><br>            half4 frag(v2f i) : SV_Target /* 注意在HLSL中，fixed4类型变成了half4类型*/<br>            &#123;<br>                UNITY_SETUP_INSTANCE_ID(i);<br>                half4 col = SAMPLE_TEXTURE2D(_BaseMap, sampler_BaseMap, i.uv);<br>                return col * _Color;<br>            &#125;<br>            ENDHLSL<br>        &#125;<br>    &#125;<br><br>    //    Fallback &quot;Universal Render Pipeline/Unlit&quot;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Unity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>Shader</tag>
      
      <tag>DOTS</tag>
      
      <tag>SRP Batch</tag>
      
      <tag>GPU Instancing</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>股票常识</title>
    <link href="/2025/11/12/%E8%82%A1%E7%A5%A8%E5%B8%B8%E8%AF%86/"/>
    <url>/2025/11/12/%E8%82%A1%E7%A5%A8%E5%B8%B8%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<ul><li><p><strong>股票的真正收益来自于分红</strong></p></li><li><p><strong>低买高卖是在挣其他投资者的钱</strong></p></li></ul><h1 id="市盈率（P-E-Ratio）"><a href="#市盈率（P-E-Ratio）" class="headerlink" title="市盈率（P&#x2F;E Ratio）"></a>市盈率（P&#x2F;E Ratio）</h1><p>指股票价格与每股收益（EPS）的比率，计算公式为：市盈率 &#x3D; 每股市价 ÷ 每股收益。<br>市盈率可以帮助投资者初步判断股票的估值高低。<br>例如，如果一只股票的市价为50元，过去一年的每股收益为5元，则市盈率为10倍。这意味着按当前盈利水平，投资者需要10年才能收回成本。<br>市盈率还有静态和动态之分，静态市盈率使用的是去年的每股收益，而动态市盈率则是预测的本年收益</p><hr><h1 id="每股收益"><a href="#每股收益" class="headerlink" title="每股收益"></a>每股收益</h1><p>每股收益（EPS）的计算公式为：每股收益 &#x3D; （净利润 - 优先股股息）&#x2F; 普通股加权平均股数。<br>每股收益的定义<br>每股收益（Earnings Per Share, EPS）是衡量公司盈利能力的重要财务指标，表示每一股普通股所能分配到的净利润。它通常用于评估公司的经营成果和投资价值，是投资者做出投资决策的重要依据之一。<br>计算步骤</p><ol><li>确定净利润：首先需要计算公司的净利润，通常是指扣除所有费用、税收和优先股股息后的利润。</li><li>扣除优先股股息：如果公司发行了优先股，则需要从净利润中扣除支付给优先股股东的股息。</li><li>计算普通股加权平均股数：根据会计期间内的普通股流通数量，计算加权平均股数。如果在期间内有增发或回购股票，需要按比例计算。</li><li>应用公式：将净利润（扣除优先股股息后）除以普通股加权平均股数，得到每股收益。<br>示例<br>假设某公司在某年的净利润为500万元，支付给优先股股东的股息为50万元，普通股的加权平均股数为100万股，则每股收益的计算如下：<br>每股收益&#x3D;500万−50万100万&#x3D;4.5元&#x2F;股每股收益&#x3D;100万500万−50万&#x3D;4.5元&#x2F;股<br>重要性<br>每股收益是投资者评估公司盈利能力和股票价值的重要指标。较高的每股收益通常意味着公司盈利能力较强，可能带来更高的股息分配和股价上涨潜力。然而，投资者在做出决策时，应该结合其他财务指标和市场分析进行综合考虑。</li></ol><hr><h1 id="市净率"><a href="#市净率" class="headerlink" title="市净率"></a>市净率</h1><p>市净率反映的是股票价格与每股净资产的比率。当市净率小于1时，意味着股票价格低于每股净资产，这可能是股票被低估的信号。一些资产雄厚但股价低迷的公司可能就处于这种情况。但要注意，市净率低也可能是因为公司资产质量不佳或者面临一些潜在风险，所以不能仅凭市净率就判定股票低估，还需结合其他因素。</p><hr><h1 id="每股净资产"><a href="#每股净资产" class="headerlink" title="每股净资产"></a>每股净资产</h1><p>每股净资产的计算公式为：每股净资产 &#x3D; 股东权益总额 &#x2F; 总股本。<br>计算公式详解</p><ol><li>股东权益总额：这是公司总资产减去总负债后的余额，代表公司所有者的权益。它可以从公司的资产负债表中直接获取。</li><li>总股本：指公司发行在外的普通股总数。<br>示例<br>例如，如果某公司的股东权益总额为15亿元，总股本为10亿股，则每股净资产的计算为：<br>每股净资产&#x3D;15亿元10亿股&#x3D;1.5元&#x2F;股每股净资产&#x3D;10亿股15亿元&#x3D;1.5元&#x2F;股<br>重要性<br>每股净资产是评估公司内在价值的重要指标之一。它反映了每股股票所对应的资产现值，通常每股净资产越高，表明股东拥有的每股资产价值越多，投资价值也越高。投资者可以通过比较不同公司的每股净资产来判断其投资价值和财务健康状况。</li></ol><hr><h1 id="股息率"><a href="#股息率" class="headerlink" title="股息率"></a>股息率</h1><p>公司每年分配给股东的股息总额与股票当前价格的比率<br>股息率是指公司每年分配给股东的股息总额与股票当前价格的比率，反映了投资者通过分红获得的收益潜力。其计算方法主要有两种：静态股息率和动态股息率，前者侧重于历史稳定性，后者则关注时效性。高股息率通常吸引寻求稳定收益的投资者，但需要注意的是，股息率的高低并不总是反映公司的盈利能力。</p><hr><p>资产负债表<br><a href="https://zhuanlan.zhihu.com/p/458657389">https://zhuanlan.zhihu.com/p/458657389</a></p><hr><p>分红<br><a href="https://zhuanlan.zhihu.com/p/337521869">https://zhuanlan.zhihu.com/p/337521869</a></p><hr><h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><p>股价为什么会涨？</p><ul><li>别人愿意出更高的价格买你的股票时，股价就会上涨。</li></ul><hr><p>市值是怎么计算的？</p><ul><li>总市值 &#x3D; 股价 × 发行在外的股票总数</li></ul><hr>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>hexo命令速记</title>
    <link href="/2025/11/12/hexo%E5%91%BD%E4%BB%A4%E9%80%9F%E8%AE%B0/"/>
    <url>/2025/11/12/hexo%E5%91%BD%E4%BB%A4%E9%80%9F%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 初始化 Hexo 博客</span><br>hexo init &lt;folder&gt;  <br><span class="hljs-comment"># 在指定文件夹中初始化一个新的 Hexo 博客</span><br><span class="hljs-comment"># 进入博客目录</span><br><span class="hljs-built_in">cd</span> &lt;folder&gt;<br><span class="hljs-comment"># 安装依赖包</span><br>npm install<br><span class="hljs-comment"># 生成静态文件</span><br>hexo generate 或 hexo g<br><span class="hljs-comment"># 预览本地服务器</span><br>hexo server 或 hexo s<br><span class="hljs-comment"># 部署到远程服务器</span><br>hexo deploy 或 hexo d<br><span class="hljs-comment"># 清除生成的静态文件</span><br>hexo clean<br><span class="hljs-comment"># 创建新文章</span><br>hexo new &lt;post_name&gt; 或 hexo n &lt;post_name&gt;<br><span class="hljs-comment"># 创建新草稿</span><br>hexo new draft &lt;draft_name&gt; 或 hexo n draft &lt;draft_name&gt;<br><span class="hljs-comment"># 发布草稿</span><br>hexo publish &lt;draft_name&gt; 或 hexo p &lt;draft_name&gt;<br><span class="hljs-comment"># 查看 Hexo 版本</span><br>hexo version 或 hexo -v<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>逃离UnityCN</title>
    <link href="/2025/11/11/%E9%80%83%E7%A6%BBUnityCN/"/>
    <url>/2025/11/11/%E9%80%83%E7%A6%BBUnityCN/</url>
    
    <content type="html"><![CDATA[<p>Unity中国实在是罪大恶极，自从Unity中国变成独立公司之后，国内就没办法以正常途径下载国际版Unity了，即使使用的是国际版Hub</p><p>这里介绍一种逃离办法，需要有VPN</p><ul><li><p>首先UnityHub默认启动时，不会读取系统代理，也就是说，即使你开了VPN，挂到了国外节点，Hub也不会走代理访问Unity服务器</p></li><li><p>如何判断当前UnityHub是否走了代理？</p><ul><li>退出登陆，然后点Sign In，如果弹出的登陆页面里有cn，不能用Google登陆，那就是代理没生效</li></ul></li><li><p>我们要通过命令行的方式启动Unity Hub ，并且让它走代理</p><ul><li><p>MacOS下，打开终端，执行以下命令，生成一个launchUnityHub.command文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">echo &#x27;#!/bin/bash<br>export HTTP_PROXY=http://127.0.0.1:7890<br>export HTTPS_PROXY=http://127.0.0.1:7890<br>nohup &quot;/Applications/Unity Hub.app/Contents/MacOS/Unity Hub&quot; &amp;&gt;/dev/null &amp;&#x27; &gt; launchUnityHub.command<br>chmod +x launchUnityHub.command<br></code></pre></td></tr></table></figure></li><li><p>Windows下，打开记事本，输入以下内容，保存为launchUnityHub.bat文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">@echo off<br>set HTTP_PROXY=http://127.0.0.1:1080<br>set HTTPS_PROXY=http://127.0.0.1:1080<br>start &quot;&quot; &quot;C:\Program Files\Unity Hub\Unity Hub.exe&quot;<br></code></pre></td></tr></table></figure></li><li><p>将1080设置为自己的代理端口，Clash默认是7890，Shadowsocks默认是1080</p></li><li><p>双击launchUnityHub.command或launchUnityHub.bat启动Unity Hub</p></li></ul></li><li><p>这时候你再点Sign In，就会发现可以用Google账号登陆了</p></li><li><p>登陆之后，你就可以正常下载国际版Unity了</p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>Unity CN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NetworkCharacterView</title>
    <link href="/2025/11/03/NetworkCharacterView/"/>
    <url>/2025/11/03/NetworkCharacterView/</url>
    
    <content type="html"><![CDATA[<ul><li>数据结构的定义<ul><li>NetworkCharacterData：包含位置、旋转、速度、时间戳、动画数据等</li><li>NetworkAnimationData：包含动画ID、AvatarMask ID、播放时长、权重、播放速度</li></ul></li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> MemoryPack;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">Character</span><br>&#123;<br>    [<span class="hljs-meta">MemoryPackable</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> NetworkCharacterData<br>    &#123;<br>        <span class="hljs-keyword">public</span> Vector3 velocity;<br>        <span class="hljs-keyword">public</span> Vector3 position;<br>        <span class="hljs-keyword">public</span> Quaternion rotation;<br>        <br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> timestamp;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> tick;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 动画信息</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> ArraySegment&lt;NetworkAnimationData&gt; animations;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;Pos:<span class="hljs-subst">&#123;position&#125;</span> Rot:<span class="hljs-subst">&#123;rotation&#125;</span> Vel:<span class="hljs-subst">&#123;velocity&#125;</span> AnimCount:<span class="hljs-subst">&#123;animations.Count&#125;</span>&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    [<span class="hljs-meta">MemoryPackable</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> NetworkAnimationData<br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> animationId; <span class="hljs-comment">// 对应的动画 根据id去找到animation文件</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> avatarMaskId;<span class="hljs-comment">// 这个动画对应的avatarMask 用于做融合和分层</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> duration; <span class="hljs-comment">// 这个动画到目前为止播了多久 用于恢复动画状态</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> weight;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> speed;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>主要看Update()<ul><li>收到网络消息后，生成一个TransformSnapshot，存入transformSnapshotBuffer</li><li>Update()中根据时间戳进行插值和外推，更新位置和旋转<ul><li>如果是第一次处理数据，直接设置位置和旋转，并更新动画状态</li><li>如果有两个及以上快照，进行插值计算位置和旋转<ul><li>根据当前的移动状态，计算是否需要立刻切换动画，还是继续播放当前动画（避免网络抖动导致频繁切换动画以及单一动画的卡顿）</li></ul></li><li>如果只有一个快照，根据速度进行外推计算位置和旋转</li></ul></li><li>同时根据插值结果更新动画状态，保证动画的平滑过渡和同步</li></ul></li><li>还实现了DeSerializeAnimations()，用于本地玩家将当前动画状态序列化成NetworkAnimationData数组，发送给服务器</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Runtime.CompilerServices;<br><span class="hljs-keyword">using</span> Animancer;<br><span class="hljs-keyword">using</span> MemoryPack;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> UnityEngine.Pool;<br><span class="hljs-keyword">using</span> Wepie.Core.CircularBuffer;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">Character</span><br>&#123;<br>    [<span class="hljs-meta">MemoryPackable</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> TransformSnapshot<br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> timestamp;<br>        <span class="hljs-keyword">public</span> Vector3 position;<br>        <span class="hljs-keyword">public</span> Quaternion rotation;<br>        <span class="hljs-keyword">public</span> Vector3 velocity;<br>        <span class="hljs-keyword">public</span> NetworkAnimationData[] animations; <span class="hljs-comment">// 动画快照</span><br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 远程玩家的角色，只做表现，没有逻辑</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NetworkCharacterView</span> : <span class="hljs-title">MonoBehaviour</span><br>    &#123;<br>        [<span class="hljs-meta">field: SerializeField</span>] <span class="hljs-keyword">public</span> CharacterAnimationLibrary characterAnimationLibrary &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br>        [<span class="hljs-meta">field: SerializeField</span>] <span class="hljs-keyword">public</span> Animator animator &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br>        [<span class="hljs-meta">field: SerializeField</span>] <span class="hljs-keyword">public</span> AnimancerComponent animancer &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br>        [<span class="hljs-meta">field: SerializeField</span>] <span class="hljs-keyword">public</span> AnimationCallback animationCallback &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br>        [<span class="hljs-meta">field: SerializeField</span>] <span class="hljs-keyword">public</span> Collider remoteCollider &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br>        [<span class="hljs-meta">field: SerializeField</span>] <span class="hljs-keyword">public</span> CharacterConfig characterConfig &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-keyword">private</span> HashSet&lt;AnimationClip&gt; reusableClipSet = <span class="hljs-keyword">new</span> HashSet&lt;AnimationClip&gt;();<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isLocalPlayer = <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">private</span> CircularBuffer&lt;TransformSnapshot&gt; transformSnapshotBuffer = <span class="hljs-keyword">new</span> CircularBuffer&lt;TransformSnapshot&gt;(<span class="hljs-number">16</span>);<br><br>        <span class="hljs-comment">// 插值参数</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">float</span> InterpBackTime = <span class="hljs-number">0.1f</span>; <span class="hljs-comment">// 插值窗口（秒）</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">float</span> MaxExtrapolationTime = <span class="hljs-number">0.25f</span>; <span class="hljs-comment">// 最大外推（秒）</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">float</span> SnapThreshold = <span class="hljs-number">2.0f</span>; <span class="hljs-comment">// 位置跳跃阈值</span><br><br>        <span class="hljs-keyword">private</span> Vector3 smoothedPosition;<br>        <span class="hljs-keyword">private</span> Quaternion smoothedRotation;<br>        <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> initialized = <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-comment">// 用于判断“运动到静止”时动画不能提前Idle</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">float</span> MotionThreshold = <span class="hljs-number">0.05f</span>; <span class="hljs-comment">// 速度阈值</span><br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Setup</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> isLocalPlayer</span>)</span><br>        &#123;<br>            characterAnimationLibrary.Setup();<br>            reusableClipSet = <span class="hljs-keyword">new</span> HashSet&lt;AnimationClip&gt;();<br>            <span class="hljs-keyword">if</span> (isLocalPlayer)<br>            &#123;<br>                Destroy(remoteCollider);<br>            &#125;<br>            <span class="hljs-keyword">this</span>.isLocalPlayer = isLocalPlayer;<br>        &#125;<br><br>        [<span class="hljs-meta">MethodImpl(MethodImplOptions.AggressiveInlining)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnNetworkData</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> NetworkCharacterData networkData, <span class="hljs-built_in">bool</span> tickImmediately</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (isLocalPlayer) <span class="hljs-keyword">return</span>;<br>            <span class="hljs-comment">// 存储动画快照</span><br>            <span class="hljs-keyword">var</span> snapshot = <span class="hljs-keyword">new</span> TransformSnapshot()<br>            &#123;<br>                timestamp = networkData.timestamp,<br>                position = networkData.position,<br>                rotation = networkData.rotation,<br>                velocity = networkData.velocity,<br>                animations = networkData.animations.Count &gt; <span class="hljs-number">0</span><br>                    ? networkData.animations.ToArray()<br>                    : Array.Empty&lt;NetworkAnimationData&gt;()<br>            &#125;;<br>            transformSnapshotBuffer.PushBack(snapshot);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (isLocalPlayer) <span class="hljs-keyword">return</span>;<br><br>            <span class="hljs-built_in">double</span> now = Time.realtimeSinceStartupAsDouble;<br>            <span class="hljs-built_in">double</span> renderTimestamp = (now - InterpBackTime) * <span class="hljs-number">1000.0</span>;<br><br>            <span class="hljs-keyword">if</span> (transformSnapshotBuffer.Count == <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span>;<br><br>            <span class="hljs-keyword">if</span> (!initialized)<br>            &#123;<br>                <span class="hljs-keyword">var</span> first = transformSnapshotBuffer[<span class="hljs-number">0</span>];<br>                smoothedPosition = first.position;<br>                smoothedRotation = first.rotation;<br>                transform.position = smoothedPosition;<br>                transform.rotation = smoothedRotation;<br>                UpdateAnimation(first.animations);<br>                initialized = <span class="hljs-literal">true</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 保证插值区间</span><br>            <span class="hljs-keyword">while</span> (transformSnapshotBuffer.Count &gt;= <span class="hljs-number">2</span> &amp;&amp;<br>                   transformSnapshotBuffer[<span class="hljs-number">1</span>].timestamp &lt;= renderTimestamp)<br>            &#123;<br>                transformSnapshotBuffer.PopFront();<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (transformSnapshotBuffer.Count &gt;= <span class="hljs-number">2</span>)<br>            &#123;<br>                <span class="hljs-keyword">var</span> <span class="hljs-keyword">from</span> = transformSnapshotBuffer[<span class="hljs-number">0</span>];<br>                <span class="hljs-keyword">var</span> to = transformSnapshotBuffer[<span class="hljs-number">1</span>];<br>                <span class="hljs-built_in">double</span> t0 = <span class="hljs-keyword">from</span>.timestamp;<br>                <span class="hljs-built_in">double</span> t1 = to.timestamp;<br>                <span class="hljs-built_in">float</span> t = t1 &gt; t0 ? Mathf.Clamp01((<span class="hljs-built_in">float</span>)((renderTimestamp - t0) / (t1 - t0))) : <span class="hljs-number">0f</span>;<br><br>                Vector3 interpPos = Vector3.Lerp(<span class="hljs-keyword">from</span>.position, to.position, t);<br>                Quaternion interpRot = Quaternion.Slerp(<span class="hljs-keyword">from</span>.rotation, to.rotation, t);<br><br>                <span class="hljs-keyword">if</span> ((smoothedPosition - interpPos).sqrMagnitude &gt; SnapThreshold * SnapThreshold)<br>                    smoothedPosition = interpPos;<br>                <span class="hljs-keyword">else</span><br>                    smoothedPosition = Vector3.Lerp(smoothedPosition, interpPos, <span class="hljs-number">0.5f</span>);<br><br>                smoothedRotation = Quaternion.Slerp(smoothedRotation, interpRot, <span class="hljs-number">0.5f</span>);<br><br>                transform.position = smoothedPosition;<br>                transform.rotation = smoothedRotation;<br><br>                <span class="hljs-comment">// ----- 动画同步修正 -----</span><br>                <span class="hljs-comment">// 判断from-&gt;to是否是运动到静止，如果是，则插值期间动画始终用from（运动）动画，只有t==1时才切to（Idle）</span><br>                <span class="hljs-built_in">bool</span> fromMoving = <span class="hljs-keyword">from</span>.velocity.sqrMagnitude &gt; MotionThreshold * MotionThreshold;<br>                <span class="hljs-built_in">bool</span> toIdle = to.velocity.sqrMagnitude &lt;= MotionThreshold * MotionThreshold;<br>                <span class="hljs-keyword">if</span> (fromMoving &amp;&amp; toIdle &amp;&amp; t &lt; <span class="hljs-number">1.0f</span>)<br>                &#123;<br>                    UpdateAnimation(<span class="hljs-keyword">from</span>.animations);<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    UpdateAnimation(to.animations);<br>                &#125;<br>                <span class="hljs-comment">// --------------------------------</span><br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-comment">// 只有一个快照，外推</span><br>                <span class="hljs-keyword">var</span> last = transformSnapshotBuffer[<span class="hljs-number">0</span>];<br>                <span class="hljs-built_in">float</span> dt = Mathf.Min((<span class="hljs-built_in">float</span>)((renderTimestamp - last.timestamp) * <span class="hljs-number">0.001f</span>), MaxExtrapolationTime);<br>                Vector3 extrapolatedPos = last.position + last.velocity * dt;<br>                Quaternion extrapolatedRot = last.rotation;<br><br>                <span class="hljs-keyword">if</span> ((smoothedPosition - extrapolatedPos).sqrMagnitude &gt; SnapThreshold * SnapThreshold)<br>                    smoothedPosition = extrapolatedPos;<br>                <span class="hljs-keyword">else</span><br>                    smoothedPosition = Vector3.Lerp(smoothedPosition, extrapolatedPos, <span class="hljs-number">0.5f</span>);<br><br>                smoothedRotation = Quaternion.Slerp(smoothedRotation, extrapolatedRot, <span class="hljs-number">0.5f</span>);<br><br>                transform.position = smoothedPosition;<br>                transform.rotation = smoothedRotation;<br><br>                UpdateAnimation(last.animations);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateAnimation</span>(<span class="hljs-params">NetworkAnimationData[] animations</span>)</span><br>        &#123;<br>            reusableClipSet.Clear();<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> animationData <span class="hljs-keyword">in</span> animations)<br>            &#123;<br>                <span class="hljs-keyword">var</span> clip = characterAnimationLibrary.GetClip(animationData.animationId);<br>                <span class="hljs-keyword">if</span> (clip != <span class="hljs-literal">null</span>) reusableClipSet.Add(clip);<br>            &#125;<br><br>            <span class="hljs-comment">// 停止没有用到的动画</span><br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> animancerState <span class="hljs-keyword">in</span> animancer.States)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (!animancerState.IsPlaying) <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-built_in">bool</span> found = reusableClipSet.Contains(animancerState.Clip);<br>                <span class="hljs-keyword">if</span> (!found)<br>                &#123;<br>                    animancerState.Weight = <span class="hljs-number">0</span>;<br>                    animancerState.Stop();<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> animationData <span class="hljs-keyword">in</span> animations)<br>            &#123;<br>                <span class="hljs-keyword">var</span> clip = characterAnimationLibrary.GetClip(animationData.animationId);<br>                <span class="hljs-keyword">if</span> (clip == <span class="hljs-literal">null</span>) <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">if</span> (animancer.States.TryGet(clip, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> state))<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (state.IsPlaying) <span class="hljs-keyword">continue</span>;<br>                    <span class="hljs-keyword">if</span> (state.Speed == <span class="hljs-number">0</span>)<br>                    &#123;<br>                        Debug.LogError(<span class="hljs-string">&quot;nicoier[角色]:反序列化异常 Animation speed is zero for clip: &quot;</span> + clip.name);<br>                        state.Speed = <span class="hljs-number">1.0f</span>;<br>                    &#125;<br><br>                    state.Play();<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br><br>                state = animancer.Play(clip);<br>                state.LayerIndex = animationData.avatarMaskId;<br>                <span class="hljs-built_in">float</span> speed = animationData.speed;<br>                <span class="hljs-keyword">if</span> (speed == <span class="hljs-number">0</span>)<br>                &#123;<br>                    Debug.LogError(<span class="hljs-string">&quot;nicoier[角色]:反序列化异常 Animation speed is zero for clip: &quot;</span> + clip.name);<br>                    speed = <span class="hljs-number">1.0f</span>;<br>                &#125;<br><br>                state.Speed = speed;<br>                state.Weight = animationData.weight;<br>                state.Time = animationData.duration;<br>            &#125;<br><br>            <span class="hljs-comment">// Normalize Weights per layer</span><br>            Span&lt;<span class="hljs-built_in">float</span>&gt; totalWeights = <span class="hljs-keyword">stackalloc</span> <span class="hljs-built_in">float</span>[animancer.Layers.Count];<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> animancerState <span class="hljs-keyword">in</span> animancer.States)<br>            &#123;<br>                totalWeights[animancerState.LayerIndex] += animancerState.Weight;<br>            &#125;<br><br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> animancerState <span class="hljs-keyword">in</span> animancer.States)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (!animancerState.IsPlaying) <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">if</span> (animancerState.Weight == <span class="hljs-number">0f</span>) <span class="hljs-keyword">continue</span>;<br><br>                <span class="hljs-keyword">var</span> totalWeight = totalWeights[animancerState.LayerIndex];<br>                <span class="hljs-keyword">if</span> (totalWeight &gt; <span class="hljs-number">0</span>)<br>                &#123;<br>                    animancerState.Weight /= totalWeights[animancerState.LayerIndex];<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> ArraySegment&lt;NetworkAnimationData&gt; <span class="hljs-title">DeSerializeAnimations</span>(<span class="hljs-params">NetworkAnimationData[] reusedAnimations</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (!isLocalPlayer)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;nicoier[角色]:Only local player can serialize animations.&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-built_in">int</span> count = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> animancerState <span class="hljs-keyword">in</span> animancer.States)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (animancerState.IsPlaying &amp;&amp; animancerState.Weight &gt; <span class="hljs-number">0f</span> &amp;&amp; animancerState.Speed &gt; <span class="hljs-number">0f</span>)<br>                &#123;<br>                    ++count;<br>                &#125;<br>            &#125;<br><br>            Span&lt;<span class="hljs-built_in">float</span>&gt; totalWeights = <span class="hljs-keyword">stackalloc</span> <span class="hljs-built_in">float</span>[animancer.Layers.Count];<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> animancerState <span class="hljs-keyword">in</span> animancer.States)<br>            &#123;<br>                totalWeights[animancerState.LayerIndex] += animancerState.Weight;<br>            &#125;<br><br>            ArraySegment&lt;NetworkAnimationData&gt; segment =<br>                <span class="hljs-keyword">new</span> ArraySegment&lt;NetworkAnimationData&gt;(reusedAnimations, <span class="hljs-number">0</span>, count);<br>            <span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>;<br><br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> animancerState <span class="hljs-keyword">in</span> animancer.States)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (!animancerState.IsPlaying) <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">if</span> (animancerState.Weight == <span class="hljs-number">0f</span>) <span class="hljs-keyword">continue</span>;<br><br>                <span class="hljs-built_in">bool</span> thisLayerGreaterThanOne = totalWeights[animancerState.LayerIndex] &gt; <span class="hljs-number">1.0f</span>;<br>                <span class="hljs-built_in">float</span> weight = animancerState.Weight;<br>                <span class="hljs-keyword">if</span> (thisLayerGreaterThanOne)<br>                &#123;<br>                    weight = animancerState.Weight / totalWeights[animancerState.LayerIndex];<br>                &#125;<br><br>                <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">new</span> NetworkAnimationData();<br>                data.animationId = characterAnimationLibrary.GetAnimationId(animancerState.Clip);<br>                data.avatarMaskId = animancerState.LayerIndex;<br>                data.duration = animancerState.Duration;<br>                data.weight = weight;<br>                <span class="hljs-built_in">float</span> speed = animancerState.Speed;<br>                <span class="hljs-keyword">if</span> (speed == <span class="hljs-number">0</span>)<br>                &#123;<br>                    Debug.LogError(<span class="hljs-string">&quot;nicoier[角色]: 序列化异常 Animation speed is zero for clip: &quot;</span> + animancerState.Clip.name);<br>                    speed = <span class="hljs-number">1.0f</span>;<br>                &#125;<br><br>                data.speed = speed;<br>                reusedAnimations[index] = data;<br>                ++index;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> segment;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span><br>        &#123;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Network</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>EntitiesGraphics</title>
    <link href="/2025/08/27/EntitiesGrphics/"/>
    <url>/2025/08/27/EntitiesGrphics/</url>
    
    <content type="html"><![CDATA[<h1 id="Entities-Graphics"><a href="#Entities-Graphics" class="headerlink" title="Entities Graphics"></a>Entities Graphics</h1><p>优化后的SRP Batch</p><p>利用了Burst编译器(LLVM)</p><p>多线程收集数据 (EntityQuery)</p><p>无论多少相机，只需要上传一次数据</p><ul><li><p>Data Persistent Model：这一部分用于在渲染系统中管理和上传数据，重点在于如何有效地管理渲染所需的各种数据，确保这些数据在不同渲染帧之间保持一致和可用。</p></li><li><p>Persistent Batches：这一部分涉及渲染批次的优化，以减少绘制调用的开销。通过在一定时间内保持批次的一致性，最大限度地减少了与每帧设置和执行这些批次相关的计算成本。</p></li></ul><h1 id="SRP-Batcher"><a href="#SRP-Batcher" class="headerlink" title="SRP Batcher"></a>SRP Batcher</h1><p>Unity是一款非常灵活的渲染引擎，允许在一帧的任何时间点修改Material属性。然而，这种灵活性带来了一些弊端。<br>比如，当一个DrawCall（绘制调用）需要使用新的Material时，需要进行大量的处理。<br>因此，场景中的Material数量越多，为设置GPU端的数据而占用的CPU资源就越多。<br>传统解决此问题的方法是减少DrawCall的数量，以优化CPU的渲染消耗。<br>因为在Unity中，发出DrawCall之前需要进行大量的设置，这些设置导致了实际的CPU消耗，而不是GPU DrawCall本身的消耗。<br>GPU DrawCall本身只是在渲染循环中向GPU命令缓冲区推送一些字节。<br>当一个新的Material被使用时，CPU会收集所有的属性，并在GPU内存中设置不同的Constant Buffers。<br>GPU缓冲区的数量取决于Shader如何声明其CBUFFERs。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text"># 参考文章<br>https://zhuanlan.zhihu.com/p/707811162<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>性能优化</tag>
      
      <tag>DOTS</tag>
      
      <tag>ECS</tag>
      
      <tag>渲染</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity Shader 变体数量优化</title>
    <link href="/2025/08/27/Unity-Shader-%E5%8F%98%E4%BD%93%E6%95%B0%E9%87%8F%E4%BC%98%E5%8C%96/"/>
    <url>/2025/08/27/Unity-Shader-%E5%8F%98%E4%BD%93%E6%95%B0%E9%87%8F%E4%BC%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<p>在使用URP之后，有时候会发现Shader变体数量暴增，导致打包体积过大，加载时间过长等问题。</p><p>通常这个情况出现在使用了Shader Graph，或者在自定义Shader中使用了多种关键词（Keywords）时。</p><p>Unity自带了一个工具去检查工程中使用到的变体，并且可以生成一个变体列表文件（.shadervariants）</p><p>在构建AB包&#x2F;打包时，可以指定这个文件，来剔除未使用的变体。</p><p>multi_compile 和 shader_feature 在编译时的行为完全不一样，multi_compile 会强制编译所有变体，而 shader_feature 则只会编译使用到的变体。</p><p>至于剔除则是在编译完Shader之后，根据变体列表文件来剔除未使用的变体。</p><p>所以要节约打包时间，最好使用 shader_feature 来替代 multi_compile。</p><p>要完整的跑一遍游戏所有的功能，才能确保变体列表文件的完整性。因为有时候Shader的某个变体只在游戏的某个分支中使用到，如果没有跑到这个分支，那么这个变体就不会被记录下来，导致显示异常。</p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>Shader</tag>
      
      <tag>性能优化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何入门渲染</title>
    <link href="/2025/08/13/%E5%A6%82%E4%BD%95%E5%85%A5%E9%97%A8%E6%B8%B2%E6%9F%93/"/>
    <url>/2025/08/13/%E5%A6%82%E4%BD%95%E5%85%A5%E9%97%A8%E6%B8%B2%E6%9F%93/</url>
    
    <content type="html"><![CDATA[<p>涵盖的知识领域太多了，学习路线非常陡峭</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>颜色空间、ACES、HDR与Tonemapping</title>
    <link href="/2025/08/11/%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4%E3%80%81ACES%E3%80%81HDR%E4%B8%8ETonemapping/"/>
    <url>/2025/08/11/%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4%E3%80%81ACES%E3%80%81HDR%E4%B8%8ETonemapping/</url>
    
    <content type="html"><![CDATA[<h1 id="从人眼说起"><a href="#从人眼说起" class="headerlink" title="从人眼说起"></a>从人眼说起</h1><p>人眼的感知能力是非常复杂的，主要由视网膜中的锥体细胞和杆体细胞共同作用。 锥体细胞负责色彩感知，而杆体细胞则对光线强度敏感。</p><p>人眼对不同波长的光有不同的敏感度，这种敏感度可以用<strong>光谱敏感函数</strong>来描述。<br>人眼的感知范围大约在380nm到750nm之间，这个范围内的光线被称为可见光。人眼对不同波长的光有不同的敏感度，这种敏感度可以用<strong>光谱敏感函数</strong>来描述。</p><p><img src="/../img/visible_light.png" alt="visible_light.png"></p><p>人眼的感知能力是非线性的，这意味着我们对光线强度的变化的感知并不是线性的。例如，当光线强度增加时，人眼对这种变化的感知并不会以相同比例增加。这种非线性特性使得人眼在处理高动态范围（HDR）图像时具有独特的优势。</p><h2 id="显示器和亮度"><a href="#显示器和亮度" class="headerlink" title="显示器和亮度"></a>显示器和亮度</h2><p>显示器的工作原理是将电信号转换为光信号。又分为LCD和OLED两种类型。</p><p>LCD（液晶显示器）的工作原理是通过液晶分子的排列来控制光线的透过率。液晶分子在电场作用下会改变其排列方式，从而改变光线的透过率。LCD显示器通常使用背光源来提供光线，通过滤光板来遮掉RGB分量的一部分，从而显示颜色</p><p>OLED则是每个像素点都能独立发光的技术。每个像素点由红、绿、蓝三种有机材料组成，当电流通过时，这些材料会发出相应颜色的光。由于OLED不需要背光源，因此可以实现更高的对比度和更广的色域。</p><p>显示器的亮度单位是<strong>尼特</strong>(nit)，对应的物理量是辐射亮度（Luminance），显示器的亮度范围通常在100到1000尼特之间。<br>当一个像素点显示为纯白色时，亮度最大，纯黑色时亮度最小。</p><p>光辐射相关的物理量都是线性的，可以进行加减乘除运算。</p><h3 id="从颜色到显示器的亮度"><a href="#从颜色到显示器的亮度" class="headerlink" title="从颜色到显示器的亮度"></a>从颜色到显示器的亮度</h3><p>理论上，假设有一个显示器的亮度范围是50～200，color &#x3D; (0.5,0.5,0.5) 在显示器上的亮度应该是 50 + (200 - 50) * 0.5 &#x3D; 125</p><p>实际上，color&#x3D;(0.5,0.5,0.5) 在显示器上的亮度是 <span> $ 50 + (200 - 50) * 0.5^{2.2} &#x3D; 82.64  $ <span></p><span><p>$$<br>L &#x3D; L_{min} + (L_{max} - L_{min}) \cdot C^{\gamma}<br>$$</p></span><p><img src="/../img/gamma_inverse.png" alt="gamma_inverse.png"><br>通过逆运算可以绘制出进行了Gamma校正和没有进行Gamma校正的图像，上面一行做没有做处理，显示器会进行Gamma校正，下面一行做了逆运算，抵消了显示器Gamma校正的结果。 肉眼观察下，下面一行的图像看起来更亮一些。</p><h3 id="人眼和显示器亮度-Gamma"><a href="#人眼和显示器亮度-Gamma" class="headerlink" title="人眼和显示器亮度(Gamma)"></a>人眼和显示器亮度(Gamma)</h3><p>前面说到，人眼的感知能力是非线性的。观察下面一组图像，上面是非线性变化的亮度，下面是线性变化的亮度。<br><img src="/../img/nit_compare.png" alt="nit_compare.png"></p><p>研究表明，人眼对于亮度的感知是对数(2.2~3)的，也就是说人眼对低亮度的变化更敏感，而对高亮度的变化不那么敏感。</p><h3 id="巧合"><a href="#巧合" class="headerlink" title="巧合?"></a>巧合?</h3><p>CRT的原理是通过电子束扫描荧光屏来产生图像，对于典型的CRT荧光粉，其电压和亮度之间的关系 <span> $ L &#x3D; V^{2.2~2.6} $ </span>，这与人眼的感知能力非常接近。</p><p>现代显示器已经能过做到手动调整gamma值了,但是通常gamma还是2.2。</p><h2 id="显示器和颜色"><a href="#显示器和颜色" class="headerlink" title="显示器和颜色"></a>显示器和颜色</h2><p>不同品牌和价位的显示器，能够显示的颜色范围是不同的。</p><h3 id="色深"><a href="#色深" class="headerlink" title="色深"></a>色深</h3><p>色深指的是显示器能够显示的颜色数量，通常用位数来表示。常见的色深有6bit,8bit, 10bit等。表示RGB每个通道从最暗到最亮有多少档位<br>8bit色深的显示器每个通道有256个档位，RGB三通道总共有256^3&#x3D;16777216种颜色。</p><p><img src="/../img/color_range_compare.png" alt="color_range_compare.png"></p><h3 id="色域"><a href="#色域" class="headerlink" title="色域"></a>色域</h3><p>色域指的是显示器能够显示的颜色范围。从光的角度理解，光是一种电磁波，不同波长的光在人眼中就是不同的颜色。<br>有人制作了一个图，来表示所有人眼可见的颜色<br><img src="/../img/%E8%89%B2%E5%BA%A6%E5%9B%BE.png" alt="色度图.png"></p><p>x轴和y轴分别表示红色和绿色的感知程度，红绿蓝三种颜色程度的感知总和为1,坐标<span>$(1&#x2F;3,1&#x2F;3)$</span>表示白色</p><p>色域就是在色度图选三个点R,G,B（表示最红，最绿，最蓝），画一个三角形</p><p>我们经常说的sRGB色域选取的三个点是 R(0.64, 0.33), G(0.30, 0.60), B(0.15, 0.06)，它们形成的三角形就是sRGB色域。<br><img src="/../img/sRGB.png" alt="sRGB.png"></p><p>不同的显示器，支持的色域不同，输入相同的RGB值，显示的颜色在人眼看来也会不同，比如（1，0，0）对应的红色，在DCI-P3色域显示器中就比sRGB色域显示器中更红，因为是sRGB下最红(1,0,0)在DCI-P3对应的位置是(0.91,0.2,0.13)</p><p><img src="/../img/DCI-sRGB.png" alt="DCI-sRGB.png"></p><p>可以看到sRGB是DCI-P3的一个子集，DCI-P3色域比sRGB色域更广，能够显示更多的颜色。</p><h3 id="色准"><a href="#色准" class="headerlink" title="色准"></a>色准</h3><p>色准指的是显示器在其色域标准下，某个RGB颜色对应的理论物理颜色和其实际显示的颜色之间的差异。色准越高，显示器显示的颜色越接近真实颜色。<br>色准通常用Delta E（ΔE）来表示，ΔE值越小,表示色准越高。</p><p>理所应当的，计算颜色的欧式距离就可以表示色准，但是我们不能使用R，G，B来计算，因为R，G，B色彩空间不具有感知均匀性。实际计算中要转换到Lab颜色模型下做计算(L明度，a红绿度，b黄蓝度)<br><span><br>$$<br>\Delta E &#x3D; \sqrt{(L_1 - L_2)^2 + (a_1 - a_2)^2 + (b_1 - b_2)^2}<br>$$<br></span></p><h2 id="从图形API到显示器"><a href="#从图形API到显示器" class="headerlink" title="从图形API到显示器"></a>从图形API到显示器</h2><p>在图形API里，我们可以创建各种格式的RGB颜色图，其实(r,g,b)的值通常在0~1之间,但是也可以超过1。</p><p>查阅资料发现，有的图形API可以支持(R32G32B32A32_FLOAT)格式，每个通道都是32位浮点数，这样就可以表示更广泛的颜色范围。</p><p>但是显示器的色深不一定支持这么大的范围，所有图形API提交到操作系统之后，操作系统还会做一次颜色转换，将格式转换为显示器支持的格式（例如超过1的值截断到1，转换到0~255的uint范围）。</p><p>我们通常说的HDR（High Dynamic Range）图像，其颜色值就可以超过1，这样可以表示更广泛的亮度范围和颜色范围，但是需要显示器支持HDR才可以显示出目标效果。</p><p>现代操作系统通常会提供HDR支持，允许应用程序提交HDR图像，并在支持HDR的显示器上正确显示，但是需要调用系统API告诉操作系统使用的颜色空间是什么，才能从高精度的颜色空间转换到显示器支持的颜色空间。</p><h2 id="相机和Gamma"><a href="#相机和Gamma" class="headerlink" title="相机和Gamma"></a>相机和Gamma</h2><p>相机拍摄的原始文件记录了传感器的原始信息包括：光照强度，位深，Meta数据（位置，时间等），色温参考，色彩空间标记（更多详细的相机原理就不多赘述了，比较复杂）</p><p>现实世界中的光照是线性的，相机拍摄的照片如果不做处理导出到显示器上观察会变的很暗（没有进行Gamma校正）</p><p>相机厂商早就考虑到这个问题了，相机在导出图片时会做 <span> $ 1 &#x2F;gamma &#x3D; 1&#x2F;2.2 $ </span>的处理</p><p><img src="/../img/gamma.png" alt="gamma.png"></p><h1 id="Gamma与线性空间"><a href="#Gamma与线性空间" class="headerlink" title="Gamma与线性空间"></a>Gamma与线性空间</h1><p>如果我们让超高水平美术在PS对着现实绘制一个鸡蛋，会发生什么呢？</p><p>鸡蛋的颜色在显示器上看着和现实中的鸡蛋颜色是一样的！</p><p>还记得么，显示器会对颜色做Gamma较正，也就是说，显示器上鸡蛋的颜色的亮度会比现实中的鸡蛋亮度更高！</p><p>如果我们按照美术绘制的图片中的RGB值在现实中把这个鸡蛋造出来，造出来的鸡蛋会比真鸡蛋更亮！</p><p>其实这并不是一个问题，因为我们看的是显示器，所以只需要显示器上的鸡蛋和现实中的鸡蛋颜色一致就可以了。</p><h2 id="问题是什么？"><a href="#问题是什么？" class="headerlink" title="问题是什么？"></a>问题是什么？</h2><p>现在，我们想要在游戏引擎里渲染出一个真实光照的鸡蛋，使用线性空间（因为现实世界是线性的）来处理光照计算，如果不加处理的使用美术绘制的鸡蛋图片，就会计算出不真实的结果</p><p>如果我们希望有一个物理正确的结果，对于所有“颜色”图片，在采样前都要做Gamma逆运算，将图片的颜色从Gamma空间转换到线性空间。</p><h2 id="对于UI"><a href="#对于UI" class="headerlink" title="对于UI"></a>对于UI</h2><p>对于UI，我们通常不需要考虑Gamma，因为UI是平面的，不涉及光照计算，直接使用美术绘制的图片就可以了。</p><p>但是有时候UI可能也在线性空间渲染，这个时候还是需要做转换</p><h1 id="Tonemapping-和-ACES"><a href="#Tonemapping-和-ACES" class="headerlink" title="Tonemapping 和 ACES"></a>Tonemapping 和 ACES</h1><h2 id="Tonemapping"><a href="#Tonemapping" class="headerlink" title="Tonemapping"></a>Tonemapping</h2><p>前面提到，图形API可以用超大范围的图片提交给操作系统，操作系统会进行空间转换，将图片转换为显示器支持的格式。</p><p>如果渲染时用的是HDR，但是显示器不支持HDR，只能显示[0,1]的范围，想要在LDR显示器上显示HDR图像，就需要进行Tonemapping（色调映射）。</p><p>Tonemapping的本质是将大范围压缩到小范围，这意味着要丢弃一些信息。要使用有限的颜色表达出需要的内容。</p><p>刚发明电影的时候，胶片能表达的亮度范围有限，所以摄影师会把高亮区域和阴影区域向中等亮度方向压缩，发展出了S曲线的映射关系。这些都是tone mapping。</p><p>Tonemapping有各种各样的算法（看着OK就OK），但是现在被ACES一统了</p><p><img src="/../img/aces_curve.png" alt="aces_curve.png"></p><h2 id="ACES"><a href="#ACES" class="headerlink" title="ACES"></a>ACES</h2><p>ACES(Academy Color Encoding System)是由美国电影艺术与科学学院（Academy of Motion Picture Arts and Sciences）开发的一个色彩管理系统，旨在提供一个统一的色彩空间和工作流程，以便在电影和电视制作中实现一致的色彩表现。</p><p>ACES本质是一个新的颜色空间，任意颜色空间都可以转到ACES颜色空间，ACES颜色空间可以转到任意颜色空间。<br>或者说它是一个通用的数据交换格式，一方面可以不同的输入设备转成ACES，另一方面可以把ACES在不同的显示设备上正确显示</p><p>可以看到 ACES2065-1直接把人眼看的到的看不到的颜色都包含了</p><p>管你什么颜色空间，统统到我最大的范围里来，重新算个RGB给你就是来<br><img src="/../img/aces.jpg" alt="aces.jpg"></p><h2 id="LUT"><a href="#LUT" class="headerlink" title="LUT"></a>LUT</h2><p>做Tonemapping需要进行曲线拟合（多项式计算），还是比较复杂的，尤其是对于实时渲染来说。<br>LUT（Look-Up Table）是一种预计算的表格，可以用来快速进行颜色转换和Tonemapping，只需要一次采样即可。<br><img src="/../img/lut.png" alt="lut.png"></p><p>[参考]</p><p><a href="https://zhuanlan.zhihu.com/p/21983679">https://zhuanlan.zhihu.com/p/21983679</a></p><p><a href="https://zhuanlan.zhihu.com/p/609569101">https://zhuanlan.zhihu.com/p/609569101</a></p><script>MathJax = {  tex: {    inlineMath: [['$', '$'], ['\\(', '\\)']]  }};</script><script id="MathJax-script" async  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>JoltPhysics</title>
    <link href="/2025/08/07/JoltPhysics/"/>
    <url>/2025/08/07/JoltPhysics/</url>
    
    <content type="html"><![CDATA[<h1 id="JoltPhysics"><a href="#JoltPhysics" class="headerlink" title="JoltPhysics"></a><a href="https://github.com/jrouwe/JoltPhysics">JoltPhysics</a></h1><p><img src="/../img/horizon_west.png" alt="horizon_west.png"></p><p>JoltPhysics 是一个高性能的物理引擎，专为游戏和实时应用设计。<br>它提供了丰富的功能，包括碰撞检测、刚体动力学、约束系统等。<br>JoltPhysics 的设计目标是提供高效且易于使用的物理模拟解决方案。</p><h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ul><li><strong>高性能</strong>：JoltPhysics 经过优化，能够处理大量物体的物理模拟，适用于大型场景和复杂交互。</li><li><strong>确定性</strong>：引擎提供确定性的物理模拟，确保在相同的输入下每次都能得到相同的结果。<ul><li>Level1:本机确定性</li><li>Level2:跨平台确定性</li></ul></li><li><strong>易于集成</strong>：提供了简单的 API，易于集成。</li><li><strong>跨平台支持</strong>：支持多种平台，包括 Windows、Linux 、Android、IOS 和 macOS</li><li><strong>丰富的功能</strong>：包括碰撞检测、刚体动力学、约束系统、粒子系统等</li><li><strong>开源</strong></li></ul><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>这里是官方的CPP示例代码，展示了如何使用 JoltPhysics 创建一个简单的物理世界</p><ul><li><p>ObjectLayerPairFilterTable </p><ul><li>首先我们要设置Layer，和Unity类似，新增一些层级，然后设置层级之间的碰撞关系</li></ul></li><li><p>BroadPhaseLayerInterfaceTable</p><ul><li>这一步是设置物理引擎的BroadPhase层级，BroadPhase层级是物理引擎中用于快速检测碰撞的层级结构</li></ul></li><li><p>MaxBodies</p><ul><li>设置物理引擎中最大刚体数量</li></ul></li><li><p>MaxBodyPairs</p><ul><li>设置物理引擎中最大刚体对数量</li></ul></li><li><p>MaxContactConstraints</p><ul><li>设置物理引擎中最大碰撞对和最大接触约束数量</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// Jolt Physics Library (https://github.com/jrouwe/JoltPhysics)</span><br><span class="hljs-comment">// SPDX-FileCopyrightText: 2025 Jorrit Rouwe</span><br><span class="hljs-comment">// SPDX-License-Identifier: CC0-1.0</span><br><span class="hljs-comment">// This file is in the public domain. It serves as an example to start building your own application using Jolt Physics. Feel free to copy paste without attribution!</span><br><br><span class="hljs-comment">// The Jolt headers don&#x27;t include Jolt.h. Always include Jolt.h before including any other Jolt header.</span><br><span class="hljs-comment">// You can use Jolt.h in your precompiled header to speed up compilation.</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Jolt/Jolt.h&gt;</span></span><br><br><span class="hljs-comment">// Jolt includes</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Jolt/RegisterTypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Jolt/Core/Factory.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Jolt/Core/TempAllocator.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Jolt/Core/JobSystemThreadPool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Jolt/Physics/PhysicsSettings.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Jolt/Physics/PhysicsSystem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Jolt/Physics/Collision/Shape/BoxShape.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Jolt/Physics/Collision/Shape/SphereShape.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Jolt/Physics/Body/BodyCreationSettings.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Jolt/Physics/Body/BodyActivationListener.h&gt;</span></span><br><br><span class="hljs-comment">// STL includes</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdarg&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><span class="hljs-comment">// Disable common warnings triggered by Jolt, you can use JPH_SUPPRESS_WARNING_PUSH / JPH_SUPPRESS_WARNING_POP to store and restore the warning state</span><br>JPH_SUPPRESS_WARNINGS<br><br><span class="hljs-comment">// All Jolt symbols are in the JPH namespace</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> JPH;<br><br><span class="hljs-comment">// If you want your code to compile using single or double precision write 0.0_r to get a Real value that compiles to double or float depending if JPH_DOUBLE_PRECISION is set or not.</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> JPH::literals;<br><br><span class="hljs-comment">// We&#x27;re also using STL classes in this example</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-comment">// Callback for traces, connect this to your own trace function if you have one</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">TraceImpl</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *inFMT, ...)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// Format the message</span><br>va_list list;<br><span class="hljs-built_in">va_start</span>(list, inFMT);<br><span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];<br><span class="hljs-built_in">vsnprintf</span>(buffer, <span class="hljs-built_in">sizeof</span>(buffer), inFMT, list);<br><span class="hljs-built_in">va_end</span>(list);<br><br><span class="hljs-comment">// Print to the TTY</span><br>cout &lt;&lt; buffer &lt;&lt; endl;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> JPH_ENABLE_ASSERTS</span><br><br><span class="hljs-comment">// Callback for asserts, connect this to your own assert handler if you have one</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">AssertFailedImpl</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *inExpression, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *inMessage, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *inFile, uint inLine)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// Print to the TTY</span><br>cout &lt;&lt; inFile &lt;&lt; <span class="hljs-string">&quot;:&quot;</span> &lt;&lt; inLine &lt;&lt; <span class="hljs-string">&quot;: (&quot;</span> &lt;&lt; inExpression &lt;&lt; <span class="hljs-string">&quot;) &quot;</span> &lt;&lt; (inMessage != <span class="hljs-literal">nullptr</span>? inMessage : <span class="hljs-string">&quot;&quot;</span>) &lt;&lt; endl;<br><br><span class="hljs-comment">// Breakpoint</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// JPH_ENABLE_ASSERTS</span></span><br><br><span class="hljs-comment">// Layer that objects can be in, determines which other objects it can collide with</span><br><span class="hljs-comment">// Typically you at least want to have 1 layer for moving bodies and 1 layer for static bodies, but you can have more</span><br><span class="hljs-comment">// layers if you want. E.g. you could have a layer for high detail collision (which is not used by the physics simulation</span><br><span class="hljs-comment">// but only if you do collision testing).</span><br><span class="hljs-keyword">namespace</span> Layers<br>&#123;<br><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> ObjectLayer NON_MOVING = <span class="hljs-number">0</span>;<br><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> ObjectLayer MOVING = <span class="hljs-number">1</span>;<br><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> ObjectLayer NUM_LAYERS = <span class="hljs-number">2</span>;<br>&#125;;<br><br><span class="hljs-comment">/// Class that determines if two object layers can collide</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectLayerPairFilterImpl</span> : <span class="hljs-keyword">public</span> ObjectLayerPairFilter<br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span><span class="hljs-title">ShouldCollide</span><span class="hljs-params">(ObjectLayer inObject1, ObjectLayer inObject2)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">switch</span> (inObject1)<br>&#123;<br><span class="hljs-keyword">case</span> Layers::NON_MOVING:<br><span class="hljs-keyword">return</span> inObject2 == Layers::MOVING; <span class="hljs-comment">// Non moving only collides with moving</span><br><span class="hljs-keyword">case</span> Layers::MOVING:<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// Moving collides with everything</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-built_in">JPH_ASSERT</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br>&#125;<br>&#125;;<br><br><span class="hljs-comment">// Each broadphase layer results in a separate bounding volume tree in the broad phase. You at least want to have</span><br><span class="hljs-comment">// a layer for non-moving and moving objects to avoid having to update a tree full of static objects every frame.</span><br><span class="hljs-comment">// You can have a 1-on-1 mapping between object layers and broadphase layers (like in this case) but if you have</span><br><span class="hljs-comment">// many object layers you&#x27;ll be creating many broad phase trees, which is not efficient. If you want to fine tune</span><br><span class="hljs-comment">// your broadphase layers define JPH_TRACK_BROADPHASE_STATS and look at the stats reported on the TTY.</span><br><span class="hljs-keyword">namespace</span> BroadPhaseLayers<br>&#123;<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> BroadPhaseLayer <span class="hljs-title">NON_MOVING</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> BroadPhaseLayer <span class="hljs-title">MOVING</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> uint <span class="hljs-title">NUM_LAYERS</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span>;<br>&#125;;<br><br><span class="hljs-comment">// BroadPhaseLayerInterface implementation</span><br><span class="hljs-comment">// This defines a mapping between object and broadphase layers.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BPLayerInterfaceImpl</span> <span class="hljs-keyword">final</span> : <span class="hljs-keyword">public</span> BroadPhaseLayerInterface<br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">BPLayerInterfaceImpl</span>()<br>&#123;<br><span class="hljs-comment">// Create a mapping table from object to broad phase layer</span><br>mObjectToBroadPhase[Layers::NON_MOVING] = BroadPhaseLayers::NON_MOVING;<br>mObjectToBroadPhase[Layers::MOVING] = BroadPhaseLayers::MOVING;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> uint<span class="hljs-title">GetNumBroadPhaseLayers</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> BroadPhaseLayers::NUM_LAYERS;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> BroadPhaseLayer<span class="hljs-title">GetBroadPhaseLayer</span><span class="hljs-params">(ObjectLayer inLayer)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">JPH_ASSERT</span>(inLayer &lt; Layers::NUM_LAYERS);<br><span class="hljs-keyword">return</span> mObjectToBroadPhase[inLayer];<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(JPH_EXTERNAL_PROFILE) || defined(JPH_PROFILE_ENABLED)</span><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title">GetBroadPhaseLayerName</span><span class="hljs-params">(BroadPhaseLayer inLayer)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">switch</span> ((BroadPhaseLayer::Type)inLayer)<br>&#123;<br><span class="hljs-built_in">case</span> (BroadPhaseLayer::Type)BroadPhaseLayers::NON_MOVING:<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;NON_MOVING&quot;</span>;<br><span class="hljs-built_in">case</span> (BroadPhaseLayer::Type)BroadPhaseLayers::MOVING:<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;MOVING&quot;</span>;<br><span class="hljs-keyword">default</span>:<span class="hljs-built_in">JPH_ASSERT</span>(<span class="hljs-literal">false</span>); <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;INVALID&quot;</span>;<br>&#125;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// JPH_EXTERNAL_PROFILE || JPH_PROFILE_ENABLED</span></span><br><br><span class="hljs-keyword">private</span>:<br>BroadPhaseLayermObjectToBroadPhase[Layers::NUM_LAYERS];<br>&#125;;<br><br><span class="hljs-comment">/// Class that determines if an object layer can collide with a broadphase layer</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectVsBroadPhaseLayerFilterImpl</span> : <span class="hljs-keyword">public</span> ObjectVsBroadPhaseLayerFilter<br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span><span class="hljs-title">ShouldCollide</span><span class="hljs-params">(ObjectLayer inLayer1, BroadPhaseLayer inLayer2)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">switch</span> (inLayer1)<br>&#123;<br><span class="hljs-keyword">case</span> Layers::NON_MOVING:<br><span class="hljs-keyword">return</span> inLayer2 == BroadPhaseLayers::MOVING;<br><span class="hljs-keyword">case</span> Layers::MOVING:<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-built_in">JPH_ASSERT</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br>&#125;<br>&#125;;<br><br><span class="hljs-comment">// An example contact listener</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyContactListener</span> : <span class="hljs-keyword">public</span> ContactListener<br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-comment">// See: ContactListener</span><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> ValidateResult<span class="hljs-title">OnContactValidate</span><span class="hljs-params">(<span class="hljs-type">const</span> Body &amp;inBody1, <span class="hljs-type">const</span> Body &amp;inBody2, RVec3Arg inBaseOffset, <span class="hljs-type">const</span> CollideShapeResult &amp;inCollisionResult)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;Contact validate callback&quot;</span> &lt;&lt; endl;<br><br><span class="hljs-comment">// Allows you to ignore a contact before it is created (using layers to not make objects collide is cheaper!)</span><br><span class="hljs-keyword">return</span> ValidateResult::AcceptAllContactsForThisBodyPair;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span><span class="hljs-title">OnContactAdded</span><span class="hljs-params">(<span class="hljs-type">const</span> Body &amp;inBody1, <span class="hljs-type">const</span> Body &amp;inBody2, <span class="hljs-type">const</span> ContactManifold &amp;inManifold, ContactSettings &amp;ioSettings)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;A contact was added&quot;</span> &lt;&lt; endl;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span><span class="hljs-title">OnContactPersisted</span><span class="hljs-params">(<span class="hljs-type">const</span> Body &amp;inBody1, <span class="hljs-type">const</span> Body &amp;inBody2, <span class="hljs-type">const</span> ContactManifold &amp;inManifold, ContactSettings &amp;ioSettings)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;A contact was persisted&quot;</span> &lt;&lt; endl;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span><span class="hljs-title">OnContactRemoved</span><span class="hljs-params">(<span class="hljs-type">const</span> SubShapeIDPair &amp;inSubShapePair)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;A contact was removed&quot;</span> &lt;&lt; endl;<br>&#125;<br>&#125;;<br><br><span class="hljs-comment">// An example activation listener</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBodyActivationListener</span> : <span class="hljs-keyword">public</span> BodyActivationListener<br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span><span class="hljs-title">OnBodyActivated</span><span class="hljs-params">(<span class="hljs-type">const</span> BodyID &amp;inBodyID, uint64 inBodyUserData)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;A body got activated&quot;</span> &lt;&lt; endl;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span><span class="hljs-title">OnBodyDeactivated</span><span class="hljs-params">(<span class="hljs-type">const</span> BodyID &amp;inBodyID, uint64 inBodyUserData)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;A body went to sleep&quot;</span> &lt;&lt; endl;<br>&#125;<br>&#125;;<br><br><span class="hljs-comment">// Program entry point</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// Register allocation hook. In this example we&#x27;ll just let Jolt use malloc / free but you can override these if you want (see Memory.h).</span><br><span class="hljs-comment">// This needs to be done before any other Jolt function is called.</span><br><span class="hljs-built_in">RegisterDefaultAllocator</span>();<br><br><span class="hljs-comment">// Install trace and assert callbacks</span><br>Trace = TraceImpl;<br><span class="hljs-built_in">JPH_IF_ENABLE_ASSERTS</span>(AssertFailed = AssertFailedImpl;)<br><br><span class="hljs-comment">// Create a factory, this class is responsible for creating instances of classes based on their name or hash and is mainly used for deserialization of saved data.</span><br><span class="hljs-comment">// It is not directly used in this example but still required.</span><br>Factory::sInstance = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Factory</span>();<br><br><span class="hljs-comment">// Register all physics types with the factory and install their collision handlers with the CollisionDispatch class.</span><br><span class="hljs-comment">// If you have your own custom shape types you probably need to register their handlers with the CollisionDispatch before calling this function.</span><br><span class="hljs-comment">// If you implement your own default material (PhysicsMaterial::sDefault) make sure to initialize it before this function or else this function will create one for you.</span><br><span class="hljs-built_in">RegisterTypes</span>();<br><br><span class="hljs-comment">// We need a temp allocator for temporary allocations during the physics update. We&#x27;re</span><br><span class="hljs-comment">// pre-allocating 10 MB to avoid having to do allocations during the physics update.</span><br><span class="hljs-comment">// B.t.w. 10 MB is way too much for this example but it is a typical value you can use.</span><br><span class="hljs-comment">// If you don&#x27;t want to pre-allocate you can also use TempAllocatorMalloc to fall back to</span><br><span class="hljs-comment">// malloc / free.</span><br><span class="hljs-function">TempAllocatorImpl <span class="hljs-title">temp_allocator</span><span class="hljs-params">(<span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)</span></span>;<br><br><span class="hljs-comment">// We need a job system that will execute physics jobs on multiple threads. Typically</span><br><span class="hljs-comment">// you would implement the JobSystem interface yourself and let Jolt Physics run on top</span><br><span class="hljs-comment">// of your own job scheduler. JobSystemThreadPool is an example implementation.</span><br><span class="hljs-function">JobSystemThreadPool <span class="hljs-title">job_system</span><span class="hljs-params">(cMaxPhysicsJobs, cMaxPhysicsBarriers, thread::hardware_concurrency() - <span class="hljs-number">1</span>)</span></span>;<br><br><span class="hljs-comment">// This is the max amount of rigid bodies that you can add to the physics system. If you try to add more you&#x27;ll get an error.</span><br><span class="hljs-comment">// Note: This value is low because this is a simple test. For a real project use something in the order of 65536.</span><br><span class="hljs-type">const</span> uint cMaxBodies = <span class="hljs-number">1024</span>;<br><br><span class="hljs-comment">// This determines how many mutexes to allocate to protect rigid bodies from concurrent access. Set it to 0 for the default settings.</span><br><span class="hljs-type">const</span> uint cNumBodyMutexes = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// This is the max amount of body pairs that can be queued at any time (the broad phase will detect overlapping</span><br><span class="hljs-comment">// body pairs based on their bounding boxes and will insert them into a queue for the narrowphase). If you make this buffer</span><br><span class="hljs-comment">// too small the queue will fill up and the broad phase jobs will start to do narrow phase work. This is slightly less efficient.</span><br><span class="hljs-comment">// Note: This value is low because this is a simple test. For a real project use something in the order of 65536.</span><br><span class="hljs-type">const</span> uint cMaxBodyPairs = <span class="hljs-number">1024</span>;<br><br><span class="hljs-comment">// This is the maximum size of the contact constraint buffer. If more contacts (collisions between bodies) are detected than this</span><br><span class="hljs-comment">// number then these contacts will be ignored and bodies will start interpenetrating / fall through the world.</span><br><span class="hljs-comment">// Note: This value is low because this is a simple test. For a real project use something in the order of 10240.</span><br><span class="hljs-type">const</span> uint cMaxContactConstraints = <span class="hljs-number">1024</span>;<br><br><span class="hljs-comment">// Create mapping table from object layer to broadphase layer</span><br><span class="hljs-comment">// Note: As this is an interface, PhysicsSystem will take a reference to this so this instance needs to stay alive!</span><br><span class="hljs-comment">// Also have a look at BroadPhaseLayerInterfaceTable or BroadPhaseLayerInterfaceMask for a simpler interface.</span><br>BPLayerInterfaceImpl broad_phase_layer_interface;<br><br><span class="hljs-comment">// Create class that filters object vs broadphase layers</span><br><span class="hljs-comment">// Note: As this is an interface, PhysicsSystem will take a reference to this so this instance needs to stay alive!</span><br><span class="hljs-comment">// Also have a look at ObjectVsBroadPhaseLayerFilterTable or ObjectVsBroadPhaseLayerFilterMask for a simpler interface.</span><br>ObjectVsBroadPhaseLayerFilterImpl object_vs_broadphase_layer_filter;<br><br><span class="hljs-comment">// Create class that filters object vs object layers</span><br><span class="hljs-comment">// Note: As this is an interface, PhysicsSystem will take a reference to this so this instance needs to stay alive!</span><br><span class="hljs-comment">// Also have a look at ObjectLayerPairFilterTable or ObjectLayerPairFilterMask for a simpler interface.</span><br>ObjectLayerPairFilterImpl object_vs_object_layer_filter;<br><br><span class="hljs-comment">// Now we can create the actual physics system.</span><br>PhysicsSystem physics_system;<br>physics_system.<span class="hljs-built_in">Init</span>(cMaxBodies, cNumBodyMutexes, cMaxBodyPairs, cMaxContactConstraints, broad_phase_layer_interface, object_vs_broadphase_layer_filter, object_vs_object_layer_filter);<br><br><span class="hljs-comment">// A body activation listener gets notified when bodies activate and go to sleep</span><br><span class="hljs-comment">// Note that this is called from a job so whatever you do here needs to be thread safe.</span><br><span class="hljs-comment">// Registering one is entirely optional.</span><br>MyBodyActivationListener body_activation_listener;<br>physics_system.<span class="hljs-built_in">SetBodyActivationListener</span>(&amp;body_activation_listener);<br><br><span class="hljs-comment">// A contact listener gets notified when bodies (are about to) collide, and when they separate again.</span><br><span class="hljs-comment">// Note that this is called from a job so whatever you do here needs to be thread safe.</span><br><span class="hljs-comment">// Registering one is entirely optional.</span><br>MyContactListener contact_listener;<br>physics_system.<span class="hljs-built_in">SetContactListener</span>(&amp;contact_listener);<br><br><span class="hljs-comment">// The main way to interact with the bodies in the physics system is through the body interface. There is a locking and a non-locking</span><br><span class="hljs-comment">// variant of this. We&#x27;re going to use the locking version (even though we&#x27;re not planning to access bodies from multiple threads)</span><br>BodyInterface &amp;body_interface = physics_system.<span class="hljs-built_in">GetBodyInterface</span>();<br><br><span class="hljs-comment">// Next we can create a rigid body to serve as the floor, we make a large box</span><br><span class="hljs-comment">// Create the settings for the collision volume (the shape).</span><br><span class="hljs-comment">// Note that for simple shapes (like boxes) you can also directly construct a BoxShape.</span><br><span class="hljs-function">BoxShapeSettings <span class="hljs-title">floor_shape_settings</span><span class="hljs-params">(Vec3(<span class="hljs-number">100.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">100.0f</span>))</span></span>;<br>floor_shape_settings.<span class="hljs-built_in">SetEmbedded</span>(); <span class="hljs-comment">// A ref counted object on the stack (base class RefTarget) should be marked as such to prevent it from being freed when its reference count goes to 0.</span><br><br><span class="hljs-comment">// Create the shape</span><br>ShapeSettings::ShapeResult floor_shape_result = floor_shape_settings.<span class="hljs-built_in">Create</span>();<br>ShapeRefC floor_shape = floor_shape_result.<span class="hljs-built_in">Get</span>(); <span class="hljs-comment">// We don&#x27;t expect an error here, but you can check floor_shape_result for HasError() / GetError()</span><br><br><span class="hljs-comment">// Create the settings for the body itself. Note that here you can also set other properties like the restitution / friction.</span><br><span class="hljs-function">BodyCreationSettings <span class="hljs-title">floor_settings</span><span class="hljs-params">(floor_shape, RVec3(<span class="hljs-number">0.0</span>_r, <span class="hljs-number">-1.0</span>_r, <span class="hljs-number">0.0</span>_r), Quat::sIdentity(), EMotionType::Static, Layers::NON_MOVING)</span></span>;<br><br><span class="hljs-comment">// Create the actual rigid body</span><br>Body *floor = body_interface.<span class="hljs-built_in">CreateBody</span>(floor_settings); <span class="hljs-comment">// Note that if we run out of bodies this can return nullptr</span><br><br><span class="hljs-comment">// Add it to the world</span><br>body_interface.<span class="hljs-built_in">AddBody</span>(floor-&gt;<span class="hljs-built_in">GetID</span>(), EActivation::DontActivate);<br><br><span class="hljs-comment">// Now create a dynamic body to bounce on the floor</span><br><span class="hljs-comment">// Note that this uses the shorthand version of creating and adding a body to the world</span><br><span class="hljs-function">BodyCreationSettings <span class="hljs-title">sphere_settings</span><span class="hljs-params">(<span class="hljs-keyword">new</span> SphereShape(<span class="hljs-number">0.5f</span>), RVec3(<span class="hljs-number">0.0</span>_r, <span class="hljs-number">2.0</span>_r, <span class="hljs-number">0.0</span>_r), Quat::sIdentity(), EMotionType::Dynamic, Layers::MOVING)</span></span>;<br>BodyID sphere_id = body_interface.<span class="hljs-built_in">CreateAndAddBody</span>(sphere_settings, EActivation::Activate);<br><br><span class="hljs-comment">// Now you can interact with the dynamic body, in this case we&#x27;re going to give it a velocity.</span><br><span class="hljs-comment">// (note that if we had used CreateBody then we could have set the velocity straight on the body before adding it to the physics system)</span><br>body_interface.<span class="hljs-built_in">SetLinearVelocity</span>(sphere_id, <span class="hljs-built_in">Vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">-5.0f</span>, <span class="hljs-number">0.0f</span>));<br><br><span class="hljs-comment">// We simulate the physics world in discrete time steps. 60 Hz is a good rate to update the physics system.</span><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> cDeltaTime = <span class="hljs-number">1.0f</span> / <span class="hljs-number">60.0f</span>;<br><br><span class="hljs-comment">// Optional step: Before starting the physics simulation you can optimize the broad phase. This improves collision detection performance (it&#x27;s pointless here because we only have 2 bodies).</span><br><span class="hljs-comment">// You should definitely not call this every frame or when e.g. streaming in a new level section as it is an expensive operation.</span><br><span class="hljs-comment">// Instead insert all new objects in batches instead of 1 at a time to keep the broad phase efficient.</span><br>physics_system.<span class="hljs-built_in">OptimizeBroadPhase</span>();<br><br><span class="hljs-comment">// Now we&#x27;re ready to simulate the body, keep simulating until it goes to sleep</span><br>uint step = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">while</span> (body_interface.<span class="hljs-built_in">IsActive</span>(sphere_id))<br>&#123;<br><span class="hljs-comment">// Next step</span><br>++step;<br><br><span class="hljs-comment">// Output current position and velocity of the sphere</span><br>RVec3 position = body_interface.<span class="hljs-built_in">GetCenterOfMassPosition</span>(sphere_id);<br>Vec3 velocity = body_interface.<span class="hljs-built_in">GetLinearVelocity</span>(sphere_id);<br>cout &lt;&lt; <span class="hljs-string">&quot;Step &quot;</span> &lt;&lt; step &lt;&lt; <span class="hljs-string">&quot;: Position = (&quot;</span> &lt;&lt; position.<span class="hljs-built_in">GetX</span>() &lt;&lt; <span class="hljs-string">&quot;, &quot;</span> &lt;&lt; position.<span class="hljs-built_in">GetY</span>() &lt;&lt; <span class="hljs-string">&quot;, &quot;</span> &lt;&lt; position.<span class="hljs-built_in">GetZ</span>() &lt;&lt; <span class="hljs-string">&quot;), Velocity = (&quot;</span> &lt;&lt; velocity.<span class="hljs-built_in">GetX</span>() &lt;&lt; <span class="hljs-string">&quot;, &quot;</span> &lt;&lt; velocity.<span class="hljs-built_in">GetY</span>() &lt;&lt; <span class="hljs-string">&quot;, &quot;</span> &lt;&lt; velocity.<span class="hljs-built_in">GetZ</span>() &lt;&lt; <span class="hljs-string">&quot;)&quot;</span> &lt;&lt; endl;<br><br><span class="hljs-comment">// If you take larger steps than 1 / 60th of a second you need to do multiple collision steps in order to keep the simulation stable. Do 1 collision step per 1 / 60th of a second (round up).</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> cCollisionSteps = <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">// Step the world</span><br>physics_system.<span class="hljs-built_in">Update</span>(cDeltaTime, cCollisionSteps, &amp;temp_allocator, &amp;job_system);<br>&#125;<br><br><span class="hljs-comment">// Remove the sphere from the physics system. Note that the sphere itself keeps all of its state and can be re-added at any time.</span><br>body_interface.<span class="hljs-built_in">RemoveBody</span>(sphere_id);<br><br><span class="hljs-comment">// Destroy the sphere. After this the sphere ID is no longer valid.</span><br>body_interface.<span class="hljs-built_in">DestroyBody</span>(sphere_id);<br><br><span class="hljs-comment">// Remove and destroy the floor</span><br>body_interface.<span class="hljs-built_in">RemoveBody</span>(floor-&gt;<span class="hljs-built_in">GetID</span>());<br>body_interface.<span class="hljs-built_in">DestroyBody</span>(floor-&gt;<span class="hljs-built_in">GetID</span>());<br><br><span class="hljs-comment">// Unregisters all types with the factory and cleans up the default material</span><br><span class="hljs-built_in">UnregisterTypes</span>();<br><br><span class="hljs-comment">// Destroy the factory</span><br><span class="hljs-keyword">delete</span> Factory::sInstance;<br>Factory::sInstance = <span class="hljs-literal">nullptr</span>;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="CSharp-绑定"><a href="#CSharp-绑定" class="headerlink" title="CSharp 绑定"></a>CSharp 绑定</h2><p>JoltPhysics 提供了各种语言的绑定，包括 C#、C++、Python 等。</p><p><a href="https://github.com/NicoIer/JoltPhysicsSharp.git">JoltPhysics CSharp</a>这个第三方库提供了 JoltPhysics 的 C# 绑定<br>使得我们用C#做服务器运行3D物理模拟成为可能，Unity 7 将会使用Core CLR替代Mono，这意味着Unity 7 可以无缝使用Jolt Physics CSharp</p><h3 id="JoltPhysics-尝试"><a href="#JoltPhysics-尝试" class="headerlink" title="JoltPhysics 尝试"></a>JoltPhysics 尝试</h3><p>最近我尝试在C#服务器运行JoltPhysics，Unity作为渲染客户端，制作了一个简单的足球游戏<br><a href="https://github.com/NicoIer/GameServer.git">https://github.com/NicoIer/GameServer.git</a></p><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="//player.bilibili.com/player.html?isOutside=true&aid=114987464924745&bvid=BV1pztzzTEmp&cid=31548440872&p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe></div>]]></content>
    
    
    
    <tags>
      
      <tag>物理引擎</tag>
      
      <tag>JoltPhysics</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>离屏渲染</title>
    <link href="/2025/08/07/%E7%A6%BB%E5%B1%8F%E6%B8%B2%E6%9F%93/"/>
    <url>/2025/08/07/%E7%A6%BB%E5%B1%8F%E6%B8%B2%E6%9F%93/</url>
    
    <content type="html"><![CDATA[<h1 id="离屏渲染"><a href="#离屏渲染" class="headerlink" title="离屏渲染"></a>离屏渲染</h1><p>Offscreen Rendering（离屏渲染）是一种在不直接显示到屏幕上的缓冲区中进行图形渲染的技术。</p><p>说白了就是RenderTarget不是屏幕，而是一个纹理或者一个缓冲区。</p>]]></content>
    
    
    
    <tags>
      
      <tag>图形学</tag>
      
      <tag>渲染</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>为什么会产生锯齿</title>
    <link href="/2025/08/07/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E4%BA%A7%E7%94%9F%E9%94%AF%E9%BD%BF/"/>
    <url>/2025/08/07/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E4%BA%A7%E7%94%9F%E9%94%AF%E9%BD%BF/</url>
    
    <content type="html"><![CDATA[<p>在计算机图形学中，锯齿现象通常是由于分辨率限制和采样不足引起的。当我们在屏幕上渲染图像时，图像是由离散的像素组成的，而不是连续的。这种离散性导致了边缘处的阶梯状效果，即锯齿。</p><p>锯齿现象的主要原因包括：</p><ul><li>分辨率限制：当图像的分辨率较低时，细节无法被充分表达，导致边缘看起来不平滑。</li><li>采样不足：在渲染过程中，如果对图像进行的采样次数不足，尤其是在边缘区域，可能会导致锯齿现象更加明显。</li><li>几何形状的离散化：在3D渲染中，复杂的几何形状被近似为多边形网格，这种近似也会导致边缘出现锯齿。</li></ul><p>抗锯齿：</p><ul><li>MSAA（多重采样抗锯齿）：通过对每个像素进行多次采样，然后对结果进行平均，来减少锯齿现象。</li><li>FXAA（快速近似抗锯齿）：一种后处理技术，通过模糊边缘来减少锯齿。</li><li>SSAA（超采样抗锯齿）：以更高的分辨率渲染图像，然后缩小到目标分辨率，从而减少锯齿。</li><li>TAA（时间抗锯齿）：利用时间上的信息，通过对多帧图像进行混合来减少锯齿。</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>图形学</tag>
      
      <tag>锯齿</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>通过Pre-Z减少AlphaClip绘制的开销</title>
    <link href="/2025/08/07/%E9%80%9A%E8%BF%87Pre-Z%E5%87%8F%E5%B0%91AlphaClip%E7%BB%98%E5%88%B6%E7%9A%84%E5%BC%80%E9%94%80/"/>
    <url>/2025/08/07/%E9%80%9A%E8%BF%87Pre-Z%E5%87%8F%E5%B0%91AlphaClip%E7%BB%98%E5%88%B6%E7%9A%84%E5%BC%80%E9%94%80/</url>
    
    <content type="html"><![CDATA[<h1 id="手机上AlphaClip为什么会很卡"><a href="#手机上AlphaClip为什么会很卡" class="headerlink" title="手机上AlphaClip为什么会很卡"></a>手机上AlphaClip为什么会很卡</h1><p>本质上是由于 OverDraw （过度绘制）引起的。AlphaClip 会丢弃像素，但这些像素在片元着色器阶段之前已经被处理过了，因此仍然会消耗 GPU 资源。尤其是在移动设备上，GPU 资源有限，过度绘制会导致性能下降。</p><h1 id="Pre-Z优化方案"><a href="#Pre-Z优化方案" class="headerlink" title="Pre-Z优化方案"></a>Pre-Z优化方案</h1><ul><li>再Opaque绘制之前，先绘制一遍AlphaClip的物体，只进行深度写入</li><li>在AlphaClip绘制时，开启深度测试 ZTest Equal （只有深度值相等的像素才会被绘制）</li><li>没有被丢弃的像素就不会进入片元着色器阶段，从而减少了GPU的负担</li></ul><p>Unity中可以使用RenderObjects实现一次Pre-Z绘制</p><p>然后在自己的AlphaClip Shader中开启ZTest Equal</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shaderlab">ZTest Equal<br></code></pre></td></tr></table></figure><h1 id="代价"><a href="#代价" class="headerlink" title="代价"></a>代价</h1><p>代价就是所有的AlphaClip物体都需要绘制两次，一次Pre-Z，一次正常绘制。</p>]]></content>
    
    
    <categories>
      
      <category>Shader</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>Shader</tag>
      
      <tag>Pre-Z</tag>
      
      <tag>AlphaClip</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity-LightProbe导致的性能异常问题</title>
    <link href="/2025/08/07/Unity-LightProbe%E5%AF%BC%E8%87%B4%E7%9A%84%E6%80%A7%E8%83%BD%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/"/>
    <url>/2025/08/07/Unity-LightProbe%E5%AF%BC%E8%87%B4%E7%9A%84%E6%80%A7%E8%83%BD%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>使用LightProbe烘焙间接光时，主要是有一些LightProbe的点出现了穿插，导致在运行时计算插值时出现了大量的计算开销，从而导致性能异常。</p><p>解决方案是让Probe不要出现穿插，避免计算时因为两个点之间存在Mesh导致计算开销过大以及错误结果</p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>LightProbe</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>图形学中的坐标变换</title>
    <link href="/2025/08/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E4%B8%AD%E7%9A%84%E5%9D%90%E6%A0%87%E5%8F%98%E6%8D%A2/"/>
    <url>/2025/08/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E4%B8%AD%E7%9A%84%E5%9D%90%E6%A0%87%E5%8F%98%E6%8D%A2/</url>
    
    <content type="html"><![CDATA[<p>在图形学中，坐标变换是一个核心概念，它涉及将点或对象从一个坐标系转换到另一个坐标系。常见的坐标系包括局部坐标系、世界坐标系和视图坐标系。</p><p>对于一个模型，我们通常会定义它在局部坐标系中的位置和方向。通过应用一系列变换矩阵（如平移、旋转和缩放），我们可以将模型从局部坐标系转换到世界坐标系。这些变换矩阵通常以4x4矩阵的形式表示，以便处理齐次坐标。</p><p>例如，假设我们有一个点P在局部坐标系中的位置为(1, 2, 3)。如果我们想将这个点转换到世界坐标系中，我们需要应用一个变换矩阵M，该矩阵可能包括平移、旋转和缩放操作。通过矩阵乘法，我们可以得到点P在世界坐标系中的新位置P’。</p><p>P’ &#x3D; M * P</p><p>此外，视图坐标系通常用于表示摄像机的视角。为了将点从世界坐标系转换到视图坐标系，我们需要应用一个视图变换矩阵V。这个矩阵通常是摄像机的位置和方向的函数。</p><p>P’’ &#x3D; V * P’</p><p>这就是我们常说的M V P变换链。在实际应用中，这些变换通常会被组合成一个单一的矩阵，以提高计算效率。</p>]]></content>
    
    
    
    <tags>
      
      <tag>图形学</tag>
      
      <tag>坐标变换</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>通过CommandBuffer绘制小地图</title>
    <link href="/2025/08/07/%E9%80%9A%E8%BF%87CommandBuffer%E7%BB%98%E5%88%B6%E5%B0%8F%E5%9C%B0%E5%9B%BE/"/>
    <url>/2025/08/07/%E9%80%9A%E8%BF%87CommandBuffer%E7%BB%98%E5%88%B6%E5%B0%8F%E5%9C%B0%E5%9B%BE/</url>
    
    <content type="html"><![CDATA[<p>最近在做小地图的优化方案， 原先的方案很常见：</p><p>为目标物体在场景内很远的位置生成一个SpriteRenderer代理，使用一个小地图相机在对应位置拍摄，</p><p>小地图相机的渲染目标是一张正方形的RT，RT会作为UI上一个RawImage的纹理。</p><p>通过Camera-&gt;RT-&gt;RawImage的方式，最终在UI上显示小地图。</p><p>这样的做法有几个问题：</p><ul><li>需要额外一个Camera，需要完整走Camera的渲染流程，有一些流程无法跳过，比如剔除、渲染排序等，这些都会影响性能</li><li>需要额外一张RT，增加了带宽开销，这在低端机几乎是不可接受的</li></ul><p>然后是新的方案，将小地图绘制插入到UI绘制流程中，使用CommandBuffer在UI绘制目标上绘制小地图（通常是直接绘制到屏幕）。<br>这样就可以避免额外的Camera和RT开销。</p><ul><li>首先要收集需要绘制的物体</li><li>然后收集投影矩阵</li><li>进行Viewport转换，计算绘制位置</li><li>在限制的区域内绘制</li></ul><p>第一步直接使用原方案中的SpriteRenderer代理</p><p>第二步直接使用原方案中的小地图相机的投影矩阵（只不过这次要禁用掉Camera，只使用矩阵数据）</p><p>第三步因为我们的绘制目标是UI的绘制目标，这里以1920<em>1080为例，实际上我们要绘制的目标是1920</em>1080中的一小部分区域，因此需要做Viewport转换。</p><p>假设小地图的尺寸是Vector2 size，小地图正方形的左上角距离屏幕左上角是Vector2 offset,那么Viewport转换就是：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">var</span> viewport = <span class="hljs-keyword">new</span> Rect(<span class="hljs-number">0</span>,Screen.height - size.x, size.x, size.y);<br>viewport.x += offset.x;<br>viewport.y -= offset.y;<br><br><span class="hljs-built_in">float</span> targetAspect = size.x / size.y;<br><span class="hljs-built_in">float</span> screenAspect = Screen.width / (<span class="hljs-built_in">float</span>)Screen.height;<br><br><span class="hljs-keyword">if</span> (Math.Abs(screenAspect - targetAspect)&gt;<span class="hljs-number">0.01f</span>)`<br>&#123;<br>    <span class="hljs-comment">// 屏幕宽度大于小地图宽高比，计算缩放比例</span><br>    <span class="hljs-built_in">float</span> scale = screenAspect / targetAspect;<br>    viewport.width *= scale;<br>&#125;<br>   <br></code></pre></td></tr></table></figure><p>第四步需要重写一下Sprite-Default的Shader，在Frag里限制绘制区域（这一步也可以Stencil实现)<br>只考虑Screen.x &gt; Screen.y的情况，圆形中心在屏幕中心uv(0.5,0.5)，半径的像素数量为Screen.y &#x2F;2，直接用0.5uv作为半径会导致结果并不是圆形，而是椭圆，因为Screen.x!&#x3D;Screen.y，所以需要对X坐标进行缩放。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shaderlab"><br>Varyings Vert(Attributes v)<br>&#123;<br>    // ......<br>    o.screenPos =  ComputeScreenPos(o.positionCS);<br>    o.color = v.color * _Color * _RendererColor;<br>    // ......<br>    return o;<br>&#125;<br>half4 Frag(Varyings i) : SV_Target<br>&#123;<br>    // ......<br>    float2 center = float2(0.5, 0.5);<br>    float aspect = _ScreenParams.x / _ScreenParams.y;<br>    float2 pixelUv = i.screenPos.xy / i.screenPos.w;<br>    pixelUv.x = (pixelUv.x - center.x) * aspect + center.x; // Adjust for aspect ratio<br>    if (length(pixelUv - center) &gt; 0.5)<br>    &#123;<br>        // If the pixel is outside the circle, discard it.<br>        discard;<br>    &#125;<br>    // ......<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>Shader</tag>
      
      <tag>CommandBuffer</tag>
      
      <tag>小地图</tag>
      
      <tag>Mask</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity-ShadowDistance问题</title>
    <link href="/2025/08/01/Unity-ShadowDistance%E9%97%AE%E9%A2%98/"/>
    <url>/2025/08/01/Unity-ShadowDistance%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h2 id="ShadowMap精度"><a href="#ShadowMap精度" class="headerlink" title="ShadowMap精度"></a>ShadowMap精度</h2><p>先说结论: Unity中的阴影距离实际上是 near plane + shadow distance</p><p>观察下面两种ShadowMap</p><ul><li>左边: neap plane &#x3D; 0.01 , shadow distance &#x3D; 4.39</li><li>右边: neap plane &#x3D; 2.36 , shadow distance &#x3D; 4.39</li></ul><p>可以明显看出左边的人物阴影区域更大， 说明距离的更近了</p><p><img src="/../img/unity_shadow_mask_compare.png" alt="unity_shadow_mask_compare.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>Shader</tag>
      
      <tag>阴影</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSharp结构体中引用类型初始化问题</title>
    <link href="/2025/07/29/CSharp%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%AD%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E5%88%9D%E5%A7%8B%E5%8C%96%E9%97%AE%E9%A2%98/"/>
    <url>/2025/07/29/CSharp%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%AD%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E5%88%9D%E5%A7%8B%E5%8C%96%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>初始化struct&#x2F;class里的List时，第二种写法会报nullref</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> MyStruct<br>&#123;<br>    <span class="hljs-keyword">public</span> List&lt;<span class="hljs-built_in">int</span>&gt; MyList1;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyStruct</span>()</span><br>    &#123;<br>    &#125;<br>&#125;<br><br><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span><br>&#123;<br>    <span class="hljs-comment">// 第一种写法，正常</span><br>    MyStruct s1 = <span class="hljs-keyword">new</span> MyStruct()<br>    &#123;<br>        MyList1 = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt; &#123; <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 第二种写法，报错</span><br>    MyStruct s2 = <span class="hljs-keyword">new</span> MyStruct()<br>    &#123;<br>        MyList1 = &#123; <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>观察编译后的IL代码，第一种写法会调用List的构造函数，而第二种写法则是直接对MyList1进行赋值。<br>在C#中，结构体（struct）和类（class）在初始化时有一些细微的差别。特别是在处理引用类型字段时，这种差异可能会导致一些意想不到的错误。</p><p><img src="/../img/csharp-ctor-struct-issue.jpg" alt="csharp-ctor-struct-issue.jpg"></p>]]></content>
    
    
    
    <tags>
      
      <tag>CSharp</tag>
      
      <tag>IL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity场景Lightmap是否存在</title>
    <link href="/2025/07/22/Unity%E5%9C%BA%E6%99%AFLightmap%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8/"/>
    <url>/2025/07/22/Unity%E5%9C%BA%E6%99%AFLightmap%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="Unity场景Lightmap是否存在"><a href="#Unity场景Lightmap是否存在" class="headerlink" title="Unity场景Lightmap是否存在"></a>Unity场景Lightmap是否存在</h2><p>判断当前激活的场景是否存在Lightmap，可以通过以下代码实现：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">var</span> dataAsset = Lightmapping.lightDataAsset;<br><span class="hljs-keyword">if</span>(dataAsset != <span class="hljs-literal">null</span> &amp;&amp; dataAsset.lightmaps != <span class="hljs-literal">null</span> &amp;&amp; dataAsset.lightmaps.Length &gt; <span class="hljs-number">0</span>)<br>&#123;<br>    Debug.Log(<span class="hljs-string">&quot;Lightmap exists in the scene.&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    Debug.Log(<span class="hljs-string">&quot;No Lightmap found in the scene.&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>通常，在美术对场景编辑后，会有一系列处理流程，通过检查Lightmap的存在，可以确保场景的光照效果已经被正确烘焙。<br>结合自动化测试，可以在场景加载时自动检查Lightmap的存在性，确保场景的光照效果符合预期。</p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>Lightmap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity-Bloom-锯齿优化</title>
    <link href="/2025/07/15/Unity-Bloom-%E9%94%AF%E9%BD%BF%E4%BC%98%E5%8C%96/"/>
    <url>/2025/07/15/Unity-Bloom-%E9%94%AF%E9%BD%BF%E4%BC%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<p>Unity Bloom在降采样和上采样时使用的卷积核如下，是一个十字型的卷积核，这样会丢掉四个角落的像素信息，导致锯齿现象。<br>我们在上采样时,使用一个X型的卷积核心，将丢失的信息补充回来即可</p><span><p>$$<br>\begin{bmatrix}<br>0 &amp; 1 &amp; 0 \<br>1 &amp; 1 &amp; 1 \<br>0 &amp; 1 &amp; 0<br>\end{bmatrix}<br>$$<br></span></p><span><p>$$<br>\begin{bmatrix}<br>1 &amp; 0 &amp; 1 \<br>0 &amp; 1 &amp; 0 \<br>1 &amp; 0 &amp; 1<br>\end{bmatrix}<br>$$<br></span></p><p>这样做没有什么理论依据，但是效果很好</p><script>MathJax = {  tex: {    inlineMath: [['$', '$'], ['\\(', '\\)']]  }};</script><script id="MathJax-script" async  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>Shader</tag>
      
      <tag>后处理</tag>
      
      <tag>Bloom</tag>
      
      <tag>锯齿</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FMOD-Unity-Settings</title>
    <link href="/2025/07/10/FMOD-Unity-Settings/"/>
    <url>/2025/07/10/FMOD-Unity-Settings/</url>
    
    <content type="html"><![CDATA[<h1 id="FMOD-Unity-Settings"><a href="#FMOD-Unity-Settings" class="headerlink" title="FMOD Unity Settings"></a>FMOD Unity Settings</h1><p><a href="https://fmod.com/docs/2.03/unity/settings.html">官方文档</a></p><p>FMOD作为一个跨平台的音频引擎，在深度使用中经常会遇到一些手机上出现，电脑上无法复现的问题。<br>这里记录一下一些比较重要的配置，可以解决一些问题。</p><p><img src="/../img/FMOD%20Settings.png" alt="FMOD Settings.png"></p><h2 id="Platform-Specific-Android"><a href="#Platform-Specific-Android" class="headerlink" title="Platform Specific &#x2F; Android"></a>Platform Specific &#x2F; Android</h2><ul><li><p>OutputMode 这个选项是选择不同平台下使用的底层音频输出API</p><ul><li>Auto 这个选项会根据平台自动选择</li><li>No Sound 这个选项会禁用音频输出</li><li>Wav Writer 这个选项会将音频输出写入WAV文件</li><li>Java AudioTrack 这个选项会使用Android的AudioTrack API进行音频输出</li><li>OpenSL ES 这个选项会使用Android的OpenSL ES API进行音频输出</li><li>AAudio 这个选项会使用Android的AAudio API进行音频输出</li></ul></li><li><p>Virtual Channel Count &amp; Real Channel Count 这两个选项是设置Android平台下的虚拟通道数和实际通道数。<br>虚拟通道数是指FMOD内部使用的通道数，实际通道数是指Android系统实际使用的通道数。<br>一般情况下，虚拟通道数应该大于等于实际通道数。Virtual Channel Count 是指可以播放的通道数，一旦超过了实际通道数，最安静的通道将被虚拟化，即不可听见。<br>Real Channel Count 是指实际可听见的通道数。降低这个计数将减少 FMOD 混音器的 CPU 使用率。<br>但是请注意，降低通道数可能会导致音频质量下降，或者在某些情况下，音频可能会被截断或丢失。</p></li></ul><h2 id="声音丢失问题排查"><a href="#声音丢失问题排查" class="headerlink" title="声音丢失问题排查"></a>声音丢失问题排查</h2><ul><li>声音到底有没有播放？</li><li>声音播放之后，有没有又被停止、暂停了？</li><li>声音的位置是什么（如果是3d声音的话，2d声音不用管位置信息），耳朵的位置是多少？是否超出了音源的半径？</li><li>声音播放了，其音量多少呢？是不是有代码将其音量又设置为0了？</li><li>是否超出了配置&#x2F;硬件的Channel Count限制？如果超过了限制，FMOD会自动将最安静的通道虚拟化，即不可听见。<ul><li>这种时候要在FMOD Studio中设置优先级 </li><li>减少同时播放的音频数量<br>所以从，发生源，耳朵，两者距离，音量大小，是否静音了，等几个方面着手，去解决音频听不到的问题。</li></ul></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>FMOD</tag>
      
      <tag>音频</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FMOD Unity 资源加载</title>
    <link href="/2025/07/07/FMOD-Unity-%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD/"/>
    <url>/2025/07/07/FMOD-Unity-%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD/</url>
    
    <content type="html"><![CDATA[<h1 id="FMOD-Unity-资源加载"><a href="#FMOD-Unity-资源加载" class="headerlink" title="FMOD Unity 资源加载"></a>FMOD Unity 资源加载</h1><p>FMOD 是一个强大的音频引擎，广泛应用于游戏开发中。Unity 中使用 FMOD 时，资源的加载和管理是一个重要的环节。以下是一些关于 FMOD 在 Unity 中资源加载的基本知识。</p><h2 id="FMOD-Unity-资源加载-1"><a href="#FMOD-Unity-资源加载-1" class="headerlink" title="FMOD Unity 资源加载"></a>FMOD Unity 资源加载</h2><h3 id="默认资源加载方式"><a href="#默认资源加载方式" class="headerlink" title="默认资源加载方式"></a>默认资源加载方式</h3><p>FMOD For Unity的默认资源加载方式是 StreamingAssets。<br>在Unity Build时会将 “.bank” 文件 自动拷贝到 StreamingAssets 文件夹中。<br>它在游戏初始化的时候根据路径去SteamingAssets文件夹中加载音频资源。</p><h3 id="运行时加载"><a href="#运行时加载" class="headerlink" title="运行时加载"></a>运行时加载</h3><p>如果需要在运行时动态加载音频资源，可以使用 FMOD 的 API 来实现。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs csharp">RuntimeManager.LoadBank(<span class="hljs-string">&quot;path/to/bank.bank&quot;</span>, <span class="hljs-literal">true</span>);<br>RuntimeManager.LoadBank(<span class="hljs-string">&quot;path/to/bank.bytes&quot;</span>, <span class="hljs-literal">true</span>);<br><br>TextAsset textAsset = Resources.Load&lt;TextAsset&gt;(<span class="hljs-string">&quot;path/to/bank&quot;</span>);<br>RuntimeManager.LoadBank(textAsset, <span class="hljs-literal">true</span>);<br><br></code></pre></td></tr></table></figure><h2 id="AssetBundle-加载"><a href="#AssetBundle-加载" class="headerlink" title="AssetBundle 加载"></a>AssetBundle 加载</h2><p>如果我们的游戏需要资源热更新，那么默认的 StreamingAssets 方式就不适用了。</p><ol><li>在FMOD Editor Settings 中 修改加载方式为 AssetBundle</li><li>FMOD会自动根据.bank文件生成对应的 “.bytes” 文件。<br>这些 “.bytes” 文件包含了音频数据和相关信息，可以在 Unity 中使用。</li><li>在Unity中创建一个AssetBundle，包含FMOD生成的 “.bytes” 文件。</li><li>在游戏运行时，通过 Unity 的 AssetBundle API 加载这些 “.bytes” 文件。</li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp">AssetBundle assetBundle = AssetBundle.LoadFromFile(<span class="hljs-string">&quot;path/to/assetbundle&quot;</span>);<br>TextAssetk textAsset = assetBundle.LoadAsset&lt;TextAsset&gt;(<span class="hljs-string">&quot;bank.bytes&quot;</span>);<br>FMODUnity.RuntimeManager.LoadBank(bank, <span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>FMOD</tag>
      
      <tag>音频</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity Shader LOD</title>
    <link href="/2025/05/22/Unity-Shader-LOD/"/>
    <url>/2025/05/22/Unity-Shader-LOD/</url>
    
    <content type="html"><![CDATA[<h1 id="Shader-LOD"><a href="#Shader-LOD" class="headerlink" title="Shader LOD"></a>Shader LOD</h1><p>在移动端游戏上，常常会做很多优化工作，来让游戏在设备上流畅运行。<br>一般的方案有：降低模型的复杂度，降低纹理的分辨率，降低模型的LOD（Level of Detail）等。</p><p>针对不同的设备还有有画质分级</p><p>这里要讲的是Shader LOD:<br><a href="https://docs.unity.cn/cn/2022.3/Manual/SL-ShaderLOD.html">https://docs.unity.cn/cn/2022.3/Manual/SL-ShaderLOD.html</a></p><h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs csharp">Shader myShader = Shader.Find(<span class="hljs-string">&quot;MyShader&quot;</span>); <span class="hljs-comment">// 任何可以获得Shader对象的方法</span><br>myShader.maximumLOD = <span class="hljs-number">-1</span>; <span class="hljs-comment">// 设置LOD为-1，表示能多大用多大</span><br><br>myShader.maximumLOD = <span class="hljs-number">100</span>; <span class="hljs-comment">// 设置LOD为100，表示只能使用LOD &lt;=100的Shader</span><br><br>myShader.maximumLOD = <span class="hljs-number">10</span>; <span class="hljs-comment">// 设置LOD为10，表示只能使用LOD &lt;=10的Shader</span><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shaderlab">Shader &quot;MyShader&quot;<br>&#123;<br>    // ... 其他的Shader内容...<br>    SubShader<br>    &#123;<br>        LOD 100<br>        <br>    // ... 其他的SubShader内容...    <br>    &#125;<br>    SubShader<br>    &#123;<br>        LOD 10<br>        <br>    // ... 其他的SubShader内容...    <br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h2><p>Shader LOD（Level of Detail）用于在不同的设备上使用不同的Shader版本，以优化性能和视觉效果。通过设置LOD值，Unity可以根据设备的性能自动选择合适的Shader版本，从而提高渲染效率。</p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>Shader</tag>
      
      <tag>性能优化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSharp深拷贝的ExpressionTree实现</title>
    <link href="/2024/08/31/CSharp%E6%B7%B1%E6%8B%B7%E8%B4%9D%E7%9A%84ExpressionTree%E5%AE%9E%E7%8E%B0/"/>
    <url>/2024/08/31/CSharp%E6%B7%B1%E6%8B%B7%E8%B4%9D%E7%9A%84ExpressionTree%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h1><p>C#中默认的拷贝是浅拷贝，浅拷贝只会复制对象的引用，而不会复制对象本身。深拷贝则会复制对象本身及其所有引用的对象。</p><p>有时候我们希望拷贝的对象不要影响原始对象，这时就需要使用深拷贝。深拷贝可以通过多种方式实现，包括手动编写复制代码、使用序列化和反序列化等。</p><p>这里提供一个基于表达式树的深拷贝实现，它可以高效地复制对象及其所有引用的对象。</p><h2 id="DeepCopyByExpressionTrees"><a href="#DeepCopyByExpressionTrees" class="headerlink" title="DeepCopyByExpressionTrees"></a>DeepCopyByExpressionTrees</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Linq.Expressions;<br><span class="hljs-keyword">using</span> System.Reflection;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">UnityToolkit</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 利用表达式树实现高效深复制</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DeepCopyByExpressionTrees</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _isStructTypeToDeepCopyDictionaryLocker = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Dictionary&lt;Type, <span class="hljs-built_in">bool</span>&gt; _isStructTypeToDeepCopyDictionary = <span class="hljs-keyword">new</span> Dictionary&lt;Type, <span class="hljs-built_in">bool</span>&gt;();<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _compiledCopyFunctionsDictionaryLocker = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Dictionary&lt;Type, Func&lt;<span class="hljs-built_in">object</span>, Dictionary&lt;<span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;, <span class="hljs-built_in">object</span>&gt;&gt;<br>            _compiledCopyFunctionsDictionary =<br>                <span class="hljs-keyword">new</span> Dictionary&lt;Type, Func&lt;<span class="hljs-built_in">object</span>, Dictionary&lt;<span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;, <span class="hljs-built_in">object</span>&gt;&gt;();<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> Type _objectType = <span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">object</span>);<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> Type _objectDictionaryType = <span class="hljs-keyword">typeof</span>(Dictionary&lt;<span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;);<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 创建对象的深度拷贝</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>对象类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;original&quot;&gt;</span>要复制的对象<span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;copiedReferencesDict&quot;&gt;</span>已复制对象的字典（原始对象，拷贝）<span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span><span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">DeepCopy</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">this</span> T original, Dictionary&lt;<span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt; copiedReferencesDict = <span class="hljs-literal">null</span></span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> (T)DeepCopyByExpressionTreeObj(original, <span class="hljs-literal">false</span>,<br>                copiedReferencesDict ?? <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;(<span class="hljs-keyword">new</span> ReferenceEqualityComparer()));<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">object</span> <span class="hljs-title">DeepCopyByExpressionTreeObj</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> original, <span class="hljs-built_in">bool</span> forceDeepCopy,</span></span><br><span class="hljs-params"><span class="hljs-function">            Dictionary&lt;<span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt; copiedReferencesDict</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (original == <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">var</span> type = original.GetType();<br>            <span class="hljs-keyword">if</span> (IsDelegate(type))<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (!forceDeepCopy &amp;&amp; !IsTypeToDeepCopy(type))<br>            &#123;<br>                <span class="hljs-keyword">return</span> original;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (copiedReferencesDict.TryGetValue(original, <span class="hljs-keyword">out</span> <span class="hljs-built_in">object</span> alreadyCopiedObject))<br>            &#123;<br>                <span class="hljs-keyword">return</span> alreadyCopiedObject;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (type == _objectType)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();<br>            &#125;<br><br>            <span class="hljs-keyword">var</span> compiledCopyFunction = GetOrCreateCompiledLambdaCopyFunction(type);<br>            <span class="hljs-built_in">object</span> copy = compiledCopyFunction(original, copiedReferencesDict);<br>            <span class="hljs-keyword">return</span> copy;<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Func&lt;<span class="hljs-built_in">object</span>, Dictionary&lt;<span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;, <span class="hljs-built_in">object</span>&gt; GetOrCreateCompiledLambdaCopyFunction(Type type)<br>        &#123;<br>            <span class="hljs-comment">// 以下机构确保多个线程使用字典，即使字典被锁定且被其他线程更新</span><br>            <span class="hljs-comment">// 不修改旧的字典，每次都用新的实例替换</span><br>            <span class="hljs-keyword">if</span> (!_compiledCopyFunctionsDictionary.TryGetValue(type,<br>                    <span class="hljs-keyword">out</span> Func&lt;<span class="hljs-built_in">object</span>, Dictionary&lt;<span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;, <span class="hljs-built_in">object</span>&gt; compiledCopyFunction))<br>            &#123;<br>                <span class="hljs-keyword">lock</span> (_compiledCopyFunctionsDictionaryLocker)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (!_compiledCopyFunctionsDictionary.TryGetValue(type, <span class="hljs-keyword">out</span> compiledCopyFunction))<br>                    &#123;<br>                        <span class="hljs-keyword">var</span> uncompiledCopyFunction = CreateCompiledLambdaCopyFunctionForType(type);<br><br>                        compiledCopyFunction = uncompiledCopyFunction.Compile();<br><br>                        <span class="hljs-keyword">var</span> dictionaryCopy =<br>                            _compiledCopyFunctionsDictionary.ToDictionary(pair =&gt; pair.Key, pair =&gt; pair.Value);<br><br>                        dictionaryCopy.Add(type, compiledCopyFunction);<br><br>                        _compiledCopyFunctionsDictionary = dictionaryCopy;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> compiledCopyFunction;<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Expression&lt;Func&lt;<span class="hljs-built_in">object</span>, Dictionary&lt;<span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;, <span class="hljs-built_in">object</span>&gt;&gt;<br>            CreateCompiledLambdaCopyFunctionForType(Type type)<br>        &#123;<br>            <span class="hljs-comment">// 初始化表达式和变量</span><br>            InitializeExpressions(type, <span class="hljs-keyword">out</span> ParameterExpression inputParameter, <span class="hljs-keyword">out</span> ParameterExpression inputDictionary,<br>                <span class="hljs-keyword">out</span> ParameterExpression outputVariable, <span class="hljs-keyword">out</span> ParameterExpression boxingVariable,<br>                <span class="hljs-keyword">out</span> LabelTarget endLabel, <span class="hljs-keyword">out</span> List&lt;ParameterExpression&gt; variables, <span class="hljs-keyword">out</span> List&lt;Expression&gt; expressions);<br>            <span class="hljs-comment">// 如果原始对象为空，则直接返回空值</span><br>            IfNullThenReturnNullExpression(inputParameter, endLabel, expressions);<br>            <span class="hljs-comment">// 浅拷贝原始对象</span><br>            MemberwiseCloneInputToOutputExpression(type, inputParameter, outputVariable, expressions);<br>            <span class="hljs-comment">// 将复制的对象存储到字典            </span><br>            <span class="hljs-keyword">if</span> (IsClassOtherThanString(type))<br>            &#123;<br>                StoreReferencesIntoDictionaryExpression(inputParameter, inputDictionary, outputVariable, expressions);<br>            &#125;<br><br>            <span class="hljs-comment">// 拷贝所有非值或非系统类型字段</span><br>            FieldsCopyExpressions(type, inputParameter, inputDictionary, outputVariable, boxingVariable, expressions);<br>            <span class="hljs-comment">// 拷贝数组元素</span><br>            <span class="hljs-keyword">if</span> (IsArray(type) &amp;&amp; IsTypeToDeepCopy(type.GetElementType()))<br>            &#123;<br>                CreateArrayCopyLoopExpression(type, inputParameter, inputDictionary, outputVariable, variables,<br>                    expressions);<br>            &#125;<br><br>            <span class="hljs-comment">// 将所有表达式合并到lambda函数中</span><br>            <span class="hljs-keyword">var</span> lambda = CombineAllIntoLambdaFunctionExpression(inputParameter, inputDictionary, outputVariable,<br>                endLabel, variables, expressions);<br>            <span class="hljs-keyword">return</span> lambda;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitializeExpressions</span>(<span class="hljs-params">Type type, <span class="hljs-keyword">out</span> ParameterExpression inputParameter,</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">out</span> ParameterExpression inputDictionary, <span class="hljs-keyword">out</span> ParameterExpression outputVariable,</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">out</span> ParameterExpression boxingVariable, <span class="hljs-keyword">out</span> LabelTarget endLabel, <span class="hljs-keyword">out</span> List&lt;ParameterExpression&gt; variables,</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">out</span> List&lt;Expression&gt; expressions</span>)</span><br>        &#123;<br>            inputParameter = Expression.Parameter(_objectType);<br>            inputDictionary = Expression.Parameter(_objectDictionaryType);<br>            outputVariable = Expression.Variable(type);<br>            boxingVariable = Expression.Variable(_objectType);<br>            endLabel = Expression.Label();<br>            variables = <span class="hljs-keyword">new</span> List&lt;ParameterExpression&gt;();<br>            expressions = <span class="hljs-keyword">new</span> List&lt;Expression&gt;();<br>            variables.Add(outputVariable);<br>            variables.Add(boxingVariable);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">IfNullThenReturnNullExpression</span>(<span class="hljs-params">ParameterExpression inputParameter, LabelTarget endLabel,</span></span><br><span class="hljs-params"><span class="hljs-function">            List&lt;Expression&gt; expressions</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// if (input == null)</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// &#123;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     return null;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// &#125;</span><br>            <span class="hljs-keyword">var</span> ifNullThenReturnNullExpression =<br>                Expression.IfThen(<br>                    Expression.Equal(<br>                        inputParameter,<br>                        Expression.Constant(<span class="hljs-literal">null</span>, _objectType)),<br>                    Expression.Return(endLabel));<br>            expressions.Add(ifNullThenReturnNullExpression);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MemberwiseCloneInputToOutputExpression</span>(<span class="hljs-params">Type type, ParameterExpression inputParameter,</span></span><br><span class="hljs-params"><span class="hljs-function">            ParameterExpression outputVariable, List&lt;Expression&gt; expressions</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// var output = (<span class="hljs-doctag">&lt;type&gt;</span>)input.MemberwiseClone();           </span><br>            <span class="hljs-keyword">var</span> memberwiseCloneMethod =<br>                _objectType.GetMethod(<span class="hljs-string">&quot;MemberwiseClone&quot;</span>, BindingFlags.NonPublic | BindingFlags.Instance);<br>            <span class="hljs-keyword">var</span> memberwiseCloneInputExpression =<br>                Expression.Assign(<br>                    outputVariable,<br>                    Expression.Convert(<br>                        Expression.Call(<br>                            inputParameter,<br>                            memberwiseCloneMethod),<br>                        type));<br>            expressions.Add(memberwiseCloneInputExpression);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">StoreReferencesIntoDictionaryExpression</span>(<span class="hljs-params">ParameterExpression inputParameter,</span></span><br><span class="hljs-params"><span class="hljs-function">            ParameterExpression inputDictionary, ParameterExpression outputVariable, List&lt;Expression&gt; expressions</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// inputDictionary[(Object)input] = (Object)output;</span><br>            <span class="hljs-keyword">var</span> storeReferencesExpression =<br>                Expression.Assign(<br>                    Expression.Property(<br>                        inputDictionary,<br>                        _objectDictionaryType.GetProperty(<span class="hljs-string">&quot;Item&quot;</span>),<br>                        inputParameter),<br>                    Expression.Convert(outputVariable, _objectType));<br>            expressions.Add(storeReferencesExpression);<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Expression&lt;Func&lt;<span class="hljs-built_in">object</span>, Dictionary&lt;<span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;, <span class="hljs-built_in">object</span>&gt;&gt;<br>            CombineAllIntoLambdaFunctionExpression(ParameterExpression inputParameter,<br>                ParameterExpression inputDictionary, ParameterExpression outputVariable, LabelTarget endLabel,<br>                List&lt;ParameterExpression&gt; variables, List&lt;Expression&gt; expressions)<br>        &#123;<br>            expressions.Add(Expression.Label(endLabel));<br>            expressions.Add(Expression.Convert(outputVariable, _objectType));<br>            <span class="hljs-keyword">var</span> finalBody = Expression.Block(variables, expressions);<br>            <span class="hljs-keyword">var</span> lambda =<br>                Expression.Lambda&lt;Func&lt;<span class="hljs-built_in">object</span>, Dictionary&lt;<span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;, <span class="hljs-built_in">object</span>&gt;&gt;(finalBody, inputParameter,<br>                    inputDictionary);<br>            <span class="hljs-keyword">return</span> lambda;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CreateArrayCopyLoopExpression</span>(<span class="hljs-params">Type type, ParameterExpression inputParameter,</span></span><br><span class="hljs-params"><span class="hljs-function">            ParameterExpression inputDictionary, ParameterExpression outputVariable,</span></span><br><span class="hljs-params"><span class="hljs-function">            List&lt;ParameterExpression&gt; variables, List&lt;Expression&gt; expressions</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// int i1, i2, ..., in; </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// int length1 = inputarray.GetLength(0); </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// i1 = 0; </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// while (true)</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// &#123;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     if (i1 &gt;= length1)</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     &#123;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         goto ENDLABELFORLOOP1;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     &#125;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     int length2 = inputarray.GetLength(1); </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     i2 = 0; </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     while (true)</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     &#123;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         if (i2 &gt;= length2)</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         &#123;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//             goto ENDLABELFORLOOP2;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         &#125;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         ...</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         ...</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         ...</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         int lengthn = inputarray.GetLength(n); </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         in = 0; </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         while (true)</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         &#123;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//             if (in &gt;= lengthn)</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//             &#123;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//                 goto ENDLABELFORLOOPn;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//             &#125;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//             outputarray[i1, i2, ..., in] </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//                 = (<span class="hljs-doctag">&lt;elementType&gt;</span>)DeepCopyByExpressionTreeObj(</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//                        (Object)inputarray[i1, i2, ..., in])</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//             in++; </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         &#125;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         ENDLABELFORLOOPn:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         ...</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         ...  </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         ...</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         i2++; </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     &#125;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     ENDLABELFORLOOP2:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     i1++; </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// &#125;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// ENDLABELFORLOOP1:</span><br>            <span class="hljs-keyword">var</span> rank = type.GetArrayRank();<br>            <span class="hljs-keyword">var</span> indices = GenerateIndices(rank);<br>            variables.AddRange(indices);<br>            <span class="hljs-keyword">var</span> elementType = type.GetElementType();<br>            <span class="hljs-keyword">var</span> assignExpression = ArrayFieldToArrayFieldAssignExpression(inputParameter, inputDictionary,<br>                outputVariable, elementType, type, indices);<br>            Expression forExpression = assignExpression;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> dimension = <span class="hljs-number">0</span>; dimension &lt; rank; dimension++)<br>            &#123;<br>                <span class="hljs-keyword">var</span> indexVariable = indices[dimension];<br><br>                forExpression = LoopIntoLoopExpression(inputParameter, indexVariable, forExpression, dimension);<br>            &#125;<br><br>            expressions.Add(forExpression);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;ParameterExpression&gt; <span class="hljs-title">GenerateIndices</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> arrayRank</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// int i1, i2, ..., in; </span><br>            <span class="hljs-keyword">var</span> indices = <span class="hljs-keyword">new</span> List&lt;ParameterExpression&gt;();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; arrayRank; i++)<br>            &#123;<br>                <span class="hljs-keyword">var</span> indexVariable = Expression.Variable(<span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">int</span>));<br><br>                indices.Add(indexVariable);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> indices;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BinaryExpression <span class="hljs-title">ArrayFieldToArrayFieldAssignExpression</span>(<span class="hljs-params">ParameterExpression inputParameter,</span></span><br><span class="hljs-params"><span class="hljs-function">            ParameterExpression inputDictionary, ParameterExpression outputVariable, Type elementType, Type arrayType,</span></span><br><span class="hljs-params"><span class="hljs-function">            List&lt;ParameterExpression&gt; indices</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// outputarray[i1, i2, ..., in] </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     = (<span class="hljs-doctag">&lt;elementType&gt;</span>)DeepCopyByExpressionTreeObj(</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//            (Object)inputarray[i1, i2, ..., in]);</span><br>            <span class="hljs-keyword">var</span> indexTo = Expression.ArrayAccess(outputVariable, indices);<br>            <span class="hljs-keyword">var</span> indexFrom = Expression.ArrayIndex(Expression.Convert(inputParameter, arrayType), indices);<br>            <span class="hljs-keyword">var</span> forceDeepCopy = elementType != _objectType;<br>            <span class="hljs-keyword">var</span> rightSide =<br>                Expression.Convert(<br>                    Expression.Call(<br>                        DeepCopyByExpressionTreeObjMethod,<br>                        Expression.Convert(indexFrom, _objectType),<br>                        Expression.Constant(forceDeepCopy, <span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">bool</span>)),<br>                        inputDictionary),<br>                    elementType);<br><br>            <span class="hljs-keyword">var</span> assignExpression = Expression.Assign(indexTo, rightSide);<br>            <span class="hljs-keyword">return</span> assignExpression;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BlockExpression <span class="hljs-title">LoopIntoLoopExpression</span>(<span class="hljs-params">ParameterExpression inputParameter,</span></span><br><span class="hljs-params"><span class="hljs-function">            ParameterExpression indexVariable, Expression loopToEncapsulate, <span class="hljs-built_in">int</span> dimension</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// int length = inputarray.GetLength(dimension); </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// i = 0; </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// while (true)</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// &#123;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     if (i &gt;= length)</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     &#123;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//         goto ENDLABELFORLOOP;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     &#125;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     loopToEncapsulate;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//     i++; </span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// &#125;</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// ENDLABELFORLOOP:</span><br>            <span class="hljs-keyword">var</span> lengthVariable = Expression.Variable(<span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">int</span>));<br>            <span class="hljs-keyword">var</span> endLabelForThisLoop = Expression.Label();<br>            <span class="hljs-keyword">var</span> newLoop =<br>                Expression.Loop(Expression.Block(<span class="hljs-keyword">new</span> ParameterExpression[<span class="hljs-number">0</span>],<br>                        Expression.IfThen(Expression.GreaterThanOrEqual(indexVariable, lengthVariable),<br>                            Expression.Break(endLabelForThisLoop)),<br>                        loopToEncapsulate,<br>                        Expression.PostIncrementAssign(indexVariable)),<br>                    endLabelForThisLoop);<br><br>            <span class="hljs-keyword">var</span> lengthAssignment = GetLengthForDimensionExpression(lengthVariable, inputParameter, dimension);<br>            <span class="hljs-keyword">var</span> indexAssignment = Expression.Assign(indexVariable, Expression.Constant(<span class="hljs-number">0</span>));<br>            <span class="hljs-keyword">return</span> Expression.Block(<span class="hljs-keyword">new</span>[] &#123; lengthVariable &#125;, lengthAssignment, indexAssignment, newLoop);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BinaryExpression <span class="hljs-title">GetLengthForDimensionExpression</span>(<span class="hljs-params">ParameterExpression lengthVariable,</span></span><br><span class="hljs-params"><span class="hljs-function">            ParameterExpression inputParameter, <span class="hljs-built_in">int</span> i</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// length = ((Array)input).GetLength(i); </span><br>            <span class="hljs-keyword">var</span> getLengthMethod = <span class="hljs-keyword">typeof</span>(Array).GetMethod(<span class="hljs-string">&quot;GetLength&quot;</span>, BindingFlags.Public | BindingFlags.Instance);<br>            <span class="hljs-keyword">var</span> dimensionConstant = Expression.Constant(i);<br><br>            <span class="hljs-keyword">return</span> Expression.Assign(lengthVariable, Expression.Call(Expression.Convert(inputParameter, <span class="hljs-keyword">typeof</span>(Array)),<br>                getLengthMethod, <span class="hljs-keyword">new</span>[] &#123; dimensionConstant &#125;));<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FieldsCopyExpressions</span>(<span class="hljs-params">Type type, ParameterExpression inputParameter,</span></span><br><span class="hljs-params"><span class="hljs-function">            ParameterExpression inputDictionary, ParameterExpression outputVariable, ParameterExpression boxingVariable,</span></span><br><span class="hljs-params"><span class="hljs-function">            List&lt;Expression&gt; expressions</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">var</span> fields = GetAllRelevantFields(type);<br>            <span class="hljs-keyword">var</span> readonlyFields = fields.Where(f =&gt; f.IsInitOnly).ToList();<br>            <span class="hljs-keyword">var</span> writableFields = fields.Where(f =&gt; !f.IsInitOnly).ToList();<br>            <span class="hljs-comment">// 只读字段拷贝（采用装箱操作）</span><br>            <span class="hljs-built_in">bool</span> shouldUseBoxing = readonlyFields.Any();<br>            <span class="hljs-keyword">if</span> (shouldUseBoxing)<br>            &#123;<br>                <span class="hljs-keyword">var</span> boxingExpression =<br>                    Expression.Assign(boxingVariable, Expression.Convert(outputVariable, _objectType));<br>                expressions.Add(boxingExpression);<br>            &#125;<br><br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> field <span class="hljs-keyword">in</span> readonlyFields)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (IsDelegate(field.FieldType))<br>                &#123;<br>                    ReadonlyFieldToNullExpression(field, boxingVariable, expressions);<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    ReadonlyFieldCopyExpression(type, field, inputParameter, inputDictionary, boxingVariable,<br>                        expressions);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (shouldUseBoxing)<br>            &#123;<br>                <span class="hljs-keyword">var</span> unboxingExpression = Expression.Assign(outputVariable, Expression.Convert(boxingVariable, type));<br>                expressions.Add(unboxingExpression);<br>            &#125;<br><br>            <span class="hljs-comment">// 非只读字段拷贝</span><br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> field <span class="hljs-keyword">in</span> writableFields)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (IsDelegate(field.FieldType))<br>                &#123;<br>                    WritableFieldToNullExpression(field, outputVariable, expressions);<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    WritableFieldCopyExpression(type, field, inputParameter, inputDictionary, outputVariable,<br>                        expressions);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FieldInfo[] <span class="hljs-title">GetAllRelevantFields</span>(<span class="hljs-params">Type type, <span class="hljs-built_in">bool</span> forceAllFields = <span class="hljs-literal">false</span></span>)</span><br>        &#123;<br>            <span class="hljs-keyword">var</span> fieldsList = <span class="hljs-keyword">new</span> List&lt;FieldInfo&gt;();<br>            <span class="hljs-keyword">var</span> typeCache = type;<br>            <span class="hljs-keyword">while</span> (typeCache != <span class="hljs-literal">null</span>)<br>            &#123;<br>                fieldsList.AddRange(typeCache<br>                    .GetFields(BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic |<br>                               BindingFlags.FlattenHierarchy)<br>                    .Where(field =&gt; forceAllFields || IsTypeToDeepCopy(field.FieldType)));<br>                typeCache = typeCache.BaseType;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> fieldsList.ToArray();<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FieldInfo[] <span class="hljs-title">GetAllFields</span>(<span class="hljs-params">Type type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> GetAllRelevantFields(type, forceAllFields: <span class="hljs-literal">true</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> Type FieldInfoType = <span class="hljs-keyword">typeof</span>(FieldInfo);<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> MethodInfo SetValueMethod =<br>            FieldInfoType.GetMethod(<span class="hljs-string">&quot;SetValue&quot;</span>, <span class="hljs-keyword">new</span>[] &#123; _objectType, _objectType &#125;);<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReadonlyFieldToNullExpression</span>(<span class="hljs-params">FieldInfo field, ParameterExpression boxingVariable,</span></span><br><span class="hljs-params"><span class="hljs-function">            List&lt;Expression&gt; expressions</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// fieldInfo.SetValue(boxing, <span class="hljs-doctag">&lt;fieldtype&gt;</span>null);</span><br>            <span class="hljs-keyword">var</span> fieldToNullExpression =<br>                Expression.Call(<br>                    Expression.Constant(field),<br>                    SetValueMethod,<br>                    boxingVariable,<br>                    Expression.Constant(<span class="hljs-literal">null</span>, field.FieldType));<br><br>            expressions.Add(fieldToNullExpression);<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> Type ThisType = <span class="hljs-keyword">typeof</span>(DeepCopyByExpressionTrees);<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> MethodInfo DeepCopyByExpressionTreeObjMethod =<br>            ThisType.GetMethod(<span class="hljs-string">&quot;DeepCopyByExpressionTreeObj&quot;</span>, BindingFlags.NonPublic | BindingFlags.Static);<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReadonlyFieldCopyExpression</span>(<span class="hljs-params">Type type, FieldInfo field, ParameterExpression inputParameter,</span></span><br><span class="hljs-params"><span class="hljs-function">            ParameterExpression inputDictionary, ParameterExpression boxingVariable, List&lt;Expression&gt; expressions</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// fieldInfo.SetValue(boxing, DeepCopyByExpressionTreeObj((Object)((<span class="hljs-doctag">&lt;type&gt;</span>)input).<span class="hljs-doctag">&lt;field&gt;</span>))</span><br>            <span class="hljs-keyword">var</span> fieldFrom = Expression.Field(Expression.Convert(inputParameter, type), field);<br>            <span class="hljs-keyword">var</span> forceDeepCopy = field.FieldType != _objectType;<br>            <span class="hljs-keyword">var</span> fieldDeepCopyExpression =<br>                Expression.Call(Expression.Constant(field, FieldInfoType), SetValueMethod, boxingVariable,<br>                    Expression.Call(DeepCopyByExpressionTreeObjMethod, Expression.Convert(fieldFrom, _objectType),<br>                        Expression.Constant(forceDeepCopy, <span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">bool</span>)),<br>                        inputDictionary));<br>            expressions.Add(fieldDeepCopyExpression);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WritableFieldToNullExpression</span>(<span class="hljs-params">FieldInfo field, ParameterExpression outputVariable,</span></span><br><span class="hljs-params"><span class="hljs-function">            List&lt;Expression&gt; expressions</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// output.<span class="hljs-doctag">&lt;field&gt;</span> = (<span class="hljs-doctag">&lt;type&gt;</span>)null;           </span><br>            <span class="hljs-keyword">var</span> fieldTo = Expression.Field(outputVariable, field);<br>            <span class="hljs-keyword">var</span> fieldToNullExpression = Expression.Assign(fieldTo, Expression.Constant(<span class="hljs-literal">null</span>, field.FieldType));<br>            expressions.Add(fieldToNullExpression);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WritableFieldCopyExpression</span>(<span class="hljs-params">Type type, FieldInfo field, ParameterExpression inputParameter,</span></span><br><span class="hljs-params"><span class="hljs-function">            ParameterExpression inputDictionary, ParameterExpression outputVariable, List&lt;Expression&gt; expressions</span>)</span><br>        &#123;<br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// Intended code:</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>//</span><br>            <span class="hljs-comment"><span class="hljs-doctag">///</span>// output.<span class="hljs-doctag">&lt;field&gt;</span> = (<span class="hljs-doctag">&lt;fieldType&gt;</span>)DeepCopyByExpressionTreeObj((Object)((<span class="hljs-doctag">&lt;type&gt;</span>)input).<span class="hljs-doctag">&lt;field&gt;</span>);</span><br>            <span class="hljs-keyword">var</span> fieldFrom = Expression.Field(Expression.Convert(inputParameter, type), field);<br>            <span class="hljs-keyword">var</span> fieldType = field.FieldType;<br>            <span class="hljs-keyword">var</span> fieldTo = Expression.Field(outputVariable, field);<br>            <span class="hljs-keyword">var</span> forceDeepCopy = field.FieldType != _objectType;<br>            <span class="hljs-keyword">var</span> fieldDeepCopyExpression = Expression.Assign(fieldTo,<br>                Expression.Convert(<br>                    Expression.Call(DeepCopyByExpressionTreeObjMethod, Expression.Convert(fieldFrom, _objectType),<br>                        Expression.Constant(forceDeepCopy, <span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">bool</span>)), inputDictionary), fieldType));<br>            expressions.Add(fieldDeepCopyExpression);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsArray</span>(<span class="hljs-params">Type type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> type.IsArray;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsDelegate</span>(<span class="hljs-params">Type type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span>(Delegate).IsAssignableFrom(type);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsTypeToDeepCopy</span>(<span class="hljs-params">Type type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> IsClassOtherThanString(type)<br>                   || IsStructWhichNeedsDeepCopy(type);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsClassOtherThanString</span>(<span class="hljs-params">Type type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> !type.IsValueType &amp;&amp; type != <span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">string</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsStructWhichNeedsDeepCopy</span>(<span class="hljs-params">Type type</span>)</span><br>        &#123;<br>            <span class="hljs-comment">// 多线程访问</span><br>            <span class="hljs-keyword">if</span> (!_isStructTypeToDeepCopyDictionary.TryGetValue(type, <span class="hljs-keyword">out</span> <span class="hljs-built_in">bool</span> isStructTypeToDeepCopy))<br>            &#123;<br>                <span class="hljs-keyword">lock</span> (_isStructTypeToDeepCopyDictionaryLocker)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (!_isStructTypeToDeepCopyDictionary.TryGetValue(type, <span class="hljs-keyword">out</span> isStructTypeToDeepCopy))<br>                    &#123;<br>                        isStructTypeToDeepCopy = IsStructWhichNeedsDeepCopy_NoDictionaryUsed(type);<br><br>                        <span class="hljs-keyword">var</span> newDictionary =<br>                            _isStructTypeToDeepCopyDictionary.ToDictionary(pair =&gt; pair.Key, pair =&gt; pair.Value);<br><br>                        newDictionary[type] = isStructTypeToDeepCopy;<br><br>                        _isStructTypeToDeepCopyDictionary = newDictionary;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> isStructTypeToDeepCopy;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsStructWhichNeedsDeepCopy_NoDictionaryUsed</span>(<span class="hljs-params">Type type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> IsStructOtherThanBasicValueTypes(type) &amp;&amp; HasInItsHierarchyFieldsWithClasses(type);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsStructOtherThanBasicValueTypes</span>(<span class="hljs-params">Type type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> type.IsValueType &amp;&amp; !type.IsPrimitive &amp;&amp; !type.IsEnum &amp;&amp; type != <span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">decimal</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">HasInItsHierarchyFieldsWithClasses</span>(<span class="hljs-params">Type type, HashSet&lt;Type&gt; alreadyCheckedTypes = <span class="hljs-literal">null</span></span>)</span><br>        &#123;<br>            alreadyCheckedTypes = alreadyCheckedTypes ?? <span class="hljs-keyword">new</span> HashSet&lt;Type&gt;();<br>            alreadyCheckedTypes.Add(type);<br>            <span class="hljs-keyword">var</span> allFields = GetAllFields(type);<br>            <span class="hljs-keyword">var</span> allFieldTypes = allFields.Select(f =&gt; f.FieldType).Distinct().ToList();<br>            <span class="hljs-keyword">var</span> hasFieldsWithClasses = allFieldTypes.Any(IsClassOtherThanString);<br>            <span class="hljs-keyword">if</span> (hasFieldsWithClasses)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">var</span> notBasicStructsTypes = allFieldTypes.Where(IsStructOtherThanBasicValueTypes).ToList();<br>            <span class="hljs-keyword">var</span> typesToCheck = notBasicStructsTypes.Where(t =&gt; !alreadyCheckedTypes.Contains(t)).ToList();<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> typeToCheck <span class="hljs-keyword">in</span> typesToCheck)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (HasInItsHierarchyFieldsWithClasses(typeToCheck, alreadyCheckedTypes))<br>                &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ReferenceEqualityComparer</span> : <span class="hljs-title">EqualityComparer</span>&lt;<span class="hljs-title">object</span>&gt;<br>        &#123;<br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">Equals</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> x, <span class="hljs-built_in">object</span> y</span>)</span><br>            &#123;<br>                <span class="hljs-keyword">return</span> ReferenceEquals(x, y);<br>            &#125;<br><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetHashCode</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>)<br>                &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> obj.GetHashCode();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>CSharp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>图形学的基本要义</title>
    <link href="/2024/08/30/%E5%9B%BE%E5%BD%A2%E5%AD%A6/"/>
    <url>/2024/08/30/%E5%9B%BE%E5%BD%A2%E5%AD%A6/</url>
    
    <content type="html"><![CDATA[<p>看上去是对的，那就是对的</p>]]></content>
    
    
    
    <tags>
      
      <tag>图形学</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity基础光照</title>
    <link href="/2024/08/30/%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7%E6%A8%A1%E5%9E%8B/"/>
    <url>/2024/08/30/%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="光照"><a href="#光照" class="headerlink" title="光照"></a>光照</h2><h3 id="散射"><a href="#散射" class="headerlink" title="散射"></a>散射</h3><h3 id="吸收"><a href="#吸收" class="headerlink" title="吸收"></a>吸收</h3><h3 id="着色"><a href="#着色" class="headerlink" title="着色"></a>着色</h3><h2 id="标准光照模型"><a href="#标准光照模型" class="headerlink" title="标准光照模型"></a>标准光照模型</h2><ul><li><p>环境光</p></li><li><p>自发光</p></li><li><p>高光反射（镜面反射）</p></li><li><p>漫反射</p></li><li><p>菲涅尔效应</p></li></ul><h2 id="HLSL"><a href="#HLSL" class="headerlink" title="HLSL"></a>HLSL</h2><table><thead><tr><th>基本数据类型</th><th>描述</th><th>用途</th></tr></thead><tbody><tr><td>float</td><td>一般是32位</td><td>顶点，纹理坐标</td></tr><tr><td>half</td><td>一般是16位</td><td>矢量，方向，位置，颜色等</td></tr></tbody></table><h2 id="线性代数"><a href="#线性代数" class="headerlink" title="线性代数"></a>线性代数</h2><ul><li>计算向量间的夹角</li></ul><p>$$<br>AB&#x3D;dot(A, B) &#x3D; |A||B|cos\theta<br>$$</p><p>$$<br>cos\theta &#x3D; \frac{AB}{|A||B|}<br>$$</p><h2 id="逐顶点和逐像素"><a href="#逐顶点和逐像素" class="headerlink" title="逐顶点和逐像素"></a>逐顶点和逐像素</h2><p>像素是根据顶点插值而来的</p><h2 id="Lambert"><a href="#Lambert" class="headerlink" title="Lambert"></a>Lambert</h2><p>是光的漫反射经验模型</p><p><strong>认为某点的漫反射强度和入射光线与其法线方向夹角成正比</strong></p><p>假设所有的向量都是标准化向量的情况下计算出对应点的漫反射强度为<br>$$<br>diffuse &#x3D; clamp01(dot(lightDir,normal))<br>$$</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 兰伯特漫反射光照模型</span><br>half <span class="hljs-title function_">LambertDiffuse</span><span class="hljs-params">(float3 normal, float3 lightDir)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> saturate(dot(normal, lightDir));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Half-Lambert"><a href="#Half-Lambert" class="headerlink" title="Half Lambert"></a>Half Lambert</h2><p>当cos值为负数时，会全黑，因此有<strong>Half Lambert</strong></p><p>$$<br>diffuse &#x3D; dot(lightDir,normal)*0.5+0.5<br>$$</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C">half <span class="hljs-title function_">HalfLambdaDiffuse</span><span class="hljs-params">(float3 normal, float3 lightDir)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> saturate(dot(normal, lightDir) * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/../img/URP-Lambert.png" alt="URP-Lambert"></p>]]></content>
    
    
    
    <tags>
      
      <tag>图形学</tag>
      
      <tag>Shader</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Runtime Virtual Texture</title>
    <link href="/2024/08/30/RVT/"/>
    <url>/2024/08/30/RVT/</url>
    
    <content type="html"><![CDATA[<h2 id="什么是-Runtime-Virtual-Texture"><a href="#什么是-Runtime-Virtual-Texture" class="headerlink" title="什么是 Runtime Virtual Texture"></a>什么是 Runtime Virtual Texture</h2><p>Runtime Virtual Texture 是一种在运行时生成纹理的技术。它可以用来实现很多高级的效果，比如地形细节纹理、地形细节法线、地形细节高度、地形细节光照等。</p>]]></content>
    
    
    
    <tags>
      
      <tag>图形学</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>插值算法</title>
    <link href="/2024/08/30/%E6%8F%92%E5%80%BC%E7%AE%97%E6%B3%95/"/>
    <url>/2024/08/30/%E6%8F%92%E5%80%BC%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="插值算法"><a href="#插值算法" class="headerlink" title="插值算法"></a>插值算法</h1><p>插值算法用于在已知数据点之间估计未知点的值。它在计算机图形学、数据分析和信号处理等领域有广泛应用。以下是一些常见的插值方法及其公式。</p><h2 id="线性插值"><a href="#线性插值" class="headerlink" title="线性插值"></a>线性插值</h2><p>线性插值是最简单的插值方法，它通过两个已知点之间的直线来估计中间点的值。公式如下：<br><span><br>$$<br>f(x) &#x3D; f(x_0) + \frac{f(x_1) - f(x_0)}{x_1 - x_0} \cdot (x - x_0)<br>$$<br></span><br>其中，(x_0) 和 (x_1) 是已知点的横坐标，(f(x_0)) 和 (f(x_1)) 是对应的纵坐标。</p><h2 id="二次插值"><a href="#二次插值" class="headerlink" title="二次插值"></a>二次插值</h2><p>二次插值使用三个已知点来构建一个二次多项式。公式如下：<br><span><br>$$<br>f(x) &#x3D; a(x - x_0)(x - x_1) + b(x - x_0) + c<br>$$<br><span><br>其中，(a)、(b)、(c) 是通过已知点计算得到的系数。</p><h2 id="三次插值"><a href="#三次插值" class="headerlink" title="三次插值"></a>三次插值</h2><p>三次插值使用四个已知点来构建一个三次多项式。公式如下：<br><span><br>$$<br>f(x) &#x3D; a(x - x_0)(x - x_1)(x - x_2) + b(x - x_0)(x - x_1) + c(x - x_0) + d<br>$$<br></span><br>其中，(a)、(b)、(c)、(d) 是通过已知点计算得到的系数。</p><h2 id="拉格朗日插值"><a href="#拉格朗日插值" class="headerlink" title="拉格朗日插值"></a>拉格朗日插值</h2><p>拉格朗日插值是一种多项式插值方法，它通过已知点的函数值来构建一个多项式。公式如下：<br><span><br>$$<br>f(x) &#x3D; \sum_{i&#x3D;0}^{n} f(x_i) \cdot L_i(x)<br>$$<br></span><br>其中，(L_i(x)) 是拉格朗日基函数，定义为：<br><span><br>$$<br>L_i(x) &#x3D; \prod_{j&#x3D;0, j \neq i}^{n} \frac{x - x_j}{x_i - x_j}<br>$$<br></span></p><h2 id="牛顿插值"><a href="#牛顿插值" class="headerlink" title="牛顿插值"></a>牛顿插值</h2><p>牛顿插值使用差商表来构建插值多项式。公式如下：<br><span><br>$$<br>f(x) &#x3D; f(x_0) + (x - x_0) \cdot f[x_0, x_1] + (x - x_0)(x - x_1) \cdot f[x_0, x_1, x_2] + \ldots<br>$$<br></span><br>其中，(f[x_0, x_1]) 是 (x_0) 和 (x_1) 的差商，依此类推。</p><h2 id="分段线性插值"><a href="#分段线性插值" class="headerlink" title="分段线性插值"></a>分段线性插值</h2><p>分段线性插值将数据分成多个区间，在每个区间内使用线性插值。对于每个区间 ([x_i, x_{i+1}])，插值公式为：<br><span><br>$$<br>f(x) &#x3D; f(x_i) + \frac{f(x_{i+1}) - f(x_i)}{x_{i+1} - x_i} \cdot (x - x_i)<br>$$<br></span></p><h2 id="双线性插值"><a href="#双线性插值" class="headerlink" title="双线性插值"></a>双线性插值</h2><p>双线性插值用于二维数据，通过在两个方向上进行线性插值来估计中间点的值。假设已知四个点 ((x_0, y_0))、((x_1, y_0))、((x_0, y_1))、((x_1, y_1))，公式如下：<br><span><br>$$<br>f(x, y) &#x3D; f(x_0, y_0) \cdot (1 - \frac{x - x_0}{x_1 - x_0}) \cdot (1 - \frac{y - y_0}{y_1 - y_0}) + f(x_1, y_0) \cdot \frac{x - x_0}{x_1 - x_0} \cdot (1 - \frac{y - y_0}{y_1 - y_0}) + f(x_0, y_1) \cdot (1 - \frac{x - x_0}{x_1 - x_0}) \cdot \frac{y - y_0}{y_1 - y_0} + f(x_1, y_1) \cdot \frac{x - x_0}{x_1 - x_0} \cdot \frac{y - y_0}{y_1 - y_0}<br>$$<br></span></p><h2 id="三次样条插值"><a href="#三次样条插值" class="headerlink" title="三次样条插值"></a>三次样条插值</h2><p>三次样条插值使用分段的三次多项式来平滑地连接多个点。每个区间 ([x_i, x_{i+1}]) 的插值公式为：<br><span><br>$$<br>f(x) &#x3D; a_i(x - x_i)^3 + b_i(x - x_i)^2 + c_i(x - x_i) + d_i<br>$$<br></span><br>其中，(a_i)、(b_i)、(c_i)、(d_i) 是通过已知点和边界条件计算得到的系数。</p><h2 id="贝塞尔插值"><a href="#贝塞尔插值" class="headerlink" title="贝塞尔插值"></a>贝塞尔插值</h2><p>贝塞尔插值使用控制点来定义曲线。对于二次贝塞尔曲线，公式如下：<br><span><br>$$<br>B(t) &#x3D; (1 - t)^2 P_0 + 2(1 - t)t P_1 + t^2 P_2<br>$$<br></span></p><script>MathJax = {  tex: {    inlineMath: [['$', '$'], ['\\(', '\\)']]  }};</script><script id="MathJax-script" async  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>]]></content>
    
    
    
    <tags>
      
      <tag>图形学</tag>
      
      <tag>Network</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UIFramework</title>
    <link href="/2024/08/30/UIFramework/"/>
    <url>/2024/08/30/UIFramework/</url>
    
    <content type="html"><![CDATA[<p>这里介绍一下自己DIY的UI框架，功能比较简单，但可以满足大部分需求。</p><h1 id="UIFramework"><a href="#UIFramework" class="headerlink" title="UIFramework"></a>UIFramework</h1><ul><li>首先在场景中创建一个UIRoot对象，用于管理UI面板</li><li>创建后会自动生成一个UIDatabase对象，存放在Assets目录下，可以根据自己的需要进行移动</li><li>可以尝试双击打开UIDatabase(未实现的功能)</li><li>首先实现一个自定的UI资源加载器(下面分别时基于Addressabels和Resouces的两种IUILoader实现)<ul><li>三种加载方式分别对应同步加载 ，回调加载 ，Task加载</li><li>本质上是加载一个UI面板的Prefab</li></ul></li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">struct</span> AddressablesUILoader : IUILoader<br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> GameObject <span class="hljs-title">Load</span>&lt;<span class="hljs-title">T</span>&gt;() <span class="hljs-keyword">where</span> T : IUIPanel</span><br>    &#123;<br>        <span class="hljs-built_in">string</span> path = <span class="hljs-string">$&quot;UI/<span class="hljs-subst">&#123;<span class="hljs-keyword">typeof</span>(T).Name&#125;</span>/<span class="hljs-subst">&#123;<span class="hljs-keyword">typeof</span>(T).Name&#125;</span>.prefab&quot;</span>;<br>        <span class="hljs-keyword">return</span> Addressables.LoadAssetAsync&lt;GameObject&gt;(path).WaitForCompletion();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoadAsync</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">Action&lt;GameObject&gt; callback</span>) <span class="hljs-keyword">where</span> T : IUIPanel</span><br>    &#123;<br>        <span class="hljs-built_in">string</span> path = <span class="hljs-string">$&quot;UI/<span class="hljs-subst">&#123;<span class="hljs-keyword">typeof</span>(T).Name&#125;</span>/<span class="hljs-subst">&#123;<span class="hljs-keyword">typeof</span>(T).Name&#125;</span>.prefab&quot;</span>;<br>        <span class="hljs-keyword">var</span> handle = Addressables.LoadAssetAsync&lt;GameObject&gt;(path);<br>        handle.Completed += operation =&gt; &#123; callback(handle.Result); &#125;;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title">Task</span>&lt;<span class="hljs-title">GameObject</span>&gt; <span class="hljs-title">LoadAsync</span>&lt;<span class="hljs-title">T</span>&gt;() <span class="hljs-keyword">where</span> T : IUIPanel</span><br>    &#123;<br>        <span class="hljs-built_in">string</span> path = <span class="hljs-string">$&quot;UI/<span class="hljs-subst">&#123;<span class="hljs-keyword">typeof</span>(T).Name&#125;</span>/<span class="hljs-subst">&#123;<span class="hljs-keyword">typeof</span>(T).Name&#125;</span>.prefab&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> Addressables.LoadAssetAsync&lt;GameObject&gt;(path);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params">GameObject panel</span>)</span><br>    &#123;<br>        Addressables.Release(panel);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">struct</span> DefaultLoader : IUILoader<br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> GameObject <span class="hljs-title">Load</span>&lt;<span class="hljs-title">T</span>&gt;() <span class="hljs-keyword">where</span> T : IUIPanel</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> Resources.Load&lt;GameObject&gt;(<span class="hljs-keyword">typeof</span>(T).Name);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoadAsync</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">Action&lt;GameObject&gt; callback</span>) <span class="hljs-keyword">where</span> T : IUIPanel</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> handle = Resources.LoadAsync&lt;GameObject&gt;(<span class="hljs-keyword">typeof</span>(T).Name);<br>        handle.completed += operation =&gt; &#123; callback(handle.asset <span class="hljs-keyword">as</span> GameObject); &#125;;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title">Task</span>&lt;<span class="hljs-title">GameObject</span>&gt; <span class="hljs-title">LoadAsync</span>&lt;<span class="hljs-title">T</span>&gt;() <span class="hljs-keyword">where</span> T : IUIPanel</span><br>    &#123;<br>        TaskCompletionSource&lt;GameObject&gt; tcs = <span class="hljs-keyword">new</span> TaskCompletionSource&lt;GameObject&gt;();<br>        <span class="hljs-keyword">var</span> handle = Resources.LoadAsync&lt;GameObject&gt;(<span class="hljs-keyword">typeof</span>(T).Name);<br>        tcs.SetResult(handle.asset <span class="hljs-keyword">as</span> GameObject);<br>        <span class="hljs-keyword">await</span> tcs.Task;<br>        <span class="hljs-keyword">return</span> tcs.Task.Result;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params">GameObject panel</span>)</span><br>    &#123;<br>        DestroyImmediate(panel);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>然后在代码中初始化UI加载器</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">UIRoot.Singleton.UIDatabase.Loader = <span class="hljs-keyword">new</span> AddressablesUILoader();<br></code></pre></td></tr></table></figure><ul><li>然后可以按照需要进行UI的加载和销毁</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp">UIRoot.Singleton.OpenPanel&lt;TXXXPanel&gt;(); <span class="hljs-comment">// 打开一个面板</span><br>UIRoot.Singleton.ClosePanel&lt;TXXXPanel&gt;(); <span class="hljs-comment">// 关闭一个面板</span><br>UIRoot.Singleton.CloseAllPanel(); <span class="hljs-comment">// 关闭所有面板</span><br>UIRoot.Singleton.Dispose&lt;TXXXPanel&gt;(); <span class="hljs-comment">// 销毁一个面板</span><br></code></pre></td></tr></table></figure><ul><li>如何制作一个UIPanel<ul><li>在UIRoot的Canvas下创建一个Canvas，修改名字，然后拖到Project下，生成一个Prefab</li><li>创建一个脚本继承UIPanel，将UIPanel挂载到prefab上</li><li>也可以实现IUIPanel接口，实现自己的UIPanel</li><li>注意你的prefab路径，需要能够被你的IUILoader加载到</li></ul></li></ul><h3 id="无限循环滚动列表"><a href="#无限循环滚动列表" class="headerlink" title="无限循环滚动列表"></a>无限循环滚动列表</h3><p>LoopScrollRect: 无限循环滚动列表 ，来自github.com&#x2F;qiankanglai&#x2F;LoopScrollRect</p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>UGUI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity Shader</title>
    <link href="/2024/06/17/Unity%20Shader%E5%9F%BA%E7%A1%80/"/>
    <url>/2024/06/17/Unity%20Shader%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h2 id="渲染管线"><a href="#渲染管线" class="headerlink" title="渲染管线"></a>渲染管线</h2><ul><li><strong>渲染管线(Rendering Pipeline)：</strong> 一提到管线，感觉很高大上的样子。说的俗一点就是可以理解为流水线。渲染管线我们可暂时理解为 <strong>从得到模型数据到绘制出图像</strong> 这一过程的称呼。</li><li><strong>Vertex Shader：</strong> 对顶点数据编程的一段程序。 人类有懒惰的天性，习惯用简化的词汇来表达同一个东西。对 Vertex Shader 也不例外，一般称其为 VS ，但是在本系列文章中会保持全称。</li><li><strong>Fragment Shader：</strong> 对像素数据编程的一段程序。这里 fragment 可以理解为带有信息（颜色，坐标等）的像素 (Pixel), 一般也简称其为 FS 或者 PS 。 在本系列文章中会保持其全称。</li><li><strong>FrameBuffer：</strong> 缓存帧数据的存储区，它一般包含的是要显示到显示设备上的位图数据（也就是图片数据）。</li><li><strong>Fixed Function：</strong> 由于一些硬件支持等历史原因，早期的图形 API <strong>只支持对 GPU 做配置</strong>，这部分只可配置的功能就是 fixed fucntion。这里注意下，fixed function 的功能只能配置，不像 Vertex Shader　和 fragment Shader 可以编程（写自己的算法）。</li></ul><p><img src="https://wudixiaop.github.io/images/Shader/2/rendering-pipeline.jpg" alt="2.renderingpipeline.jpg"></p><h2 id="Shader语言"><a href="#Shader语言" class="headerlink" title="Shader语言"></a>Shader语言</h2><p><a href="https://docs.unity3d.com/Manual/SL-Reference.html">Unity - Manual: ShaderLab (unity3d.com)</a></p><ul><li><strong>CG</strong> ： C For Graphics，是一种专门为图形编程设计的语言，它是一种高级语言，可以编译成汇编语言，也可以编译成高级语言。</li><li><strong>HLSL</strong> ： High Level Shader Language，是微软公司为DirectX开发的一种高级着色器语言。</li><li><strong>GLSL</strong> ： OpenGL Shading Language，是OpenGL的着色器语言。</li></ul><h2 id="坐标系"><a href="#坐标系" class="headerlink" title="坐标系"></a>坐标系</h2><ul><li>物体坐标系 <strong>ObjectSpace</strong></li><li>世界坐标系 <strong>WorldSpace</strong></li><li>视口坐标系 <strong>ViewportSpace</strong></li><li>屏幕坐标系 <strong>ScreenSpace</strong></li></ul><p>左手和右手坐标系</p><h3 id="MeshRender是如何渲染的"><a href="#MeshRender是如何渲染的" class="headerlink" title="MeshRender是如何渲染的"></a>MeshRender是如何渲染的</h3><p><a href="https://docs.unity3d.com/Manual/SL-UnityShaderVariables.html">Unity - Manual: Built-in shader variables (unity3d.com)</a></p><p>以立方体为例，Mesh Renderer 组件得到模型数据之后它会执行 vertex shader。vertex shader 里面做了下面这些事：</p><ol><li>先把立方体从模型的物体坐标系转换成世界坐标系，<strong>从 物体 到 世界</strong>。这样子，它和摄像机（世界坐标）的位置就用同一个坐标系描述了。</li><li>再把立方体从世界坐标转换成视口坐标系，也就是摄像机因为原点的坐标系，<strong>从 世界 到 视口</strong>。这样它是在摄像机的正面，还是在反面了。</li><li>最后在投射到屏幕坐标系上， <strong>从 视口 到 屏幕</strong>。这样知道哪些区域需要绘制在屏幕上，哪些不需要。</li></ol><p>总结上面一系列变换关系就是： <strong>物体 到 世界 再到 视口 再到 屏幕</strong>。中间经过了三次变换 (transform)。这些变换在数学上通过 <strong>矩阵</strong> 来描述的。</p><h2 id="颜色"><a href="#颜色" class="headerlink" title="颜色"></a>颜色</h2><p><a href="https://zhuanlan.zhihu.com/p/94081709">Photoshop图层混合模式详解 - 知乎 (zhihu.com)</a></p><h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><h3 id="平台差异"><a href="#平台差异" class="headerlink" title="平台差异"></a>平台差异</h3><ul><li>DX 和 Open GL 存在屏幕空间坐标差异。 DX中的屏幕坐标系原点在屏幕的左上角，而OpenGL中的屏幕坐标系原点在屏幕的左下角。</li></ul><h3 id="慎用分支语句"><a href="#慎用分支语句" class="headerlink" title="慎用分支语句"></a>慎用分支语句</h3><ul><li>if else 语句会导致分支预测，分支预测会导致性能下降 </li><li>if else 中使用的变量最好是常量 在编译时就能确定分支的走向</li><li>分支中的操作尽量简单，不要有复杂的计算</li><li>嵌套的分支语句会导致性能下降</li></ul><h3 id="不要除以0"><a href="#不要除以0" class="headerlink" title="不要除以0"></a>不要除以0</h3><ul><li>除以0不会报错</li></ul><h2 id="Shaderlab"><a href="#Shaderlab" class="headerlink" title="Shaderlab"></a>Shaderlab</h2><ul><li>Shader最精简的骨架</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs HLSL">Shader &quot;XXXXName&quot; &#123;<br><br>    Subshader &#123;<br><br>        Pass &#123; &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>通用的Shader模版，包含注释</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs HLSL">Shader &quot;#NAME#&quot;<br>&#123;<br>    /* Properties区域<br>     * <br>     * Shaderlab 提供的一种用于在Inspector中显示Shader属性的机制<br>     * 通过Properties区域定义的属性，可以在Inspector中显示，并且可以在Shader中使用<br>     * 支持的类型查看Unity文档 https://docs.unity3d.com/Manual/SL-Properties.html<br>     * <br>     * 如何定义<br>     * 属性名(&quot;Inspector显示名&quot;, 类型) = &quot;默认值&quot; &#123; &#125;<br>     * <br>     * 如何与HLSL关联 <br>     * 需要在HLSL中声明一个同名的变量，这样Unity会自动将Inspector中的属性值赋值给HLSL中的变量<br>     */<br><br>    Properties<br>    &#123;<br>        _BaseMap (&quot;Texture&quot;, 2D) = &quot;white&quot; &#123;&#125;// 主贴图<br>    &#125;<br>    /* SubShader是Shader的主要部分，包含了一系列的Pass<br>     * Pass是渲染管线的一个阶段，包含了一个顶点着色器和一个片元着色器<br>     * 可能存在多个SubShader，Unity会选择当前环境可用的第一个SubShader<br>     */<br>    SubShader<br>    &#123;<br>        /* Tag 是一个键值对，它的作用是告诉渲染引擎，应该 什么时候 怎么样 去渲染 <br>         * https://docs.unity.cn/cn/2022.3/Manual/SL-SubShaderTags.html<br>         */<br>        Tags<br>        &#123;<br>            &quot;RenderType&quot;=&quot;Opaque&quot;<br>            &quot;RenderPipeLine&quot;=&quot;UniversalRenderPipeline&quot; //用于指明使用URP来渲染<br>        &#125;<br>        /* 通用区域 这里内容可以在多个Pass中共享 */<br><br>        HLSLINCLUDE<br>        #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&quot;<br>        #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl&quot;<br>        #include &quot;Packages/com.unity.render-pipelines.core/ShaderLibrary/UnityInstancing.hlsl&quot;<br>        #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/DeclareDepthTexture.hlsl&quot;<br><br><br>        // 支持SRP Batcher<br>        CBUFFER_START(UnityPerMaterial)<br>            //声明变量<br>            float4 _BaseMap_ST;<br>        CBUFFER_END<br><br>        TEXTURE2D(_BaseMap); //贴图采样  <br>        SAMPLER(sampler_BaseMap);<br><br>        /* 渲染管线整个流水线都有数据的输入和输出<br>         * 这些数据是什么? 从哪里输入? 输出到哪里? Shader中的变量如何与这些数据交互?<br>         */<br><br>        /* 常用种类<br>         * POSITION: 顶点位置<br>         * NORMAL: 顶点法线<br>         * TANENT: 顶点切线<br>         * COLOR: 顶点颜色<br>         * TXECOORD0: 纹理坐标 UV0 -(UV是一张图 可以有多个通道 UV0表示第一个通道)<br>         * TEXCOORD1: 纹理坐标 UV1<br>         * TEXCOORD2: 纹理坐标 UV2<br>         * TEXCOORD3: 纹理坐标 UV3<br>         *<br>         *<br>         * 输入输出<br>         * 数据存放在寄存器中，输入从寄存器中读取，输出写入寄存器<br>         *<br>         *<br>         * Shader中的变量如何与这些数据交互<br>         * 语义绑定<br>         * void xxFunc(xxxType xxName : XXX) -(作函数参数标记)<br>         * xxxType xxFunc() : XXX -(作函数返回值标记)<br>         * struct xxStruct&#123; <br>         *   xxxType xxName : XXX; -(作结构体成员标记)<br>         * &#125;<br>         * 输入输出怎么表示<br>         * in -&gt; 输入<br>         * out -&gt; 输出<br>         * inout -&gt; 输入输出<br>         */<br><br>        // a2v -&gt; attribute to vertex<br>        struct a2v //顶点着色器<br>        &#123;<br>            float4 positionOS: POSITION;<br>            float3 normalOS: TANGENT;<br>            half4 vertexColor: COLOR;<br>            float2 uv : TEXCOORD0;<br>        &#125;;<br><br>        // v2f -&gt; vertex to fragment<br>        struct v2f //片元着色器<br>        &#123;<br>            float4 positionCS: SV_POSITION;<br>            float2 uv: TEXCOORD0;<br>            half4 vertexColor: COLOR;<br>        &#125;;<br>        ENDHLSL<br><br>        Pass<br>        &#123;<br>            // Pass的标签<br>            Tags &#123;&#125;<br>            HLSLPROGRAM<br><br>            // 编译指令 <br>            #pragma vertex vert // vertex shader 的函数 是 vert<br>            #pragma fragment frag // fragment shader 的函数 是 frag<br><br><br>            v2f vert(a2v v)<br>            &#123;<br>                v2f o;<br>                o.positionCS = TransformObjectToHClip(v.positionOS.xyz);<br>                o.uv = TRANSFORM_TEX(v.uv, _BaseMap);<br>                o.vertexColor = v.vertexColor;<br>                return o;<br>            &#125;<br><br>            half4 frag(v2f i) : SV_Target /* 注意在HLSL中，fixed4类型变成了half4类型*/<br>            &#123;<br>                half4 col = SAMPLE_TEXTURE2D(_BaseMap, sampler_BaseMap, i.uv);<br>                half res = lerp(i.vertexColor, col, i.vertexColor.g).x;<br>                return half4(res, res, res, 1.0);<br>            &#125;<br>            ENDHLSL<br>        &#125;<br>    &#125;<br><br>    /* Fallback是一个备用Shader，当当前Shader不支持时，会使用Fallback指定的Shader<br>     * 通常是Unity内置的Shader<br>     */<br>    Fallback &quot;Universal Render Pipeline/Unlit&quot;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="谁先被渲染"><a href="#谁先被渲染" class="headerlink" title="谁先被渲染"></a>谁先被渲染</h2><p>Subshader中的Tags选项用于告诉渲染引擎，什么时候，怎么样去渲染。</p><p>支持的Tag可以查阅Unity文档：<a href="https://docs.unity.cn/cn/2022.3/Manual/SL-SubShaderTags.html">ShaderLab：向子着色器分配标签 - Unity 手册</a></p><p>其中Queue是决定对象渲染顺序的标签，越小越先渲染，但是不能填数值，预先定义了5个词代替数值</p><ul><li><strong>Background：</strong> 对应数值为 1000，用于需要被最先渲染的对象，如背景什么的。</li><li><strong>Geometry：</strong> 对应数值为 2000, 用于不透明的物体。这个是默认的选项（如果不指明 Queue 标签的值，自动给你指定为 Geometry）。</li><li><strong>AlphaTest：</strong> 对应的数值为 2450, 用于需要使用 AlphaTest 的对象来提高性能。AlphaTest 类似于裁剪 (clip) 功能。</li><li><strong>Transparent：</strong> 对应的数值为 3000， 用于需要使用 alpha blending 的对象，比如粒子，玻璃等。</li><li><strong>Overlay：</strong> 对应的数值为 4000，用于最后被渲染的对象，比如 UI。</li></ul><p>虽然不能直接填数值，但是支持<strong>加减法</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs HLSL">Shader &quot;XXXName&quot; &#123;<br><br>    SubShader &#123;<br>        Tags &#123; &quot;Queue&quot; = &quot;Transparent&quot; &#125;<br><br>        Pass &#123;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Pargama指令"><a href="#Pargama指令" class="headerlink" title="Pargama指令"></a>Pargama指令</h2><p>用于告诉shaderlab编译器，应该这样这样，那样那样。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs HLSL">Shader &quot;XXXName&quot; &#123;<br><br>    Subshader &#123;<br><br>        pass &#123;<br>            // CGPROGRAM ... ENDCG 在 Pass 里面<br>            HLSLPROGRAM<br><br>            // vertex shader 的函数是 vert<br>            #pragma vertex vert<br><br>            // fragment shader 的函数是 fragment<br>            #pragma fragment frag<br><br>            void vert() &#123;<br><br>            &#125;<br><br>            void frag () &#123;<br><br>            &#125;<br><br>            ENDHLSL<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Property区域"><a href="#Property区域" class="headerlink" title="Property区域"></a>Property区域</h2><p>Shaderlab 提供的一种用于在Inspector中显示Shader属性的机制，通过Properties区域定义的属性，可以在Inspector中显示，并且可以在Sub Shader中使用。</p><ul><li><em>属性名(“Inspector显示名”, 类型) &#x3D; “默认值” { }</em></li></ul><p>支持的类型 <a href="https://docs.unity3d.com/Manual/SL-Properties.html">https://docs.unity3d.com/Manual/SL-Properties.html</a></p><p>需要在HLSL中声明一个同名的变量，这样Unity会自动将Inspector中的属性值赋值给HLSL中的变量</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">Shader</span> <span class="hljs-string">&quot;#NAME#&quot;</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-built_in">Properties</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-type">_BaseMap</span> <span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Texture&quot;</span><span class="hljs-operator">,</span> <span class="hljs-number">2</span><span class="hljs-built_in">D</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;white&quot;</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-operator">//</span> 主贴图<br>    <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-variable">SubShader</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-variable">Pass</span><br>        <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h2 id="语义绑定"><a href="#语义绑定" class="headerlink" title="语义绑定"></a>语义绑定</h2><p>渲染管线整个流水线都有数据的输入和输出，这些数据是什么? 从哪里输入? 输出到哪里? Shader中的变量如何与这些数据交互?</p><p><strong>常用种类?</strong></p><ul><li>POSITION: 顶点位置</li><li>NORMAL: 顶点法线</li><li>TANENT: 顶点切线</li><li>COLOR: 顶点颜色</li><li>TXECOORD0: 纹理坐标 UV0</li><li>TEXCOORD1: 纹理坐标 UV1</li><li>TEXCOORD2: 纹理坐标 UV2</li><li>TEXCOORD3: 纹理坐标 UV3</li></ul><p> <strong>输入输出?</strong></p><p> 数据存放在寄存器中，输入从寄存器中读取，输出写入寄存器</p><p> <strong>Shader中的变量如何与这些数据交互?</strong><br>语义绑定</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HLSL">void xxFunc(xxxType xxName : XXX) -(作函数参数标记)<br>  xxxType xxFunc() : XXX -(作函数返回值标记)<br>  struct xxStruct&#123; <br>   xxxType xxName : XXX; -(作结构体成员标记)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>输入输出怎么表示</strong></p><ul><li>in -&gt; 输入</li><li>out -&gt; 输出</li><li>inout -&gt; 输入输出</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs HLSL">Shader &quot;Custom/Shader10&quot; &#123;<br>    SubShader &#123;<br>        Tags &#123; &quot;RenderType&quot;=&quot;Opaque&quot; &#125;<br><br>        pass &#123;<br><br>            CGPROGRAM<br><br>            #pragma vertex vert<br>            #pragma fragment frag<br><br>            // 结构体中使用语义绑定<br>            struct VertexOutput &#123;<br>                float4 pos :SV_POSITION;   // 转换到投射空间后位置<br>                float4 texcoord :TEXCOORD0;// 顶点颜色<br>            &#125;;<br><br><br>            VertexOutput vert(in float4 pos :POSITION /*参数中使用语义绑定*/)<br>            &#123;<br>                VertexOutput output;<br>                output.pos = mul(UNITY_MATRIX_MVP, pos);<br>                output.texcoord = pos + float4(0.5, 0.5, 0.5, 0);<br>                return output;<br>                &#125;<br><br>            float4 frag(VertexOutput input) :COLOR // 函数后面使用语义绑定<br>            &#123;<br>                return input.texcoord;<br>            &#125;<br><br>            ENDCG<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="深度缓存"><a href="#深度缓存" class="headerlink" title="深度缓存"></a>深度缓存</h2><p><a href="https://docs.unity3d.com/Manual/shader-shaderlab-commands.html">Unity - Manual: ShaderLab: commands (unity3d.com)</a></p><p>FrameBuffer时用于存储帧位图的数据存储区域。深度缓存（Depth Buffer）也叫 Z-Buffer，这是用于存储深度数据的存储区。</p><ul><li>存储的深度数据是什么？</li><li>有什么用？</li></ul><p><strong>深度是什么？</strong></p><p>描述物体的位置，需要有参考系。深度值的参考系是观察者的视角 - 相机视角。在Vertex Shader之后有一个插值过程，用于生成像素，像素的XY坐标为屏幕坐标，Z坐标就是深度值，存储在深度缓存里面。</p><p><strong>有什么用？</strong></p><p>如果两个物体渲染后的像素的屏幕坐标XY相同，那么应该渲染谁？谁离更近就先渲染谁。</p><p>在Shaderlab中用 <strong>ZTest</strong>表示，有以下预设值，默认值是 LEqual ，意思是 渲染小于等于的那一个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HLSL">ZTest Less | Greater | LEqual | GEqual | Equal | NotEqual | Always<br></code></pre></td></tr></table></figure><p>如果两个像素的Z也相同呢？深度值一样的情况也叫做 <strong>深度冲突</strong> (Z-fighting)。解决方法是给其中某一个物体设置偏移量。 Shaderlab 中语法是:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HLSL">Offset Factor, Units<br></code></pre></td></tr></table></figure><p>Offset 根据一个插值公式来计算出新的深度值 <a href="https://learn.microsoft.com/zh-cn/windows/win32/opengl/glpolygonoffset?redirectedfrom=MSDN">glPolygonOffset 函数 (Gl.h) - Win32 apps | Microsoft Learn</a></p><p>也可以手动打开和关闭深度写入功能，在 Shaderlab 中用 ZWrite 来控制，它的语法是:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HLSL">ZWrite On | Off<br></code></pre></td></tr></table></figure><p><strong>在Unity渲染中的位置</strong></p><p>在顶点着色器之后，片元着色器之前</p><p><img src="https://wudixiaop.github.io/images/Shader/11/PipelineCullDepth.png" alt="PipelineCullDepth"></p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>图形学</tag>
      
      <tag>Shader</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>从BuildIn到URP</title>
    <link href="/2024/06/17/%E4%BB%8EBuildIn%E5%88%B0URP/"/>
    <url>/2024/06/17/%E4%BB%8EBuildIn%E5%88%B0URP/</url>
    
    <content type="html"><![CDATA[<h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p>首先要在SubShader的Tags中添加”RenderPipeline” &#x3D; “UniversalPipeline”，并且使用HLSL的宏代替旧版的CG语言宏。</p><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th></tr></thead><tbody><tr><td align="left">CGPROGRAM &#x2F; HLSLPROGRAM</td><td align="left">HLSLPROGRAM</td></tr><tr><td align="left">ENDCG &#x2F; ENDHLSL</td><td align="left">ENDHLSL</td></tr><tr><td align="left">CGINCLUDE &#x2F; HLSLINCLUDE</td><td align="left">HLSLINCLUDE</td></tr></tbody></table><h2 id="Include文件的改动"><a href="#Include文件的改动" class="headerlink" title="Include文件的改动"></a>Include文件的改动</h2><table><thead><tr><th align="left">Content</th><th align="left">Built-in</th><th align="left">URP</th></tr></thead><tbody><tr><td align="left">Core</td><td align="left">Unity.cginc</td><td align="left">Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl</td></tr><tr><td align="left">Light</td><td align="left">AutoLight.cginc</td><td align="left">Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl</td></tr><tr><td align="left">Shadows</td><td align="left">AutoLight.cginc</td><td align="left">Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Shadows.hlsl</td></tr><tr><td align="left">Surface shaders</td><td align="left">Lighting.cginc</td><td align="left">无</td></tr></tbody></table><p>其他常用的include文件:</p><ul><li>Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;SpaceTransforms.hlsl</li><li>Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;ShaderVariablesFunctions.hlsl</li><li>Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Common.hlsl</li><li>Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Input.hlsl</li><li>Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Color.hlsl</li><li>Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;DeclareDepthTexture.hlsl</li><li>Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;DeclareOpaqueTextue.hlsl</li></ul><h2 id="光照模式"><a href="#光照模式" class="headerlink" title="光照模式"></a>光照模式</h2><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th></tr></thead><tbody><tr><td align="left">ForwardBase</td><td align="left">UniversalForward</td></tr><tr><td align="left">ForwardAdd</td><td align="left">无</td></tr><tr><td align="left">Deferred and related</td><td align="left">UniversalGBuffer seems to have just been added to URP</td></tr><tr><td align="left">Vertex and related</td><td align="left">无</td></tr><tr><td align="left">ShadowCaster</td><td align="left">ShadowCaster</td></tr><tr><td align="left">MotionVectors</td><td align="left">暂不支持</td></tr></tbody></table><p>URP其他支持的光照模式：</p><ul><li>DepthOnly</li><li>Meta (用于烘焙光照贴图)</li><li>Universal2D</li></ul><h2 id="变体-Variants"><a href="#变体-Variants" class="headerlink" title="变体(Variants)"></a>变体(Variants)</h2><p>URP支持着色器的变体，可以使用#pragma multi_compile宏实现编译不同需求下的着色器，常见的内置关键字有：</p><ul><li>_MAIN_LIGHT_SHADOWS</li><li>_MAIN_LIGHT_SHADOWS_CASCADE</li><li>_ADDITIONAL_LIGHTS_VERTEX</li><li>_ADDITIONAL_LIGHTS</li><li>_ADDITIONAL_LIGHT_SHADOWS</li><li>_SHADOWS_SOFT</li><li>_MIXED_LIGHTING_SUBTRACTIVE</li></ul><h2 id="预定义的着色器预处理宏"><a href="#预定义的着色器预处理宏" class="headerlink" title="预定义的着色器预处理宏"></a>预定义的着色器预处理宏</h2><h3 id="辅助宏-Helpers"><a href="#辅助宏-Helpers" class="headerlink" title="辅助宏(Helpers)"></a>辅助宏(Helpers)</h3><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th></tr></thead><tbody><tr><td align="left">UNITY_PROJ_COORD(a)</td><td align="left">无，使用 a.xy&#x2F;a.w 来代替</td></tr><tr><td align="left">UNITY_INITIALIZE_OUTPUT(type, name)</td><td align="left">ZERO_INITIALIZE(type, name)</td></tr></tbody></table><h3 id="阴影贴图"><a href="#阴影贴图" class="headerlink" title="阴影贴图"></a>阴影贴图</h3><p>需要包含 Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Shadows.hlsl</p><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th></tr></thead><tbody><tr><td align="left">UNITY_DECLARE_SHADOWMAP(tex)</td><td align="left">TEXTURE2D_SHADOW_PARAM(textureName, samplerName)</td></tr><tr><td align="left">UNITY_SAMPLE_SHADOW(tex, uv)</td><td align="left">SAMPLE_TEXTURE2D_SHADOW(textureName, samplerName, coord3)</td></tr><tr><td align="left">UNITY_SAMPLE_SHADOW_PROJ(tex, uv)</td><td align="left">SAMPLE_TEXTURE2D_SHADOW(textureName, samplerName, coord4.xyz&#x2F;coord4.w)</td></tr></tbody></table><h3 id="纹理-采样器的声明宏"><a href="#纹理-采样器的声明宏" class="headerlink" title="纹理&#x2F;采样器的声明宏"></a>纹理&#x2F;采样器的声明宏</h3><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th></tr></thead><tbody><tr><td align="left">UNITY_DECLARE_TEX2D(name)</td><td align="left">TEXTURE2D(textureName); SAMPLER(samplerName);</td></tr><tr><td align="left">UNITY_DECLARE_TEX2D_NOSAMPLER(name)</td><td align="left">TEXTURE2D(textureName);</td></tr><tr><td align="left">UNITY_DECLARE_TEX2DARRAY(name)</td><td align="left">TEXTURE2D_ARRAY(textureName); SAMPLER(samplerName);</td></tr><tr><td align="left">UNITY_SAMPLE_TEX2D(name, uv)</td><td align="left">SAMPLE_TEXTURE2D(textureName, samplerName, coord2)</td></tr><tr><td align="left">UNITY_SAMPLE_TEX2D_SAMPLER(name, samplername, uv)</td><td align="left">SAMPLE_TEXTURE2D(textureName, samplerName, coord2)</td></tr><tr><td align="left">UNITY_SAMPLE_TEX2DARRAY(name, uv)</td><td align="left">SAMPLE_TEXTURE2D_ARRAY(textureName, samplerName, coord2, index)</td></tr><tr><td align="left">UNITY_SAMPLE_TEX2DARRAY_LOD(name, uv, lod)</td><td align="left">SAMPLE_TEXTURE2D_ARRAY_LOD(textureName, samplerName, coord2, index, lod)</td></tr></tbody></table><h2 id="内置的着色器辅助函数"><a href="#内置的着色器辅助函数" class="headerlink" title="内置的着色器辅助函数"></a>内置的着色器辅助函数</h2><p>可以在 Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;SpaceTransforms.hlsl 看到下方的所有函数</p><h3 id="顶点变换函数"><a href="#顶点变换函数" class="headerlink" title="顶点变换函数"></a>顶点变换函数</h3><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th></tr></thead><tbody><tr><td align="left">float4 UnityObjectToClipPos(float3 pos)</td><td align="left">float4 TransformObjectToHClip(float3 positionOS)</td></tr><tr><td align="left">float3 UnityObjectToViewPos(float3 pos)</td><td align="left">TransformWorldToView(TransformObjectToWorld(positionOS))</td></tr></tbody></table><h3 id="泛用的辅助函数"><a href="#泛用的辅助函数" class="headerlink" title="泛用的辅助函数"></a>泛用的辅助函数</h3><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th><th align="left">Include</th></tr></thead><tbody><tr><td align="left">float3 WorldSpaceViewDir (float4 v)</td><td align="left">float3 GetWorldSpaceViewDir(float3 positionWS)</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;ShaderVariablesFunctions.hlsl”</td></tr><tr><td align="left">float3 ObjSpaceViewDir (float4 v)</td><td align="left">无，使用 TransformWorldToObject(GetCameraPositionWS()) - objectSpacePosition;</td><td align="left"></td></tr><tr><td align="left">float2 ParallaxOffset (half h, half height, half3 viewDir)</td><td align="left">可能没有，从 UnityCG.cginc 复制</td><td align="left"></td></tr><tr><td align="left">fixed Luminance (fixed3 c)</td><td align="left">real Luminance(real3 linearRgb)</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Color.hlsl”</td></tr><tr><td align="left">fixed3 DecodeLightmap (fixed4 color)</td><td align="left">real3 DecodeLightmap(real4 encodedIlluminance, real4 decodeInstructions)</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;EntityLighting.hlsl” URP中decodeInstructions 为 half4(LIGHTMAP_HDR_MULTIPLIER, LIGHTMAP_HDR_EXPONENT, 0.0h, 0.0h)</td></tr><tr><td align="left">float4 EncodeFloatRGBA (float v)</td><td align="left">可能没有， 从 UnityCG.cginc 复制</td><td align="left"></td></tr><tr><td align="left">float DecodeFloatRGBA (float4 enc)</td><td align="left">可能没有， 从 UnityCG.cginc 复制</td><td align="left"></td></tr><tr><td align="left">float2 EncodeFloatRG (float v)</td><td align="left">可能没有， 从 UnityCG.cginc 复制</td><td align="left"></td></tr><tr><td align="left">float DecodeFloatRG (float2 enc)</td><td align="left">可能没有， 从 UnityCG.cginc 复制</td><td align="left"></td></tr><tr><td align="left">float2 EncodeViewNormalStereo (float3 n)</td><td align="left">可能没有， 从 UnityCG.cginc 复制</td><td align="left"></td></tr><tr><td align="left">float3 DecodeViewNormalStereo (float4 enc4)</td><td align="left">可能没有， 从 UnityCG.cginc 复制</td><td align="left"></td></tr></tbody></table><h3 id="前向渲染辅助函数"><a href="#前向渲染辅助函数" class="headerlink" title="前向渲染辅助函数"></a>前向渲染辅助函数</h3><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th><th align="left">Include</th></tr></thead><tbody><tr><td align="left">float3 WorldSpaceLightDir (float4 v)</td><td align="left">_MainLightPosition.xyz - TransformObjectToWorld(objectSpacePosition)</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Input.hlsl”</td></tr><tr><td align="left">float3 ObjSpaceLightDir (float4 v)</td><td align="left">TransformWorldToObject(_MainLightPosition.xyz) - objectSpacePosition</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Input.hlsl”</td></tr><tr><td align="left">float3 Shade4PointLights (…)</td><td align="left">无，可尝试用half3 VertexLighting(float3 positionWS, half3 normalWS)</td><td align="left">include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl”</td></tr></tbody></table><h3 id="屏幕空间辅助函数"><a href="#屏幕空间辅助函数" class="headerlink" title="屏幕空间辅助函数"></a>屏幕空间辅助函数</h3><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th><th align="left">Include</th></tr></thead><tbody><tr><td align="left">float4 ComputeScreenPos (float4 clipPos)</td><td align="left">float4 ComputeScreenPos(float4 positionCS)</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;ShaderVariablesFunctions.hlsl”</td></tr><tr><td align="left">float4 ComputeGrabScreenPos (float4 clipPos)</td><td align="left">无</td><td align="left"></td></tr></tbody></table><h3 id="顶点光照的辅助函数"><a href="#顶点光照的辅助函数" class="headerlink" title="顶点光照的辅助函数"></a>顶点光照的辅助函数</h3><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th><th align="left">Include</th></tr></thead><tbody><tr><td align="left">float3 ShadeVertexLights (float4 vertex, float3 normal)</td><td align="left">无，可尝试用 UNITY_LIGHTMODEL_AMBIENT.xyz + VertexLighting(…)</td><td align="left">include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl”</td></tr></tbody></table><p>可以在 Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Common.hlsl 中找到一些通用函数</p><h2 id="内置的着色器变量"><a href="#内置的着色器变量" class="headerlink" title="内置的着色器变量"></a>内置的着色器变量</h2><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th><th align="left">Include</th></tr></thead><tbody><tr><td align="left">_LightColor0</td><td align="left">_MainLightColor</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Input.hlsl”</td></tr><tr><td align="left">_WorldSpaceLightPos0</td><td align="left">_MainLightPosition</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Input.hlsl”</td></tr><tr><td align="left">_LightMatrix0</td><td align="left">可能还不支持</td><td align="left"></td></tr><tr><td align="left">unity_4LightPosX0, unity_4LightPosY0, unity_4LightPosZ0</td><td align="left">URP中，额外的灯光存储在一个数组或缓冲中(取决于平台),使用Light GetAdditionalLight(uint i, float3 positionWS)获取光照信息</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl”</td></tr><tr><td align="left">unity_4LightAtten0</td><td align="left">URP中，额外的灯光存储在一个数组或缓冲中(取决于平台),使用Light GetAdditionalLight(uint i, float3 positionWS)获取光照信息</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl”</td></tr><tr><td align="left">unity_LightColor</td><td align="left">URP中，额外的灯光存储在一个数组或缓冲中(取决于平台),使用Light GetAdditionalLight(uint i, float3 positionWS)获取光照信息</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl”</td></tr><tr><td align="left">unity_WorldToShadow</td><td align="left">float4x4 _MainLightWorldToShadow[MAX_SHADOW_CASCADES + 1] or _AdditionalLightsWorldToShadow[MAX_VISIBLE_LIGHTS]</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Shadows.hlsl”</td></tr></tbody></table><p>可以使用GetAdditionalLight(…)获取额外的光源，也可以使用GetAdditionalLightsCount()查询额外的光源数量。</p><h2 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h2><h3 id="阴影"><a href="#阴影" class="headerlink" title="阴影"></a>阴影</h3><p>更多阴影相关函数可以查看 Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Shadows.hlsl</p><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th></tr></thead><tbody><tr><td align="left">UNITY_SHADOW_COORDS(x)</td><td align="left">可能没有，可以写作float4 shadowCoord : TEXCOORD0;</td></tr><tr><td align="left">TRANSFER_SHADOW(a)</td><td align="left">a.shadowCoord &#x3D; TransformWorldToShadowCoord(worldSpacePosition)</td></tr><tr><td align="left">SHADOWS_SCREEN</td><td align="left">暂不支持</td></tr></tbody></table><h3 id="雾"><a href="#雾" class="headerlink" title="雾"></a>雾</h3><p>更多雾相关的函数可以查看 Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;ShaderVariablesFunctions.hlsl</p><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th></tr></thead><tbody><tr><td align="left">UNITY_FOG_COORDS(x)</td><td align="left">可能没有，可以写作float fogCoord : TEXCOORD0;</td></tr><tr><td align="left">UNITY_TRANSFER_FOG(o, outpos)</td><td align="left">o.fogCoord &#x3D; ComputeFogFactor(clipSpacePosition.z);</td></tr><tr><td align="left">UNITY_APPLY_FOG(coord, col)</td><td align="left">color &#x3D; MixFog(color, i.fogCoord);</td></tr></tbody></table><h3 id="深度"><a href="#深度" class="headerlink" title="深度"></a>深度</h3><p>可以包含 “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;DeclareDepthTexture.hlsl” 并使用 _CameraDepthTexture来调用深度纹理。也可以使用SampleSceneDepth(…) 和 LoadSceneDepth(…)。</p><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th><th align="left">Include</th></tr></thead><tbody><tr><td align="left">LinearEyeDepth(sceneZ)</td><td align="left">LinearEyeDepth(sceneZ, _ZBufferParams)</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Common.hlsl”</td></tr><tr><td align="left">Linear01Depth(sceneZ)</td><td align="left">Linear01Depth(sceneZ, _ZBufferParams)</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Common.hlsl”</td></tr></tbody></table><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><table><thead><tr><th align="left">Built-in</th><th align="left">URP</th><th align="left">Include</th></tr></thead><tbody><tr><td align="left">ShadeSH9(normal)</td><td align="left">SampleSH(normal)</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Lighting.hlsl”</td></tr><tr><td align="left">unity_ColorSpaceLuminance</td><td align="left">无，使用Luminance()</td><td align="left">Include “Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Color.hlsl”</td></tr></tbody></table><h2 id="后期-特效"><a href="#后期-特效" class="headerlink" title="后期&#x2F;特效"></a>后期&#x2F;特效</h2><p>URP不支持OnPreCull, OnPreRender, OnPostRender 和 OnRenderImage. 支持 OnRenderObject 和 OnWillRenderObject。RenderPipelineManager提供了渲染管线中注入的位置：</p><ul><li>beginCameraRendering(ScriptableRenderContext context, Camera camera)</li><li>endCameraRendering(ScriptableRenderContext context, Camera camera)</li><li>beginFrameRendering(ScriptableRenderContext context,Camera[] cameras)</li><li>endFrameRendering(ScriptableRenderContext context,Camera[] cameras)</li></ul><p>例如：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnEnable</span>()</span><br>&#123;<br>RenderPipelineManager.beginCameraRendering += MyCameraRendering;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnDisable</span>()</span><br>&#123;<br>RenderPipelineManager.beginCameraRendering -= MyCameraRendering;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">MyCameraRendering</span>(<span class="hljs-params">ScriptableRenderContext context, Camera camera</span>)</span><br>&#123;<br>...<br><span class="hljs-keyword">if</span>(camera == myEffectCamera)<br>&#123;<br>...<br>        UniversalRenderPipeline.RenderSingleCamera(context, camera);<br>&#125;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>另外，可以创建ScriptableRendererFeature来实现后期处理效果。可以在管线的不同阶段注入ScriptableRenderPasses：</p><ul><li>BeforeRendering</li><li>BeforeRenderingShadows</li><li>AfterRenderingShadows</li><li>BeforeRenderingPrepasses</li><li>AfterRenderingPrePasses</li><li>BeforeRenderingOpaques</li><li>AfterRenderingOpaques</li><li>BeforeRenderingSkybox</li><li>AfterRenderingSkybox</li><li>BeforeRenderingTransparents</li><li>AfterRenderingTransparents</li><li>BeforeRenderingPostProcessing</li><li>AfterRenderingPostProcessing</li><li>AfterRendering</li></ul><p>下面是一个示例：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomRenderPassFeature</span> : <span class="hljs-title">ScriptableRendererFeature</span><br>&#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">CustomRenderPass</span> : <span class="hljs-title">ScriptableRenderPass</span><br>    &#123;<br>        CustomRPSettings _CustomRPSettings;<br>        RenderTargetHandle _TemporaryColorTexture;<br><br>        <span class="hljs-keyword">private</span> RenderTargetIdentifier _Source;<br>        <span class="hljs-keyword">private</span> RenderTargetHandle _Destination;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomRenderPass</span>(<span class="hljs-params">CustomRPSettings settings</span>)</span><br>        &#123;<br>            _CustomRPSettings = settings;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Setup</span>(<span class="hljs-params">RenderTargetIdentifier source, RenderTargetHandle destination</span>)</span><br>        &#123;<br>            _Source = source;<br>            _Destination = destination;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">CommandBuffer cmd, RenderTextureDescriptor cameraTextureDescriptor</span>)</span><br>        &#123;<br>            _TemporaryColorTexture.Init(<span class="hljs-string">&quot;_TemporaryColorTexture&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Execute</span>(<span class="hljs-params">ScriptableRenderContext context, <span class="hljs-keyword">ref</span> RenderingData renderingData</span>)</span><br>        &#123;<br>            CommandBuffer cmd = CommandBufferPool.Get(<span class="hljs-string">&quot;My Pass&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> (_Destination == RenderTargetHandle.CameraTarget)<br>            &#123;<br>                cmd.GetTemporaryRT(_TemporaryColorTexture.id, renderingData.cameraData.cameraTargetDescriptor, FilterMode.Point);<br>                cmd.Blit(_Source, _TemporaryColorTexture.Identifier());<br>                cmd.Blit(_TemporaryColorTexture.Identifier(), _Source, _CustomRPSettings.m_Material);<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                cmd.Blit(_Source, _Destination.Identifier(), _CustomRPSettings.m_Material, <span class="hljs-number">0</span>);<br>            &#125;<br><br>            context.ExecuteCommandBuffer(cmd);<br>            CommandBufferPool.Release(cmd);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FrameCleanup</span>(<span class="hljs-params">CommandBuffer cmd</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_Destination == RenderTargetHandle.CameraTarget)<br>            &#123;<br>                cmd.ReleaseTemporaryRT(_TemporaryColorTexture.id);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    [<span class="hljs-meta">System.Serializable</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomRPSettings</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> Material m_Material;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> CustomRPSettings m_CustomRPSettings = <span class="hljs-keyword">new</span> CustomRPSettings();<br>    CustomRenderPass _ScriptablePass;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Create</span>()</span><br>    &#123;<br>        _ScriptablePass = <span class="hljs-keyword">new</span> CustomRenderPass(m_CustomRPSettings);<br><br>        _ScriptablePass.renderPassEvent = RenderPassEvent.AfterRenderingOpaques;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddRenderPasses</span>(<span class="hljs-params">ScriptableRenderer renderer, <span class="hljs-keyword">ref</span> RenderingData renderingData</span>)</span><br>    &#123;<br>        _ScriptablePass.Setup(renderer.cameraColorTarget, RenderTargetHandle.CameraTarget);<br>        renderer.EnqueuePass(_ScriptablePass);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>C#</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Singleton</title>
    <link href="/2024/06/17/%E5%8D%95%E4%BE%8B/"/>
    <url>/2024/06/17/%E5%8D%95%E4%BE%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="LazySingleton"><a href="#LazySingleton" class="headerlink" title="LazySingleton"></a>LazySingleton</h2><p>C#中通用的一种懒加载单例模式实现</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">UnityToolkit</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LazySingleton</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">IDisposable</span> <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">new</span>()<br>    &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> Lazy&lt;T&gt; s_instance = <span class="hljs-keyword">new</span> Lazy&lt;T&gt;(() =&gt;<br>        &#123;<br>            T t = <span class="hljs-keyword">new</span> T();<br>            <span class="hljs-keyword">if</span> (t <span class="hljs-keyword">is</span> IOnInit <span class="hljs-keyword">init</span>)<br>            &#123;<br>                <span class="hljs-keyword">init</span>.OnInit();<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> t;<br>        &#125;);<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T Singleton =&gt; s_instance.Value;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (Singleton <span class="hljs-keyword">is</span> IDisposable disposable)<br>            &#123;<br>                disposable.Dispose();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Mono-Singleton"><a href="#Mono-Singleton" class="headerlink" title="Mono Singleton"></a>Mono Singleton</h2><p>Unity下基于MonoBehavior和泛型的单例模式</p><ul><li>基于泛型实现</li><li>自动清理静态变量，UnityEditor 下可开启选项<code>播放时不重新加载程序集</code>。</li><li>支持场景和全局单例</li><li>支持自动创建</li></ul><figure class="highlight csharp"><figcaption><span>MonoSingleton.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">UnityToolkit</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IOnlyPlayingModelSingleton</span><br>    &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IAutoCreateSingleton</span><br>    &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MonoSingleton</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">MonoBehaviour</span> <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">MonoSingleton</span>&lt;<span class="hljs-title">T</span>&gt;<br>    &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> T _singleton;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">DontDestroyOnLoad</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T SingletonNullable =&gt; _singleton;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T Singleton<br>        &#123;<br>            <span class="hljs-keyword">get</span><br>            &#123;<br>                <span class="hljs-comment">// 如果T是仅在播放模式下的单例</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(IOnlyPlayingModelSingleton).IsAssignableFrom(<span class="hljs-keyword">typeof</span>(T)))<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (Application.isPlaying == <span class="hljs-literal">false</span>)<br>                    &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                    &#125;<br>                &#125;<br><br><br>                <span class="hljs-keyword">if</span> (_singleton != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> _singleton; <span class="hljs-comment">//第一次访问</span><br>                _singleton = FindObjectOfType&lt;T&gt;(); <span class="hljs-comment">// 从场景中查找</span><br>                <span class="hljs-keyword">if</span> (_singleton != <span class="hljs-literal">null</span>)<br>                &#123;<br>                    _singleton.OnSingletonInit(); <span class="hljs-comment">//手动初始化</span><br>                    <span class="hljs-keyword">return</span> _singleton;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(IAutoCreateSingleton).IsAssignableFrom(<span class="hljs-keyword">typeof</span>(T)))<br>                &#123;<br>                    GameObject go = <span class="hljs-keyword">new</span> GameObject(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;<span class="hljs-keyword">typeof</span>(T).Name&#125;</span>&quot;</span>);<br>                    _singleton = go.AddComponent&lt;T&gt;();<br>                    _singleton.OnSingletonInit();<br>                    <span class="hljs-keyword">return</span> _singleton;<br>                &#125;<br><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullReferenceException(<span class="hljs-string">$&quot;Singleton&lt;<span class="hljs-subst">&#123;<span class="hljs-keyword">typeof</span>(T).Name&#125;</span>&gt;.Singleton -&gt; <span class="hljs-subst">&#123;<span class="hljs-keyword">typeof</span>(T).Name&#125;</span> is null&quot;</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnSingletonInit</span>()</span><br>        &#123;<br>            <span class="hljs-comment">// Debug.Log($&quot;Singleton&lt;&#123;typeof(T).Name&#125;&gt;.OnInit() -&gt; &#123;gameObject.name&#125;&quot;);</span><br>            transform.SetParent(<span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">if</span> (DontDestroyOnLoad())<br>            &#123;<br>                DontDestroyOnLoad(gameObject);<br>            &#125;<br><br>            OnInit();<br>        &#125;<br><br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>        &#123;<br>            <span class="hljs-comment">//Awake时如果还没有被访问 则将自己赋值给_singleton</span><br>            <span class="hljs-keyword">if</span> (_singleton == <span class="hljs-literal">null</span>)<br>            &#123;<br>                _singleton = <span class="hljs-keyword">this</span> <span class="hljs-keyword">as</span> T;<br>                <span class="hljs-comment">// Debug.Log($&quot;Singleton&lt;&#123;typeof(T).Name&#125;&gt;.Awake() -&gt; &#123;gameObject.name&#125;&quot;);</span><br>                _singleton.OnSingletonInit();<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">//如果已经被访问过 则销毁自己</span><br>            <span class="hljs-keyword">if</span> (_singleton != <span class="hljs-keyword">this</span>)<br>            &#123;<br>                Destroy(gameObject);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnInit</span>()</span><br>        &#123;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDispose</span>()</span><br>        &#123;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDestroy</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_singleton == <span class="hljs-keyword">this</span>)<br>            &#123;<br>                _singleton.OnDispose();<br>                _singleton = <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br><br><br>        <span class="hljs-comment">// Unity 2022 后 生命周期变更 OnApplicationQuit -&gt; OnDisable -&gt; OnDestroy</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnApplicationQuit</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_singleton == <span class="hljs-keyword">this</span>)<br>            &#123;<br>                _singleton.OnDispose();<br>                _singleton = <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> UNITY_EDITOR</span><br><br>        [<span class="hljs-meta">RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.BeforeSplashScreen)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ResetStatic</span>()</span><br>        &#123;<br>            _singleton = <span class="hljs-literal">null</span>;<br>        &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>C#</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
