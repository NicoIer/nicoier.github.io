

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/nicoier.png">
  <link rel="icon" href="/img/nicoier.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="NicoIer">
  <meta name="keywords" content="">
  
    <meta name="description" content="1本文记录了在使用Animancer时开发动画网络同步的一些经验和解决方案。  Animancer简介https:&#x2F;&#x2F;kybernetik.com.au&#x2F;animancer&#x2F; Animancer是Unity中的一个强大的动画管理插件，提供了比传统Animator更灵活和高效的动画控制方式。它允许开发者通过代码直接控制动画状态机，简化了动画的管理和切换。 了解Transition和Animancer">
<meta property="og:type" content="article">
<meta property="og:title" content="NetworkAnimancer">
<meta property="og:url" content="https://nicoier.github.io/2025/12/02/NetworkAnimancer/index.html">
<meta property="og:site_name" content="NicoIer">
<meta property="og:description" content="1本文记录了在使用Animancer时开发动画网络同步的一些经验和解决方案。  Animancer简介https:&#x2F;&#x2F;kybernetik.com.au&#x2F;animancer&#x2F; Animancer是Unity中的一个强大的动画管理插件，提供了比传统Animator更灵活和高效的动画控制方式。它允许开发者通过代码直接控制动画状态机，简化了动画的管理和切换。 了解Transition和Animancer">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://nicoier.github.io/img/runtime_animancer.png">
<meta property="og:image" content="https://nicoier.github.io/img/animancer_transition_types.png">
<meta property="og:image" content="https://nicoier.github.io/img/animancer_state_types.png">
<meta property="og:image" content="https://nicoier.github.io/img/animancer_transition_library.png">
<meta property="article:published_time" content="2025-12-02T05:27:08.000Z">
<meta property="article:modified_time" content="2025-12-02T06:25:34.107Z">
<meta property="article:author" content="NicoIer">
<meta property="article:tag" content="Unity">
<meta property="article:tag" content="Animation">
<meta property="article:tag" content="Animancer">
<meta property="article:tag" content="Networking">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://nicoier.github.io/img/runtime_animancer.png">
  
  
  
  <title>NetworkAnimancer - NicoIer</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"nicoier.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>NicoIer&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="NetworkAnimancer"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-12-02 13:27" pubdate>
          2025年12月2日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          1.8k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          15 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">NetworkAnimancer</h1>
            
            
              <div class="markdown-body">
                
                <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">本文记录了在使用Animancer时开发动画网络同步的一些经验和解决方案。<br></code></pre></td></tr></table></figure>

<h1 id="Animancer简介"><a href="#Animancer简介" class="headerlink" title="Animancer简介"></a>Animancer简介</h1><p><a target="_blank" rel="noopener" href="https://kybernetik.com.au/animancer/">https://kybernetik.com.au/animancer/</a></p>
<p>Animancer是Unity中的一个强大的动画管理插件，提供了比传统Animator更灵活和高效的动画控制方式。它允许开发者通过代码直接控制动画状态机，简化了动画的管理和切换。</p>
<h2 id="了解Transition和AnimancerState"><a href="#了解Transition和AnimancerState" class="headerlink" title="了解Transition和AnimancerState"></a>了解Transition和AnimancerState</h2><p>这是一个典型的运行时Animancer</p>
<p><img src="/../img/runtime_animancer.png" srcset="/img/loading.gif" lazyload alt="runtime_animancer.png"></p>
<h3 id="Transition"><a href="#Transition" class="headerlink" title="Transition"></a>Transition</h3><p>Animacner中，动画不是按照AnimationClip为资源单位播放，而是按照Transition为资源单位播放的</p>
<p>Transition有很多类型，比如ClipTransition，LinearMixTransition，PlayableTransition等等。</p>
<ul>
<li>ClipTransition: 最简单的Transition，直接封装了一个AnimationClip，可以设置淡入淡出时间，速度等参数</li>
<li>LinearMixTransition: 用于混合多个AnimationClip，适合需要平滑过渡的动画场景</li>
<li>PlayableTransition: 更高级的Transition，可以自定义PlayableGraph，实现复杂的动画逻辑</li>
<li>….</li>
</ul>
<p><img src="/../img/animancer_transition_types.png" srcset="/img/loading.gif" lazyload alt="animancer_transition_types.png"></p>
<h2 id="AnimancerState"><a href="#AnimancerState" class="headerlink" title="AnimancerState"></a>AnimancerState</h2><p>AnimancerState是Animancer中表示动画播放状态的类。每个Transition在播放时都会生成一个对应的AnimancerState。不同类型的Transition会生成不同类型的AnimancerState，比如ClipTransition会生成ClipState，<br><img src="/../img/animancer_state_types.png" srcset="/img/loading.gif" lazyload alt="animancer_state_types.png"></p>
<h2 id="AnimancerLayer"><a href="#AnimancerLayer" class="headerlink" title="AnimancerLayer"></a>AnimancerLayer</h2><p>AnimancerLayer是Animancer中用于管理动画层的类。</p>
<p>类似于Unity Animator中的Layer概念</p>
<p>每个AnimancerLayer可以包含多个AnimancerState，允许在同一层上播放多个动画，并通过权重进行混合。</p>
<h1 id="Animancer网络同步"><a href="#Animancer网络同步" class="headerlink" title="Animancer网络同步"></a>Animancer网络同步</h1><p>首先明确三个问题</p>
<ol>
<li>我们需要序列化什么</li>
<li>如何序列化</li>
<li>如何反序列化</li>
</ol>
<h2 id="需要序列化什么？"><a href="#需要序列化什么？" class="headerlink" title="需要序列化什么？"></a>需要序列化什么？</h2><h3 id="AnimancerLayer-1"><a href="#AnimancerLayer-1" class="headerlink" title="AnimancerLayer"></a>AnimancerLayer</h3><ul>
<li>Layer的索引 （用于反序列化时定位Layer）</li>
<li>包括Layer的权重 （用于反序列化时还原Layer的权重）</li>
<li>当前播放的所有AnimancerState的信息</li>
</ul>
<h3 id="AnimancerState-1"><a href="#AnimancerState-1" class="headerlink" title="AnimancerState"></a>AnimancerState</h3><ul>
<li>Transition的信息 （用于反序列化时还原AnimancerState）</li>
<li>当前播放时间 （用于反序列化时还原播放进度）</li>
<li>权重 （用于反序列化时还原权重）</li>
<li>播放速度 （用于反序列化时还原播放速度）</li>
<li>过渡信息 （用于反序列化时还原过渡状态）</li>
</ul>
<h2 id="如何序列化？"><a href="#如何序列化？" class="headerlink" title="如何序列化？"></a>如何序列化？</h2><p>一个完整的Animacner网络同步数据结构应该包含多个AnimancerLayer，每个Layer包含多个AnimancerState。</p>
<h3 id="序列化AnimancerState"><a href="#序列化AnimancerState" class="headerlink" title="序列化AnimancerState"></a>序列化AnimancerState</h3><p>已知，不同的Transition会生成不同类型的AnimancerState，因此在序列化时需要区分不同类型的State。</p>
<ul>
<li>首先定义一个枚举类型StateType，用于区分不同类型的AnimancerState</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> StateType<br>&#123;<br>    Clip,<br>    DirectionalMixer,<br>    CartesianMixer,<br>    LinearMixer<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>上面定义了最常用四种类型</p>
<ul>
<li>Clip表示普通的ClipState</li>
<li>DirectionalMixer表示方向混合状态</li>
<li>CartesianMixer表示笛卡尔混合状态</li>
<li>LinearMixer表示线性混合状态</li>
</ul>
</li>
<li><p>使用一个ArraySegment<byte>来存储额外的payload数据，用于存储不同类型State特有的数据</p>
</li>
<li><p>定义NetworkAnimationStateData结构体来表示序列化后的AnimancerState数据</p>
</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">MemoryPackable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> NetworkAnimationStateData<br>&#123;<br>    <span class="hljs-keyword">public</span> StateType stateType;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> stateHash;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> transitionIndex;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> speed;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> time;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> weight;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> remainimgFadeDuration;<br>    <span class="hljs-keyword">public</span> ArraySegment&lt;<span class="hljs-built_in">byte</span>&gt; payload;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>结构体字段说明：<ul>
<li>stateType: 状态类型</li>
<li>stateHash: 状态的哈希值，用于唯一标识状态</li>
<li>transitionIndex : Transition的索引，用于反序列化时还原Transition (仅对ClipState有效)</li>
<li>speed: 播放速度</li>
<li>time: 当前播放时间</li>
<li>weight: 权重</li>
<li>remainimgFadeDuration: 剩余淡出时间</li>
<li>payload: 额外的payload数据</li>
</ul>
</li>
</ul>
<h4 id="准备Transition索引映射"><a href="#准备Transition索引映射" class="headerlink" title="准备Transition索引映射"></a>准备Transition索引映射</h4><p>需要有一个地方存储Transition到索引的映射关系</p>
<p>这里之所以可以使用AnimationClip和ClipTransition作为索引单元，是因为我们提前将所有的AnimationClip都生成了ClipTransition，并且存放到了Animacner的TransitionLibrary中。</p>
<p><img src="/../img/animancer_transition_library.png" srcset="/img/loading.gif" lazyload alt="animancer_transition_library.png"></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Dictionary&lt;AnimationClip, ClipTransition&gt; _clip2TransitionsDict = <span class="hljs-keyword">new</span> ();<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Dictionary&lt;ClipTransition, <span class="hljs-built_in">int</span>&gt; _transition2IndexDict = <span class="hljs-keyword">new</span> ();<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; animancer.Transitions.Definition.Transitions.Length; i++)<br>&#123;<br>    <span class="hljs-keyword">var</span> assetBase = animancer.Transitions.Definition.Transitions[i];<br>    <span class="hljs-keyword">if</span> (assetBase <span class="hljs-keyword">is</span> TransitionAsset &#123; Transition: ClipTransition clipTransition &#125;)<br>    &#123;<br>        _clip2TransitionsDict[clipTransition.Clip] = clipTransition;<br>        _transition2IndexDict[clipTransition] = animancer.Transitions.Library.IndexOf(clipTransition);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ClipState"><a href="#ClipState" class="headerlink" title="ClipState"></a>ClipState</h4><p>对于ClipState，payload可以为空，因为ClipState不需要额外的数据。</p>
<p>对应的序列化代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp">AnimancerState state = layer.ActiveStates[i];<br><span class="hljs-keyword">var</span> stateData = <span class="hljs-keyword">new</span> NetworkAnimationStateData<br>&#123;<br>    stateType = NetworkAnimationStateData.StateType.Clip,<br>    stateHash = state.Index,<br>    time = state.Time,<br>    weight = state.Weight,<br>    speed = state.Speed<br>&#125;;<br><br><span class="hljs-keyword">if</span> (state.FadeGroup != <span class="hljs-literal">null</span> &amp;&amp; Mathf.Approximately(state.TargetWeight, <span class="hljs-number">1</span>))<br>&#123;<br>    stateData.remainimgFadeDuration = state.FadeGroup.RemainingFadeDuration;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中寻找Transition索引的代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">stateData.transitionIndex = _transition2IndexDict[_clip2TransitionsDict[state.Clip]];<br></code></pre></td></tr></table></figure>

<p>为了方便，如果存在正在过渡的状态，我们直接将过渡的目标状态放到Layer的State列表中的第一个</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">if</span>(thisStateIsInFade)<br>&#123; <br>    (networkAnimationDatas[<span class="hljs-number">0</span>], networkAnimationDatas[i]) =  (networkAnimationDatas[i], networkAnimationDatas[<span class="hljs-number">0</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="DirectionalMixerState"><a href="#DirectionalMixerState" class="headerlink" title="DirectionalMixerState"></a>DirectionalMixerState</h4><p>对于DirectionalMixerState，需要序列化当前方向参数，所有的子状态的Transition索引，以及每个子状态对应的阈值。</p>
<p>对应的额外payload数据结构如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">MemoryPackable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> DirectionalMixerStateData<br>&#123;<br>    <span class="hljs-keyword">public</span> Vector2 parameter;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>[] transitionIndices;<br>    <span class="hljs-keyword">public</span> Vector2[] thresholds;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对应的序列化代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp">stateData.stateType = NetworkAnimationStateData.StateType.DirectionalMixer;<br><span class="hljs-keyword">var</span> payload = <span class="hljs-keyword">new</span> DirectionalMixerStateData();<br>payload.parameter = directionalMixerState.Parameter;<br>payload.transitionIndices = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[directionalMixerState.ChildCount];<br>payload.thresholds = <span class="hljs-keyword">new</span> Vector2[directionalMixerState.ChildCount];<br><br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>; index &lt; directionalMixerState.ChildCount; index++)<br>&#123;<br>    <span class="hljs-keyword">var</span> child = directionalMixerState.GetChild(index);<br>    <span class="hljs-keyword">var</span> transitionIndex = _transition2IndexDict[_clip2TransitionsDict[child.Clip]];<br>    payload.transitionIndices[index] = transitionIndex;<br>    payload.thresholds[index] = directionalMixerState.GetThreshold(index);<br>&#125;<br>stateData.payload = MemoryPackSerializer.Serialize(payload);<br></code></pre></td></tr></table></figure>

<h4 id="CartesianMixerState"><a href="#CartesianMixerState" class="headerlink" title="CartesianMixerState"></a>CartesianMixerState</h4><p>CartesianMixerState的序列化方式和DirectionalMixerState类似，并没有什么不同</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">MemoryPackable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> CartesianMixerStateData<br>&#123;<br>    <span class="hljs-keyword">public</span> Vector2 parameter;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>[] transitionIndices;<br>    <span class="hljs-keyword">public</span> Vector2[] thresholds;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp">stateData.stateType = NetworkAnimationStateData.StateType.DirectionalMixer;<br><span class="hljs-keyword">var</span> payload = <span class="hljs-keyword">new</span> DirectionalMixerStateData();<br>payload.parameter = directionalMixerState.Parameter;<br>payload.transitionIndices = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[directionalMixerState.ChildCount];<br>payload.thresholds = <span class="hljs-keyword">new</span> Vector2[directionalMixerState.ChildCount];<br><br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>; index &lt; directionalMixerState.ChildCount; index++)<br>&#123;<br>    <span class="hljs-keyword">var</span> child = directionalMixerState.GetChild(index); <br>    <span class="hljs-keyword">var</span> transitionIndex = _transition2IndexDict[_clip2TransitionsDict[child.Clip]];<br>    payload.transitionIndices[index] = transitionIndex;<br>    payload.thresholds[index] = directionalMixerState.GetThreshold(index);<br>&#125;<br><br>stateData.payload = MemoryPackSerializer.Serialize(payload);<br></code></pre></td></tr></table></figure>

<h4 id="LinearMixerState"><a href="#LinearMixerState" class="headerlink" title="LinearMixerState"></a>LinearMixerState</h4><p>Linear和Directional&#x2F;Cartesian的区别在于，LinearMixerState参数和阈值是float类型</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">MemoryPackable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> LinearMixerStateData<br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> parameter;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>[] transitionIndices;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span>[] thresholds;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp">stateData.stateType = NetworkAnimationStateData.StateType.LinearMixer;<br><span class="hljs-keyword">var</span> payload = <span class="hljs-keyword">new</span> LinearMixerStateData();<br>payload.parameter = linearMixerState.Parameter;<br>payload.transitionIndices = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[linearMixerState.ChildCount];<br>payload.thresholds = <span class="hljs-keyword">new</span> <span class="hljs-built_in">float</span>[linearMixerState.ChildCount]; <br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>; index &lt; linearMixerState.ChildCount; index++)<br>&#123;<br>    <span class="hljs-keyword">var</span> child = linearMixerState.GetChild(index); <br>    <span class="hljs-keyword">var</span> transitionIndex = _transition2IndexDict[_clip2TransitionsDict[child.Clip]]; <br>    payload.transitionIndices[index] = transitionIndex;<br>    payload.thresholds[index] = linearMixerState.GetThreshold(index);<br>&#125;<br><br>stateData.payload = MemoryPackSerializer.Serialize(payload);<br></code></pre></td></tr></table></figure>

<h3 id="序列化AnimancerLayer"><a href="#序列化AnimancerLayer" class="headerlink" title="序列化AnimancerLayer"></a>序列化AnimancerLayer</h3><p>定义NetworkAnimationLayerData结构体来表示序列化后的AnimancerLayer数据</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">MemoryPackable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">struct</span> NetworkAnimationLayerData<br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> layerIndex;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> layerWeight;<br>    <span class="hljs-keyword">public</span> ArraySegment&lt;NetworkAnimationStateData&gt; states;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Layer的序列化相对简单，只需要记录Layer的索引，权重，以及包含的所有AnimancerState的序列化数据即可。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">var</span> layer = animancer.Layers[layerIndex];<br><span class="hljs-keyword">var</span> layerData = <span class="hljs-keyword">new</span> NetworkAnimationLayerData<br>&#123;<br>    layerIndex = layerIndex,<br>    layerWeight = layer.Weight <br>&#125;;<br><span class="hljs-keyword">var</span> networkAnimationDatas = <span class="hljs-keyword">new</span> NetworkAnimationStateData[layer.ActiveStates.Count];<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; layer.ActiveStates.Count; i++)<br>&#123;<br>    <span class="hljs-keyword">var</span> state = layer.ActiveStates[i];<br>    <span class="hljs-comment">// 序列化state的代码，参考上面的内容</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="如何反序列化？"><a href="#如何反序列化？" class="headerlink" title="如何反序列化？"></a>如何反序列化？</h2><p>反序列化要做的事情主要有两件，创建AnimancerState，以及还原AnimancerState的播放状态。</p>
<p>在初始化的时候，就已经创建好了所有的Layer，所以不需要同步的创建Layer</p>
<h3 id="反序列化AnimancerLayer"><a href="#反序列化AnimancerLayer" class="headerlink" title="反序列化AnimancerLayer"></a>反序列化AnimancerLayer</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">var</span> layerData = dataList[layerIndex];<br><span class="hljs-keyword">var</span> layer = animancer.Layers[layerData.layerIndex];<br>layer.Stop();<br><span class="hljs-keyword">if</span> (layerData.layerWeight == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">if</span> (layerData.states.Count == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;<br>layer.Weight = layerData.layerWeight;<br><br>AnimancerState first;<br><br><span class="hljs-comment">// 反序列化每个AnimancerState</span><br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; layerData.states.Count; i++)<br>&#123;<br>    <span class="hljs-comment">// 反序列化state的代码，参考下面的内容</span><br>&#125;<br><br>layer.Play(firstState, layerData.states[<span class="hljs-number">0</span>].remainimgFadeDuration);<br></code></pre></td></tr></table></figure>

<h3 id="反序列化AnimancerState"><a href="#反序列化AnimancerState" class="headerlink" title="反序列化AnimancerState"></a>反序列化AnimancerState</h3><p>首先需要一个Dict记录所有已经创建的AnimancerState，避免重复创建</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">private</span> Dictionary&lt;<span class="hljs-built_in">int</span>, AnimancerState&gt; id2State = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">int</span>, AnimancerState&gt;();<br></code></pre></td></tr></table></figure>

<p>同样的，需要对不同的AnimancerState类型进行区分处理</p>
<h4 id="ClipState-1"><a href="#ClipState-1" class="headerlink" title="ClipState"></a>ClipState</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">var</span> stateData = layerData.states[i];<br>AnimancerState state = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (stateData.stateType == NetworkAnimationStateData.StateType.Clip)<br>&#123;<br>    <span class="hljs-keyword">if</span> (!id2State.TryGetValue(stateData.stateHash, <span class="hljs-keyword">out</span> state))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (!animancer.Graph.Transitions.TryGetTransition(stateData.transitionIndex,<br>            <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> transitionModifierGroup))<br>        &#123;<br>            Debug.LogError(<br>                <span class="hljs-string">$&quot;Transition index <span class="hljs-subst">&#123;stateData.transitionIndex&#125;</span> not found in Animancer Graph.&quot;</span>);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        state = layer.GetOrCreateState(transitionModifierGroup.Transition);<br>        id2State[stateData.stateHash] = state;<br>    &#125;<br>&#125;<br><br>state.Speed = stateData.speed;<br>state.Time = stateData.time;<br>state.Weight = stateData.weight;<br></code></pre></td></tr></table></figure>

<h4 id="CartesianMixer"><a href="#CartesianMixer" class="headerlink" title="CartesianMixer"></a>CartesianMixer</h4><p>主要是创建的时候需要反序列化payload数据，然后根据payload数据创建CartesianMixerState</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs csharp">DirectionalMixerState mixerState;<br><span class="hljs-keyword">var</span> parmData = MemoryPackSerializer.Deserialize&lt;DirectionalMixerStateData&gt;(stateData.payload);<br><span class="hljs-keyword">if</span> (!id2State.TryGetValue(stateData.stateHash, <span class="hljs-keyword">out</span> state))<br>&#123;<br>    mixerState = <span class="hljs-keyword">new</span> DirectionalMixerState();<br>    state = mixerState;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>; index &lt; parmData.transitionIndices.Length; index++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (!animancer.Graph.Transitions.TryGetTransition(parmData.transitionIndices[index],<br>            <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> transitionModifierGroup))<br>        &#123;<br>            Debug.LogError(<br>                <span class="hljs-string">$&quot;Transition index <span class="hljs-subst">&#123;parmData.transitionIndices[index]&#125;</span> not found in Animancer Graph.&quot;</span>);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        mixerState.Add(<br>            transitionModifierGroup.Transition,<br>            parmData.thresholds[index]);<br>    &#125;<br><br>    id2State[stateData.stateHash] = state;<br>&#125;<br><br>mixerState = state <span class="hljs-keyword">as</span> DirectionalMixerState;<br><span class="hljs-keyword">if</span> (mixerState == <span class="hljs-literal">null</span>)<br>&#123;<br>    Debug.LogError(<span class="hljs-string">$&quot;State hash <span class="hljs-subst">&#123;stateData.stateHash&#125;</span> is not DirectionalMixerState.&quot;</span>);<br>    <span class="hljs-keyword">continue</span>;<br>&#125;<br><br>mixerState.Parameter = parmData.parameter;<br></code></pre></td></tr></table></figure>


<h4 id="DirectionalMixer"><a href="#DirectionalMixer" class="headerlink" title="DirectionalMixer"></a>DirectionalMixer</h4><p>….. 内容和CartesianMixer类似，不再赘述</p>
<h4 id="LinearMixer"><a href="#LinearMixer" class="headerlink" title="LinearMixer"></a>LinearMixer</h4><p>….. 内容和CartesianMixer类似，不再赘述</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Unity/" class="print-no-link">#Unity</a>
      
        <a href="/tags/Animation/" class="print-no-link">#Animation</a>
      
        <a href="/tags/Animancer/" class="print-no-link">#Animancer</a>
      
        <a href="/tags/Networking/" class="print-no-link">#Networking</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>NetworkAnimancer</div>
      <div>https://nicoier.github.io/2025/12/02/NetworkAnimancer/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>NicoIer</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年12月2日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/12/08/Unity6%E7%9A%84MeshLOD%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/" title="Unity6的MeshLOD使用教程">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Unity6的MeshLOD使用教程</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/19/%E5%A6%82%E4%BD%95%E8%AE%A9Shader%E6%94%AF%E6%8C%81DOTS/" title="如何让Shader支持DOTS">
                        <span class="hidden-mobile">如何让Shader支持DOTS</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
      
<i class="iconfont icon-love"></i> <a href="https://github.com/nicoier" target="_blank" rel="nofollow noopener"><span>Nicoier</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
